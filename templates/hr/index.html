{% extends "base.html" %}

{% block title %}{{ 'HR AI Engine' if lang == 'en' else 'محرك الموارد البشرية الذكي' }} - Mcidia{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<style>
* { box-sizing: border-box; }

/* HR Wrapper */
.hr-wrapper {
    display: flex;
    min-height: calc(100vh - 100px);
    background: linear-gradient(135deg, #f8fafb 0%, #eef2f7 100%);
}

/* Sidebar - Professional Design */
.hr-sidebar {
    width: 280px;
    background: linear-gradient(135deg, #0f3460 0%, #16213e 50%, #0f3460 100%);
    color: white;
    padding: 0;
    position: sticky;
    top: 70px;
    height: calc(100vh - 70px);
    overflow-y: auto;
    box-shadow: 0 8px 32px rgba(15, 52, 96, 0.2);
    border-right: 1px solid rgba(255,255,255,0.1);
}

.hr-sidebar-header {
    padding: 30px 20px;
    background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
}

.hr-sidebar-header h4 {
    margin: 0 0 8px 0;
    font-size: 19px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.hr-sidebar-header small {
    opacity: 0.85;
    font-size: 12px;
    font-weight: 500;
}

.hr-nav-section {
    padding: 20px 0;
    border-top: 1px solid rgba(255,255,255,0.05);
}

.hr-nav-section:first-of-type {
    padding-top: 10px;
    border-top: none;
}

.hr-nav-section-title {
    padding: 12px 20px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    opacity: 0.6;
    font-weight: 700;
    color: rgba(255,255,255,0.7);
}

.hr-nav-item {
    padding: 14px 20px;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0.0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 14px;
    border-left: 3px solid transparent;
    color: rgba(255,255,255,0.85);
    text-decoration: none;
    font-weight: 500;
    position: relative;
    overflow: hidden;
}

.hr-nav-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(180deg, #00d4ff, #0099cc);
    opacity: 0;
    transition: opacity 0.25s;
}

.hr-nav-item:hover {
    background: rgba(255,255,255,0.08);
    color: white;
    padding-left: 24px;
    transform: translateX(2px);
}

.hr-nav-item:hover::before {
    opacity: 1;
}

.hr-nav-item.active {
    background: linear-gradient(90deg, rgba(0,212,255,0.1), rgba(0,212,255,0.05));
    color: #00d4ff;
    font-weight: 600;
}

.hr-nav-item.active::before {
    opacity: 1;
}

.hr-nav-item i {
    width: 20px;
    text-align: center;
    font-size: 16px;
    transition: transform 0.25s;
}

.hr-nav-item:hover i {
    transform: scale(1.1);
}

.hr-nav-badge {
    margin-left: auto;
    background: linear-gradient(135deg, #00d4ff, #0099cc);
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(0,212,255,0.3);
}

.hr-content {
    flex: 1;
    padding: 40px;
    background: linear-gradient(135deg, #f8fafb 0%, #eef2f7 100%);
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(0,0,0,0.1) transparent;
}

.hr-section {
    display: none;
    animation: slideInUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.hr-section.active {
    display: block;
}

@keyframes slideInUp {
    from { 
        opacity: 0; 
        transform: translateY(20px);
    }
    to { 
        opacity: 1; 
        transform: translateY(0);
    }
}

/* RTL Support */
[dir="rtl"] .hr-sidebar {
    box-shadow: 0 8px 32px rgba(15, 52, 96, 0.2);
    border-right: none;
    border-left: 1px solid rgba(255,255,255,0.1);
}

[dir="rtl"] .hr-nav-item {
    border-left: none;
    border-right: 3px solid transparent;
}

[dir="rtl"] .hr-nav-item::before {
    left: auto;
    right: 0;
}

[dir="rtl"] .hr-nav-item:hover {
    padding-left: 20px;
    padding-right: 24px;
    transform: translateX(-2px);
}

[dir="rtl"] .hr-nav-badge {
    margin-left: 0;
    margin-right: auto;
}

/* KPI Cards - Premium Design */
.kpi-card {
    background: linear-gradient(135deg, white 0%, #fafbfc 100%);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 1px solid rgba(0,0,0,0.05);
    border-left: 4px solid;
    position: relative;
    overflow: hidden;
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100px;
    height: 100px;
    background: radial-gradient(circle, rgba(255,255,255,0.5) 0%, transparent 70%);
    transition: all 0.35s;
}

.kpi-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 16px 48px rgba(0,0,0,0.12);
    border-color: inherit;
}

.kpi-card:hover::before {
    top: -20%;
    right: -20%;
}

.kpi-icon {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 26px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.08);
    position: relative;
    z-index: 1;
}

.kpi-value {
    font-size: 32px;
    font-weight: 800;
    margin: 12px 0 6px 0;
    letter-spacing: -0.5px;
    position: relative;
    z-index: 1;
}

.kpi-label {
    font-size: 13px;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    z-index: 1;
}

.kpi-change {
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 700;
    margin-top: 8px;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    z-index: 1;
}

/* Welcome Cards */
.welcome-card {
    background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
    border-radius: 20px;
    padding: 32px;
    box-shadow: 0 10px 32px rgba(0,0,0,0.08);
    transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 1.5px solid rgba(0,0,0,0.04);
    height: 100%;
    position: relative;
    overflow: hidden;
}

.welcome-card::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 150px;
    height: 150px;
    background: radial-gradient(circle, rgba(59,130,246,0.1) 0%, transparent 70%);
    border-radius: 50%;
}

.welcome-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 20px 48px rgba(59,130,246,0.15);
    transform: translateY(-8px);
}

.welcome-card-icon {
    width: 80px;
    height: 80px;
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    margin-bottom: 20px;
    position: relative;
    z-index: 1;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

/* Data Table */
.data-table {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 32px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.05);
}

.data-table thead {
    background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
    color: white;
    position: relative;
}

.data-table thead th {
    padding: 18px 20px;
    font-weight: 700;
    border: none;
    font-size: 13px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.data-table tbody td {
    padding: 16px 20px;
    vertical-align: middle;
    font-weight: 500;
}

.data-table tbody tr {
    border-bottom: 1px solid #f0f1f3;
    transition: all 0.25s;
}

.data-table tbody tr:hover {
    background: linear-gradient(90deg, rgba(59,130,246,0.05), transparent);
}

/* Progress Steps */
.progress-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 40px 0;
    position: relative;
}

.progress-steps::before {
    content: '';
    position: absolute;
    top: 25px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #e5e7eb 0%, #d1d5db 50%, #e5e7eb 100%);
    z-index: 0;
}

.progress-step {
    text-align: center;
    position: relative;
    z-index: 1;
    flex: 1;
}

.progress-step-circle {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: white;
    border: 3px solid #e5e7eb;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    margin-bottom: 12px;
    transition: all 0.35s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    font-size: 18px;
}

.progress-step.active .progress-step-circle {
    background: linear-gradient(135deg, #0f3460, #16213e);
    border-color: transparent;
    color: white;
    box-shadow: 0 8px 24px rgba(15,52,96,0.3);
    transform: scale(1.1);
}

.progress-step.completed .progress-step-circle {
    background: linear-gradient(135deg, #10b981, #059669);
    border-color: transparent;
    color: white;
    box-shadow: 0 8px 24px rgba(16,185,129,0.3);
}

.progress-step small {
    font-weight: 600;
    font-size: 12px;
    color: #4b5563;
}

/* Avatar Circle */
.avatar-circle {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* Processing Animation */
.processing-animation {
    text-align: center;
    padding: 80px 20px;
    background: linear-gradient(135deg, rgba(15,52,96,0.02) 0%, rgba(255,255,255,0.5) 100%);
    border-radius: 20px;
}

.processing-spinner {
    width: 100px;
    height: 100px;
    border: 6px solid rgba(0,0,0,0.08);
    border-top-color: #0f3460;
    border-radius: 50%;
    animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
    margin: 0 auto 30px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.processing-steps {
    max-width: 500px;
    margin: 0 auto;
    text-align: left;
}

.processing-step {
    padding: 14px 0;
    opacity: 0.4;
    transition: all 0.35s;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 12px;
}

.processing-step.active {
    opacity: 1;
    font-weight: 700;
    color: #0f3460;
}

.processing-step i {
    color: #10b981;
    font-size: 18px;
}

/* Responsive */
@media (max-width: 992px) {
    .hr-wrapper {
        flex-direction: column;
    }
    
    .hr-sidebar {
        width: 100%;
        position: relative;
        height: auto;
        top: 0;
    }
    
    .hr-content {
        padding: 24px;
    }
}

/* Card Styles */
.card {
    border: 1px solid rgba(0,0,0,0.05) !important;
    box-shadow: 0 8px 24px rgba(0,0,0,0.06) !important;
    border-radius: 16px !important;
}

.card-header {
    background: linear-gradient(135deg, #f8fafb 0%, #eef2f7 100%) !important;
    border-bottom: 1px solid rgba(0,0,0,0.05) !important;
    border-radius: 16px 16px 0 0 !important;
}

.btn-primary {
    background: linear-gradient(135deg, #0f3460 0%, #16213e 100%) !important;
    border: none !important;
    box-shadow: 0 4px 12px rgba(15,52,96,0.3) !important;
    transition: all 0.25s !important;
}

.btn-primary:hover {
    box-shadow: 0 8px 24px rgba(15,52,96,0.4) !important;
    transform: translateY(-2px) !important;
}

/* Scrollbar */
.hr-content::-webkit-scrollbar,
.table-responsive::-webkit-scrollbar {
    width: 8px;
}

.hr-content::-webkit-scrollbar-track,
.table-responsive::-webkit-scrollbar-track {
    background: transparent;
}

.hr-content::-webkit-scrollbar-thumb,
.table-responsive::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.1);
    border-radius: 4px;
}

.hr-content::-webkit-scrollbar-thumb:hover,
.table-responsive::-webkit-scrollbar-thumb:hover {
    background: rgba(0,0,0,0.2);
}
</style>
{% endblock %}

{% block content %}
<div class="hr-wrapper">
    <!-- Sidebar Navigation -->
    <div class="hr-sidebar">
        <div class="hr-sidebar-header">
            <h4><i class="fas fa-brain me-2"></i>{{ 'HR Intelligence' if lang == 'en' else 'ذكاء الموارد البشرية' }}</h4>
            <small>{{ 'AI-Powered Analytics' if lang == 'en' else 'التحليلات الذكية' }}</small>
        </div>

        <!-- Navigation Items -->
        <div class="hr-nav-section">
            <div class="hr-nav-section-title">{{ 'MAIN' if lang == 'en' else 'الرئيسية' }}</div>
            <a class="hr-nav-item active" onclick="showSection('home')">
                <i class="fas fa-home"></i>
                <span>{{ 'Home' if lang == 'en' else 'الرئيسية' }}</span>
            </a>
            <a class="hr-nav-item" onclick="showSection('dashboard')">
                <i class="fas fa-chart-line"></i>
                <span>{{ 'Dashboard' if lang == 'en' else 'لوحة القيادة' }}</span>
            </a>
        </div>

        <div class="hr-nav-section">
            <div class="hr-nav-section-title">{{ 'DATA MANAGEMENT' if lang == 'en' else 'إدارة البيانات' }}</div>
            <a class="hr-nav-item" onclick="showSection('import')">
                <i class="fas fa-file-import"></i>
                <span>{{ 'Data Import' if lang == 'en' else 'استيراد البيانات' }}</span>
            </a>
            <a class="hr-nav-item" onclick="showSection('employees')">
                <i class="fas fa-users"></i>
                <span>{{ 'Employees' if lang == 'en' else 'الموظفون' }}</span>
                <span class="hr-nav-badge" id="employees-count">0</span>
            </a>
        </div>

        <div class="hr-nav-section">
            <div class="hr-nav-section-title">{{ 'ANALYTICS' if lang == 'en' else 'التحليلات' }}</div>
            <a class="hr-nav-item" onclick="showSection('performance')">
                <i class="fas fa-star"></i>
                <span>{{ 'Performance' if lang == 'en' else 'الأداء' }}</span>
            </a>
            <a class="hr-nav-item" onclick="showSection('attendance')">
                <i class="fas fa-calendar-check"></i>
                <span>{{ 'Attendance' if lang == 'en' else 'الحضور' }}</span>
            </a>
            <a class="hr-nav-item" onclick="showSection('payroll')">
                <i class="fas fa-money-bill-wave"></i>
                <span>{{ 'Payroll' if lang == 'en' else 'الرواتب' }}</span>
            </a>
            <a class="hr-nav-item" onclick="showSection('resignations')">
                <i class="fas fa-user-minus"></i>
                <span>{{ 'Resignations' if lang == 'en' else 'الاستقالات' }}</span>
            </a>
        </div>

        <div class="hr-nav-section">
            <div class="hr-nav-section-title">{{ 'AI FEATURES' if lang == 'en' else 'الذكاء الاصطناعي' }}</div>
            <a class="hr-nav-item" onclick="showSection('recommendations')">
                <i class="fas fa-lightbulb"></i>
                <span>{{ 'AI Recommendations' if lang == 'en' else 'التوصيات الذكية' }}</span>
            </a>
            <a class="hr-nav-item" onclick="showSection('turnover')">
                <i class="fas fa-exclamation-triangle"></i>
                <span>{{ 'Turnover Prediction' if lang == 'en' else 'توقع الاستقالات' }}</span>
            </a>
        </div>

        <div class="hr-nav-section">
            <div class="hr-nav-section-title">{{ 'SETTINGS' if lang == 'en' else 'الإعدادات' }}</div>
            <a class="hr-nav-item" onclick="showSection('settings')">
                <i class="fas fa-cog"></i>
                <span>{{ 'Settings' if lang == 'en' else 'الإعدادات' }}</span>
            </a>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="hr-content">
        <!-- Section 1: Home -->
        <div id="section-home" class="hr-section active">
            <div class="mb-4">
                <h2 class="fw-bold mb-2">
                    {{ 'Welcome to HR Intelligence' if lang == 'en' else 'مرحباً بك في ذكاء الموارد البشرية' }}
                </h2>
                <p class="text-muted">
                    {{ 'AI-powered analytics for better HR decisions' if lang == 'en' else 'التحليلات الذكية لقرارات أفضل في الموارد البشرية' }}
                </p>
            </div>

            <div class="row g-4 mb-4">
                <!-- Card 1: HR Data Overview -->
                <div class="col-md-4">
                    <div class="welcome-card">
                        <div class="welcome-card-icon bg-primary-subtle">
                            <i class="fas fa-database text-primary"></i>
                        </div>
                        <h5 class="fw-bold mb-3">{{ 'HR Data Overview' if lang == 'en' else 'نظرة عامة على البيانات' }}</h5>
                        <p class="text-muted mb-3" style="font-size: 14px;">
                            {{ 'View your current data status and import new files' if lang == 'en' else 'عرض حالة بياناتك الحالية واستيراد ملفات جديدة' }}
                        </p>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">{{ 'Files Uploaded' if lang == 'en' else 'الملفات المرفوعة' }}</small>
                                <span class="badge bg-success" id="home-files-count">0/5</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="home-files-progress"></div>
                            </div>
                        </div>
                        <button class="btn btn-primary w-100" onclick="showSection('import')">
                            <i class="fas fa-upload me-2"></i>
                            {{ 'Import Data Now' if lang == 'en' else 'استيراد البيانات الآن' }}
                        </button>
                    </div>
                </div>

                <!-- Card 2: AI Insights Summary -->
                <div class="col-md-4">
                    <div class="welcome-card">
                        <div class="welcome-card-icon bg-success-subtle">
                            <i class="fas fa-brain text-success"></i>
                        </div>
                        <h5 class="fw-bold mb-3">{{ 'AI Insights Summary' if lang == 'en' else 'ملخص الذكاء الاصطناعي' }}</h5>
                        <div id="ai-insights-content">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>{{ 'Upload employee data to start AI analysis' if lang == 'en' else 'قم برفع بيانات الموظفين لبدء التحليل الذكي' }}</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card 3: Quick Actions -->
                <div class="col-md-4">
                    <div class="welcome-card">
                        <div class="welcome-card-icon bg-warning-subtle">
                            <i class="fas fa-bolt text-warning"></i>
                        </div>
                        <h5 class="fw-bold mb-3">{{ 'Quick Actions' if lang == 'en' else 'إجراءات سريعة' }}</h5>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="showSection('import')">
                                <i class="fas fa-file-csv me-2"></i>{{ 'Import CSV' if lang == 'en' else 'استيراد CSV' }}
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="alert('Coming soon!')">
                                <i class="fas fa-plug me-2"></i>{{ 'Connect ERP' if lang == 'en' else 'ربط ERP' }}
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="downloadTemplate()">
                                <i class="fas fa-download me-2"></i>{{ 'Download Template' if lang == 'en' else 'تحميل القالب' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h6 class="mb-0 fw-bold"><i class="fas fa-clock me-2 text-primary"></i>{{ 'Recent Activity' if lang == 'en' else 'النشاطات الأخيرة' }}</h6>
                </div>
                <div class="card-body">
                    <div id="recent-activity-list">
                        <p class="text-muted text-center py-4">
                            <i class="fas fa-inbox fa-2x mb-3 d-block text-muted opacity-25"></i>
                            {{ 'No recent activity' if lang == 'en' else 'لا توجد نشاطات حديثة' }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Data Import Wizard -->
        <div id="section-import" class="hr-section">
            <div class="mb-4">
                <button class="btn btn-outline-secondary btn-sm mb-3" onclick="showSection('home')">
                    <i class="fas fa-arrow-{{ 'right' if lang == 'ar' else 'left' }} me-2"></i>{{ 'Back' if lang == 'en' else 'رجوع' }}
                </button>
                <h2 class="fw-bold mb-2">{{ 'Data Import Wizard' if lang == 'en' else 'معالج استيراد البيانات' }}</h2>
                <p class="text-muted">{{ 'Import your HR data in 3 easy steps' if lang == 'en' else 'استورد بيانات الموارد البشرية في 3 خطوات بسيطة' }}</p>
            </div>

            <!-- Progress Steps -->
            <div class="progress-steps mb-4">
                <div class="progress-step active" id="step-indicator-1">
                    <div class="progress-step-circle">1</div>
                    <div class="small fw-semibold">{{ 'Import Type' if lang == 'en' else 'نوع الاستيراد' }}</div>
                </div>
                <div class="progress-step" id="step-indicator-2">
                    <div class="progress-step-circle">2</div>
                    <div class="small fw-semibold">{{ 'Upload Files' if lang == 'en' else 'رفع الملفات' }}</div>
                </div>
                <div class="progress-step" id="step-indicator-3">
                    <div class="progress-step-circle">3</div>
                    <div class="small fw-semibold">{{ 'Column Mapping' if lang == 'en' else 'مطابقة الأعمدة' }}</div>
                </div>
            </div>

            <!-- Step 1: Import Type Selection -->
            <div id="import-step-1" class="import-step">
                <h5 class="fw-bold mb-4">{{ 'Select Import Method' if lang == 'en' else 'اختر طريقة الاستيراد' }}</h5>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="welcome-card text-center" onclick="selectImportType('csv')" style="cursor: pointer;">
                            <div class="welcome-card-icon bg-primary-subtle mx-auto">
                                <i class="fas fa-file-csv text-primary"></i>
                            </div>
                            <h6 class="fw-bold">{{ 'CSV / Excel Files' if lang == 'en' else 'ملفات CSV / Excel' }}</h6>
                            <small class="text-muted">{{ 'Upload files from your computer' if lang == 'en' else 'رفع الملفات من جهازك' }}</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="welcome-card text-center" onclick="alert('Coming soon!')" style="cursor: pointer; opacity: 0.6;">
                            <div class="welcome-card-icon bg-success-subtle mx-auto">
                                <i class="fas fa-plug text-success"></i>
                            </div>
                            <h6 class="fw-bold">{{ 'ERP API Connection' if lang == 'en' else 'ربط نظام ERP' }}</h6>
                            <small class="text-muted">{{ 'Connect via API integration' if lang == 'en' else 'الربط عبر API' }}</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="welcome-card text-center" onclick="alert('Coming soon!')" style="cursor: pointer; opacity: 0.6;">
                            <div class="welcome-card-icon bg-warning-subtle mx-auto">
                                <i class="fas fa-database text-warning"></i>
                            </div>
                            <h6 class="fw-bold">{{ 'External Database' if lang == 'en' else 'قاعدة بيانات خارجية' }}</h6>
                            <small class="text-muted">{{ 'Connect to external database' if lang == 'en' else 'الربط بقاعدة بيانات' }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: File Upload -->
            <div id="import-step-2" class="import-step" style="display: none;">
                <h5 class="fw-bold mb-4">{{ 'Upload HR Files' if lang == 'en' else 'رفع ملفات الموارد البشرية' }}</h5>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>{{ 'File Type' if lang == 'en' else 'نوع الملف' }}</th>
                                <th>{{ 'Description' if lang == 'en' else 'الوصف' }}</th>
                                <th class="text-center">{{ 'Status' if lang == 'en' else 'الحالة' }}</th>
                                <th class="text-center">{{ 'Action' if lang == 'en' else 'الإجراء' }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="file-row-employees">
                                <td><i class="fas fa-users text-primary me-2"></i><strong>employees.csv</strong></td>
                                <td><small class="text-muted">{{ 'Employee master data' if lang == 'en' else 'بيانات الموظفين الأساسية' }}</small></td>
                                <td class="text-center">
                                    <span class="badge bg-secondary file-status">{{ 'Not Uploaded' if lang == 'en' else 'غير مرفوع' }}</span>
                                </td>
                                <td class="text-center">
                                    <input type="file" id="file-employees" accept=".csv,.xlsx" style="display:none" onchange="handleFileUpload(this, 'employees')">
                                    <button class="btn btn-sm btn-primary" onclick="document.getElementById('file-employees').click()">
                                        <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                    </button>
                                </td>
                            </tr>
                            <tr id="file-row-attendance">
                                <td><i class="fas fa-calendar-check text-success me-2"></i><strong>attendance.csv</strong></td>
                                <td><small class="text-muted">{{ 'Attendance records' if lang == 'en' else 'سجلات الحضور' }}</small></td>
                                <td class="text-center">
                                    <span class="badge bg-secondary file-status">{{ 'Not Uploaded' if lang == 'en' else 'غير مرفوع' }}</span>
                                </td>
                                <td class="text-center">
                                    <input type="file" id="file-attendance" accept=".csv,.xlsx" style="display:none" onchange="handleFileUpload(this, 'attendance')">
                                    <button class="btn btn-sm btn-primary" onclick="document.getElementById('file-attendance').click()">
                                        <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                    </button>
                                </td>
                            </tr>
                            <tr id="file-row-performance">
                                <td><i class="fas fa-star text-warning me-2"></i><strong>performance.csv</strong></td>
                                <td><small class="text-muted">{{ 'Performance reviews' if lang == 'en' else 'تقييمات الأداء' }}</small></td>
                                <td class="text-center">
                                    <span class="badge bg-secondary file-status">{{ 'Not Uploaded' if lang == 'en' else 'غير مرفوع' }}</span>
                                </td>
                                <td class="text-center">
                                    <input type="file" id="file-performance" accept=".csv,.xlsx" style="display:none" onchange="handleFileUpload(this, 'performance')">
                                    <button class="btn btn-sm btn-primary" onclick="document.getElementById('file-performance').click()">
                                        <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                    </button>
                                </td>
                            </tr>
                            <tr id="file-row-payroll">
                                <td><i class="fas fa-money-bill-wave text-info me-2"></i><strong>payroll.csv</strong></td>
                                <td><small class="text-muted">{{ 'Payroll data' if lang == 'en' else 'بيانات الرواتب' }}</small></td>
                                <td class="text-center">
                                    <span class="badge bg-secondary file-status">{{ 'Not Uploaded' if lang == 'en' else 'غير مرفوع' }}</span>
                                </td>
                                <td class="text-center">
                                    <input type="file" id="file-payroll" accept=".csv,.xlsx" style="display:none" onchange="handleFileUpload(this, 'payroll')">
                                    <button class="btn btn-sm btn-primary" onclick="document.getElementById('file-payroll').click()">
                                        <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                    </button>
                                </td>
                            </tr>
                            <tr id="file-row-resignations">
                                <td><i class="fas fa-user-minus text-danger me-2"></i><strong>resignations.csv</strong></td>
                                <td><small class="text-muted">{{ 'Resignation records' if lang == 'en' else 'سجلات الاستقالات' }}</small></td>
                                <td class="text-center">
                                    <span class="badge bg-secondary file-status">{{ 'Not Uploaded' if lang == 'en' else 'غير مرفوع' }}</span>
                                </td>
                                <td class="text-center">
                                    <input type="file" id="file-resignations" accept=".csv,.xlsx" style="display:none" onchange="handleFileUpload(this, 'resignations')">
                                    <button class="btn btn-sm btn-primary" onclick="document.getElementById('file-resignations').click()">
                                        <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-outline-secondary" onclick="goToImportStep(1)">
                        <i class="fas fa-arrow-{{ 'right' if lang == 'ar' else 'left' }} me-2"></i>{{ 'Previous' if lang == 'en' else 'السابق' }}
                    </button>
                    <button class="btn btn-success" onclick="processAllFiles()">
                        {{ 'Process & Analyze' if lang == 'en' else 'معالجة وتحليل' }}<i class="fas fa-arrow-{{ 'left' if lang == 'ar' else 'right' }} ms-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Column Mapping (will be shown in modal) -->
            <div id="import-step-3" class="import-step" style="display: none;">
                <!-- This will be handled by modal -->
            </div>
        </div>

        <!-- Section 3: Processing Screen -->
        <div id="section-processing" class="hr-section">
            <div class="processing-animation">
                <div class="processing-spinner"></div>
                <h4 class="fw-bold mb-4">{{ 'Processing Your Data...' if lang == 'en' else 'جاري معالجة البيانات...' }}</h4>
                <div class="processing-steps">
                    <div class="processing-step active">
                        <i class="fas fa-check-circle"></i>
                        <span>{{ 'Cleaning data...' if lang == 'en' else 'تنظيف البيانات...' }}</span>
                    </div>
                    <div class="processing-step">
                        <i class="fas fa-circle-notch fa-spin"></i>
                        <span>{{ 'Analyzing performance...' if lang == 'en' else 'تحليل الأداء...' }}</span>
                    </div>
                    <div class="processing-step">
                        <i class="fas fa-circle-notch"></i>
                        <span>{{ 'Calculating turnover risks...' if lang == 'en' else 'حساب احتمالات الاستقالة...' }}</span>
                    </div>
                    <div class="processing-step">
                        <i class="fas fa-circle-notch"></i>
                        <span>{{ 'Building payroll profile...' if lang == 'en' else 'بناء ملف الرواتب...' }}</span>
                    </div>
                    <div class="processing-step">
                        <i class="fas fa-circle-notch"></i>
                        <span>{{ 'Analyzing behavior patterns...' if lang == 'en' else 'تحليل السلوك...' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 4: Dashboard -->
        <div id="section-dashboard" class="hr-section">
            <div class="mb-4">
                <h2 class="fw-bold mb-2">{{ 'HR Dashboard' if lang == 'en' else 'لوحة القيادة' }}</h2>
                <p class="text-muted">{{ 'Complete overview of your HR metrics' if lang == 'en' else 'نظرة شاملة على مؤشرات الموارد البشرية' }}</p>
            </div>

            <!-- KPIs -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="kpi-card" style="border-left-color: #3b82f6;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="flex-grow-1">
                                <div class="kpi-label">{{ 'Total Employees' if lang == 'en' else 'إجمالي الموظفين' }}</div>
                                <div class="kpi-value" id="kpi-total-employees">0</div>
                                <span class="kpi-change bg-success-subtle text-success">+5% {{ 'this month' if lang == 'en' else 'هذا الشهر' }}</span>
                            </div>
                            <div class="kpi-icon bg-primary-subtle text-primary">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card" style="border-left-color: #10b981;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="flex-grow-1">
                                <div class="kpi-label">{{ 'Avg Performance' if lang == 'en' else 'متوسط الأداء' }}</div>
                                <div class="kpi-value" id="kpi-avg-performance">0%</div>
                                <span class="kpi-change bg-success-subtle text-success">+2.5%</span>
                            </div>
                            <div class="kpi-icon bg-success-subtle text-success">
                                <i class="fas fa-star"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card" style="border-left-color: #f59e0b;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="flex-grow-1">
                                <div class="kpi-label">{{ 'Turnover Rate' if lang == 'en' else 'معدل الاستقالات' }}</div>
                                <div class="kpi-value" id="kpi-turnover">0%</div>
                                <span class="kpi-change bg-danger-subtle text-danger">-1.2%</span>
                            </div>
                            <div class="kpi-icon bg-warning-subtle text-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card" style="border-left-color: #ef4444;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="flex-grow-1">
                                <div class="kpi-label">{{ 'High Risk' if lang == 'en' else 'مخاطر عالية' }}</div>
                                <div class="kpi-value" id="kpi-high-risk">0</div>
                                <span class="kpi-change bg-danger-subtle text-danger">{{ 'employees' if lang == 'en' else 'موظف' }}</span>
                            </div>
                            <div class="kpi-icon bg-danger-subtle text-danger">
                                <i class="fas fa-user-shield"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom">
                            <h6 class="mb-0 fw-bold">{{ 'Turnover Prediction' if lang == 'en' else 'توقع الاستقالات' }}</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="turnoverChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom">
                            <h6 class="mb-0 fw-bold">{{ 'Performance Distribution' if lang == 'en' else 'توزيع الأداء' }}</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="performanceChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="row g-3">
                <div class="col-md-3">
                    <button class="btn btn-outline-primary w-100" onclick="showSection('employees')">
                        <i class="fas fa-users me-2"></i>{{ 'View Employees' if lang == 'en' else 'عرض الموظفين' }}
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-success w-100" onclick="showSection('performance')">
                        <i class="fas fa-star me-2"></i>{{ 'Performance' if lang == 'en' else 'الأداء' }}
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-warning w-100" onclick="showSection('turnover')">
                        <i class="fas fa-exclamation-triangle me-2"></i>{{ 'Turnover' if lang == 'en' else 'الاستقالات' }}
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-info w-100" onclick="showSection('recommendations')">
                        <i class="fas fa-lightbulb me-2"></i>{{ 'AI Insights' if lang == 'en' else 'التوصيات' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Other Sections (Placeholders for now) -->
        <div id="section-employees" class="hr-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold mb-2">{{ 'Employees Management' if lang == 'en' else 'إدارة الموظفين' }}</h2>
                    <p class="text-muted mb-0">{{ 'Complete employee database with AI insights' if lang == 'en' else 'قاعدة بيانات الموظفين مع التحليلات الذكية' }}</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="alert('Coming soon!')">
                        <i class="fas fa-plus me-2"></i>{{ 'Add Employee' if lang == 'en' else 'إضافة موظف' }}
                    </button>
                    <button class="btn btn-outline-primary" onclick="showSection('import')">
                        <i class="fas fa-file-import me-2"></i>{{ 'Import CSV' if lang == 'en' else 'استيراد CSV' }}
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label small text-muted">{{ 'Search' if lang == 'en' else 'بحث' }}</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                                <input type="text" class="form-control" placeholder="{{ 'Search by name, ID...' if lang == 'en' else 'البحث بالاسم، الرقم...' }}" id="employee-search">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">{{ 'Department' if lang == 'en' else 'القسم' }}</label>
                            <select class="form-select" id="filter-department">
                                <option value="">{{ 'All' if lang == 'en' else 'الكل' }}</option>
                                <option value="IT">IT</option>
                                <option value="HR">HR</option>
                                <option value="Sales">Sales</option>
                                <option value="Finance">Finance</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">{{ 'Performance' if lang == 'en' else 'الأداء' }}</label>
                            <select class="form-select" id="filter-performance">
                                <option value="">{{ 'All' if lang == 'en' else 'الكل' }}</option>
                                <option value="excellent">{{ 'Excellent' if lang == 'en' else 'ممتاز' }}</option>
                                <option value="good">{{ 'Good' if lang == 'en' else 'جيد' }}</option>
                                <option value="average">{{ 'Average' if lang == 'en' else 'متوسط' }}</option>
                                <option value="poor">{{ 'Poor' if lang == 'en' else 'ضعيف' }}</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">{{ 'Risk Level' if lang == 'en' else 'مستوى المخاطر' }}</label>
                            <select class="form-select" id="filter-risk">
                                <option value="">{{ 'All' if lang == 'en' else 'الكل' }}</option>
                                <option value="high">{{ 'High' if lang == 'en' else 'مرتفع' }}</option>
                                <option value="medium">{{ 'Medium' if lang == 'en' else 'متوسط' }}</option>
                                <option value="low">{{ 'Low' if lang == 'en' else 'منخفض' }}</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-undo me-2"></i>{{ 'Clear Filters' if lang == 'en' else 'مسح الفلاتر' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employees Table -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center py-3">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-users me-2 text-primary"></i>
                        {{ 'Employee List' if lang == 'en' else 'قائمة الموظفين' }}
                        <span class="badge bg-primary ms-2" id="employee-total-badge">0</span>
                    </h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportEmployees()">
                        <i class="fas fa-download me-1"></i>{{ 'Export' if lang == 'en' else 'تصدير' }}
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="px-4 py-3">{{ 'Employee' if lang == 'en' else 'الموظف' }}</th>
                                    <th class="px-4 py-3">{{ 'Department' if lang == 'en' else 'القسم' }}</th>
                                    <th class="px-4 py-3">{{ 'Position' if lang == 'en' else 'المنصب' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Performance' if lang == 'en' else 'الأداء' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Attendance' if lang == 'en' else 'الانضباط' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Risk' if lang == 'en' else 'المخاطر' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Status' if lang == 'en' else 'الحالة' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Actions' if lang == 'en' else 'الإجراءات' }}</th>
                                </tr>
                            </thead>
                            <tbody id="employees-table-body">
                                <tr>
                                    <td colspan="8" class="text-center py-5">
                                        <div class="text-muted">
                                            <i class="fas fa-users fa-3x mb-3 opacity-25"></i>
                                            <p>{{ 'No employees data. Please import employee data to get started.' if lang == 'en' else 'لا توجد بيانات موظفين. قم باستيراد البيانات للبدء.' }}</p>
                                            <button class="btn btn-primary" onclick="showSection('import')">
                                                <i class="fas fa-upload me-2"></i>{{ 'Import Data' if lang == 'en' else 'استيراد البيانات' }}
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">
                            {{ 'Showing' if lang == 'en' else 'عرض' }} <span id="showing-count">0</span> {{ 'of' if lang == 'en' else 'من' }} <span id="total-count">0</span> {{ 'employees' if lang == 'en' else 'موظف' }}
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="employees-pagination">
                                <li class="page-item disabled"><a class="page-link" href="#">{{ 'Previous' if lang == 'en' else 'السابق' }}</a></li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item disabled"><a class="page-link" href="#">{{ 'Next' if lang == 'en' else 'التالي' }}</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-performance" class="hr-section">
            <h2>{{ 'Performance Analytics' if lang == 'en' else 'تحليل الأداء' }}</h2>
            <p class="text-muted">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
        </div>

        <div id="section-attendance" class="hr-section">
            <h2>{{ 'Attendance Management' if lang == 'en' else 'إدارة الحضور' }}</h2>
            <p class="text-muted">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
        </div>

        <div id="section-payroll" class="hr-section">
            <h2>{{ 'Payroll Management' if lang == 'en' else 'إدارة الرواتب' }}</h2>
            <p class="text-muted">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
        </div>

        <div id="section-resignations" class="hr-section">
            <h2>{{ 'Resignations' if lang == 'en' else 'الاستقالات' }}</h2>
            <p class="text-muted">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
        </div>

        <div id="section-recommendations" class="hr-section">
            <h2>{{ 'AI Recommendations' if lang == 'en' else 'التوصيات الذكية' }}</h2>
            <p class="text-muted">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
        </div>

        <div id="section-turnover" class="hr-section">
            <h2>{{ 'Turnover Prediction' if lang == 'en' else 'توقع الاستقالات' }}</h2>
            <p class="text-muted">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
        </div>

        <div id="section-settings" class="hr-section">
            <h2>{{ 'Settings' if lang == 'en' else 'الإعدادات' }}</h2>
            <p class="text-muted">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
        </div>
    </div>
</div>

<!-- Column Mapping Modal -->
<div class="modal fade" id="mappingModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ 'Column Mapping' if lang == 'en' else 'مطابقة الأعمدة' }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="mappingForm"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'Cancel' if lang == 'en' else 'إلغاء' }}</button>
                <button type="button" class="btn btn-primary" onclick="applyMapping()">{{ 'Save & Continue' if lang == 'en' else 'حفظ ومتابعة' }}</button>
            </div>
        </div>
    </div>
</div>

<script>
const lang = '{{ lang }}';
let currentImportId = null;
let currentFileType = null;
let currentHeaders = [];
let uploadedFilesCount = 0;

// Navigation
function showSection(sectionName) {
    document.querySelectorAll('.hr-section').forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById('section-' + sectionName).classList.add('active');
    
    document.querySelectorAll('.hr-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
}

// Import Steps
function selectImportType(type) {
    if (type === 'csv') {
        goToImportStep(2);
    }
}

function goToImportStep(step) {
    document.querySelectorAll('.import-step').forEach(el => el.style.display = 'none');
    document.getElementById('import-step-' + step).style.display = 'block';
    
    document.querySelectorAll('.progress-step').forEach((el, idx) => {
        el.classList.remove('active', 'completed');
        if (idx + 1 < step) el.classList.add('completed');
        if (idx + 1 === step) el.classList.add('active');
    });
}

// File Upload
const requiredFields = {
    'employees': ['employee_id', 'full_name', 'department', 'job_title', 'hire_date', 'base_salary'],
    'attendance': ['employee_id', 'date', 'check_in', 'check_out', 'status'],
    'performance': ['employee_id', 'review_period', 'review_date', 'overall_rating'],
    'payroll': ['employee_id', 'month', 'year', 'net_salary'],
    'resignations': ['employee_id', 'termination_type', 'termination_date']
};

const fieldLabels = {
    'employee_id': lang === 'ar' ? 'رقم الموظف' : 'Employee ID',
    'full_name': lang === 'ar' ? 'الاسم الكامل' : 'Full Name',
    'department': lang === 'ar' ? 'القسم' : 'Department',
    'job_title': lang === 'ar' ? 'المسمى الوظيفي' : 'Job Title',
    'hire_date': lang === 'ar' ? 'تاريخ التعيين' : 'Hire Date',
    'base_salary': lang === 'ar' ? 'الراتب الأساسي' : 'Base Salary',
    'date': lang === 'ar' ? 'التاريخ' : 'Date',
    'check_in': lang === 'ar' ? 'وقت الحضور' : 'Check In',
    'check_out': lang === 'ar' ? 'وقت الانصراف' : 'Check Out',
    'status': lang === 'ar' ? 'الحالة' : 'Status',
    'review_period': lang === 'ar' ? 'فترة التقييم' : 'Review Period',
    'review_date': lang === 'ar' ? 'تاريخ التقييم' : 'Review Date',
    'overall_rating': lang === 'ar' ? 'التقييم العام' : 'Overall Rating',
    'month': lang === 'ar' ? 'الشهر' : 'Month',
    'year': lang === 'ar' ? 'السنة' : 'Year',
    'net_salary': lang === 'ar' ? 'صافي الراتب' : 'Net Salary',
    'termination_type': lang === 'ar' ? 'نوع إنهاء الخدمة' : 'Termination Type',
    'termination_date': lang === 'ar' ? 'تاريخ إنهاء الخدمة' : 'Termination Date'
};

async function handleFileUpload(input, fileType) {
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('file_type', fileType);

    try {
        const response = await fetch('/erp/hr/api/import', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            currentImportId = data.import_id;
            currentFileType = fileType;
            currentHeaders = data.headers;
            
            const statusBadge = document.querySelector(`#file-row-${fileType} .file-status`);
            statusBadge.className = 'badge bg-success file-status';
            statusBadge.innerHTML = '<i class="fas fa-check me-1"></i>' + (lang === 'ar' ? 'مرفوع' : 'Uploaded');
            
            uploadedFilesCount++;
            updateHomeProgress();
            
            await Swal.fire({
                icon: 'success',
                title: lang === 'ar' ? 'تم رفع الملف بنجاح!' : 'File uploaded successfully!',
                text: lang === 'ar' ? `تم اكتشاف ${data.total_rows} صف` : `Found ${data.total_rows} rows`,
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
            });
            
            showMappingModal(data.headers, data.sample_rows, fileType);
        } else {
            await Swal.fire({
                icon: 'error',
                title: lang === 'ar' ? 'خطأ' : 'Error',
                text: data.error,
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
            });
        }
    } catch (error) {
        console.error('Upload error:', error);
        await Swal.fire({
            icon: 'error',
            title: lang === 'ar' ? 'خطأ' : 'Error',
            text: lang === 'ar' ? 'حدث خطأ أثناء رفع الملف' : 'Error uploading file',
            confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
        });
    }
    
    input.value = '';
}

function showMappingModal(headers, sampleRows, fileType) {
    const fields = requiredFields[fileType] || [];
    let html = '<div class="row">';
    
    fields.forEach(field => {
        const matchingHeader = headers.find(h => 
            h.toLowerCase().includes(field.replace('_', '')) ||
            field.includes(h.toLowerCase().replace(' ', '_'))
        );
        
        html += `
            <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">${fieldLabels[field] || field}</label>
                <select class="form-select mapping-select" data-field="${field}">
                    <option value="">-- ${lang === 'ar' ? 'اختر العمود' : 'Select Column'} --</option>
                    ${headers.map(h => `<option value="${h}" ${h === matchingHeader ? 'selected' : ''}>${h}</option>`).join('')}
                </select>
            </div>
        `;
    });
    
    html += '</div>';
    
    if (sampleRows && sampleRows.length > 0) {
        html += `
            <div class="mt-4">
                <h6 class="mb-3"><i class="fas fa-eye me-2"></i>${lang === 'ar' ? 'معاينة البيانات' : 'Data Preview'}</h6>
                <div class="table-responsive" style="max-height: 300px;">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${sampleRows.slice(0, 5).map(row => `
                                <tr>${headers.map(h => `<td>${row[h] || '-'}</td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    document.getElementById('mappingForm').innerHTML = html;
    new bootstrap.Modal(document.getElementById('mappingModal')).show();
}

async function applyMapping() {
    const mapping = {};
    document.querySelectorAll('.mapping-select').forEach(select => {
        if (select.value) {
            mapping[select.dataset.field] = select.value;
        }
    });
    
    try {
        Swal.fire({
            title: lang === 'ar' ? 'جاري الاستيراد...' : 'Importing...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });
        
        const mapResponse = await fetch(`/erp/hr/api/import/${currentImportId}/map`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ mapping: mapping })
        });
        
        const mapResult = await mapResponse.json();
        
        if (!mapResult.success) {
            await Swal.fire({
                icon: 'error',
                title: lang === 'ar' ? 'خطأ' : 'Error',
                text: mapResult.error,
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
            });
            return;
        }
        
        const processResponse = await fetch(`/erp/hr/api/import/${currentImportId}/process`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await processResponse.json();
        
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('mappingModal')).hide();
            
            await Swal.fire({
                icon: 'success',
                title: lang === 'ar' ? 'نجح!' : 'Success!',
                text: lang === 'ar' ? `تم استيراد ${result.imported || 0} سجل` : `Imported ${result.imported || 0} records`,
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
            });
        } else {
            await Swal.fire({
                icon: 'error',
                title: lang === 'ar' ? 'خطأ' : 'Error',
                text: result.error,
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
            });
        }
    } catch (error) {
        console.error('Mapping error:', error);
        await Swal.fire({
            icon: 'error',
            title: lang === 'ar' ? 'خطأ' : 'Error',
            text: error.message,
            confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
        });
    }
}

function updateHomeProgress() {
    const totalFiles = 5;
    const progress = (uploadedFilesCount / totalFiles) * 100;
    document.getElementById('home-files-count').textContent = `${uploadedFilesCount}/${totalFiles}`;
    document.getElementById('home-files-progress').style.width = `${progress}%`;
}

async function processAllFiles() {
    showSection('processing');
    
    const steps = document.querySelectorAll('.processing-step');
    for (let i = 0; i < steps.length; i++) {
        await new Promise(resolve => setTimeout(resolve, 1500));
        steps[i].classList.add('active');
        steps[i].querySelector('i').className = 'fas fa-check-circle';
    }
    
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    await Swal.fire({
        icon: 'success',
        title: lang === 'ar' ? 'تم بنجاح!' : 'Success!',
        text: lang === 'ar' ? 'تم تحليل البيانات بنجاح' : 'Data analyzed successfully',
        confirmButtonText: lang === 'ar' ? 'عرض لوحة القيادة' : 'View Dashboard'
    });
    
    showSection('dashboard');
}

function downloadTemplate() {
    Swal.fire({
        icon: 'info',
        title: lang === 'ar' ? 'قريباً' : 'Coming Soon',
        text: lang === 'ar' ? 'ستتوفر قوالب الملفات قريباً' : 'File templates will be available soon',
        confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
    });
}

// Employee Management Functions
function clearFilters() {
    document.getElementById('employee-search').value = '';
    document.getElementById('filter-department').value = '';
    document.getElementById('filter-performance').value = '';
    document.getElementById('filter-risk').value = '';
    loadEmployees();
}

async function loadEmployees() {
    try {
        const response = await fetch('/erp/hr/api/employees');
        const data = await response.json();
        
        if (data.success && data.employees) {
            renderEmployeesTable(data.employees);
            document.getElementById('employee-total-badge').textContent = data.employees.length;
            document.getElementById('total-count').textContent = data.employees.length;
            document.getElementById('showing-count').textContent = data.employees.length;
        }
    } catch (error) {
        console.error('Error loading employees:', error);
    }
}

function renderEmployeesTable(employees) {
    const tbody = document.getElementById('employees-table-body');
    
    if (!employees || employees.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-5">
                    <div class="text-muted">
                        <i class="fas fa-users fa-3x mb-3 opacity-25"></i>
                        <p>${lang === 'ar' ? 'لا توجد بيانات موظفين' : 'No employees data'}</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = employees.map(emp => `
        <tr>
            <td class="px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="avatar-circle bg-primary-subtle text-primary me-3">
                        <strong>${emp.full_name ? emp.full_name.charAt(0) : 'U'}</strong>
                    </div>
                    <div>
                        <div class="fw-semibold">${emp.full_name || 'N/A'}</div>
                        <small class="text-muted">ID: ${emp.employee_id || 'N/A'}</small>
                    </div>
                </div>
            </td>
            <td class="px-4 py-3">${emp.department || 'N/A'}</td>
            <td class="px-4 py-3">${emp.job_title || 'N/A'}</td>
            <td class="px-4 py-3 text-center">
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar ${getPerformanceColor(85)}" style="width: 85%"></div>
                </div>
                <small class="text-muted">85%</small>
            </td>
            <td class="px-4 py-3 text-center">
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" style="width: 92%"></div>
                </div>
                <small class="text-muted">92%</small>
            </td>
            <td class="px-4 py-3 text-center">
                <span class="badge ${getRiskBadge('low')}">${lang === 'ar' ? 'منخفض' : 'Low'}</span>
            </td>
            <td class="px-4 py-3 text-center">
                <span class="badge bg-success-subtle text-success">${lang === 'ar' ? 'نشط' : 'Active'}</span>
            </td>
            <td class="px-4 py-3 text-center">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewEmployeeProfile(${emp.id})" title="${lang === 'ar' ? 'عرض الملف' : 'View Profile'}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="analyzeEmployee(${emp.id})" title="${lang === 'ar' ? 'تحليل AI' : 'AI Analysis'}">
                        <i class="fas fa-brain"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getPerformanceColor(score) {
    if (score >= 80) return 'bg-success';
    if (score >= 60) return 'bg-primary';
    if (score >= 40) return 'bg-warning';
    return 'bg-danger';
}

function getRiskBadge(risk) {
    const badges = {
        'high': 'bg-danger-subtle text-danger',
        'medium': 'bg-warning-subtle text-warning',
        'low': 'bg-success-subtle text-success'
    };
    return badges[risk] || badges['low'];
}

function viewEmployeeProfile(id) {
    Swal.fire({
        icon: 'info',
        title: lang === 'ar' ? 'قريباً' : 'Coming Soon',
        text: lang === 'ar' ? 'سيتم فتح ملف الموظف قريباً' : 'Employee profile will be available soon',
        confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
    });
}

function analyzeEmployee(id) {
    Swal.fire({
        icon: 'info',
        title: lang === 'ar' ? 'قريباً' : 'Coming Soon',
        text: lang === 'ar' ? 'سيتم تحليل الموظف بالذكاء الاصطناعي قريباً' : 'AI analysis will be available soon',
        confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
    });
}

function exportEmployees() {
    Swal.fire({
        icon: 'info',
        title: lang === 'ar' ? 'قريباً' : 'Coming Soon',
        text: lang === 'ar' ? 'سيتم تصدير البيانات قريباً' : 'Export will be available soon',
        confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
    });
}

// Initialize Charts
window.addEventListener('load', () => {
    const turnoverCtx = document.getElementById('turnoverChart');
    if (turnoverCtx) {
        new Chart(turnoverCtx, {
            type: 'bar',
            data: {
                labels: lang === 'ar' ? ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'] : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: lang === 'ar' ? 'معدل الاستقالات' : 'Turnover Rate',
                    data: [12, 15, 10, 18, 14, 16],
                    backgroundColor: '#3b82f6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
    
    const performanceCtx = document.getElementById('performanceChart');
    if (performanceCtx) {
        new Chart(performanceCtx, {
            type: 'doughnut',
            data: {
                labels: lang === 'ar' ? ['ممتاز', 'جيد', 'متوسط', 'ضعيف'] : ['Excellent', 'Good', 'Average', 'Poor'],
                datasets: [{
                    data: [30, 45, 20, 5],
                    backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
});
</script>
{% endblock %}
