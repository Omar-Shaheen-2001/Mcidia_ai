{% extends "base.html" %}

{% block title %}{{ 'HR AI Engine' if lang == 'en' else 'محرك الموارد البشرية الذكي' }} - Mcidia{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<style>
*,
*::before,
*::after {
    box-sizing: border-box;
}

:root {
    --hr-bg: #f8fafc;
    --hr-surface: #ffffff;
    --hr-border: #e2e8f0;
    --hr-border-soft: #f1f5f9;
    --hr-primary: #2563eb;
    --hr-primary-soft: #eff6ff;
    --hr-primary-strong: #1d4ed8;
    --hr-text: #1e293b;
    --hr-text-soft: #64748b;
    --hr-text-muted: #94a3b8;
    --hr-success: #10b981;
    --hr-warning: #f59e0b;
    --hr-danger: #ef4444;
    --hr-sidebar-width: 280px;
    --hr-sidebar-collapsed: 72px;
    --hr-radius: 12px;
    --hr-radius-sm: 8px;
    --hr-shadow: 0 1px 3px rgba(0,0,0,0.08);
    --hr-shadow-lg: 0 4px 12px rgba(0,0,0,0.1);
}

.hr-layout {
    display: flex;
    min-height: calc(100vh - 70px);
    background: var(--hr-bg);
}

.hr-sidebar {
    width: var(--hr-sidebar-width);
    background: var(--hr-surface);
    border-inline-end: 1px solid var(--hr-border);
    display: flex;
    flex-direction: column;
    position: sticky;
    top: 70px;
    height: calc(100vh - 70px);
    transition: width 0.3s ease;
    z-index: 100;
}

.hr-sidebar.collapsed {
    width: var(--hr-sidebar-collapsed);
}

.hr-sidebar.collapsed .sidebar-text,
.hr-sidebar.collapsed .sidebar-badge,
.hr-sidebar.collapsed .sidebar-footer {
    opacity: 0;
    visibility: hidden;
}

.hr-sidebar.collapsed .sidebar-nav {
    padding: 12px 8px;
}

.hr-sidebar.collapsed .nav-item {
    justify-content: center;
    padding: 12px;
}

.sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--hr-border-soft);
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
}

.sidebar-logo {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: var(--hr-primary-soft);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--hr-primary);
    font-size: 18px;
    flex-shrink: 0;
}

.sidebar-title {
    flex: 1;
}

.sidebar-title h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 700;
    color: var(--hr-text);
}

.sidebar-title small {
    font-size: 11px;
    color: var(--hr-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.sidebar-toggle {
    position: absolute;
    top: 50%;
    inset-inline-end: -16px;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: var(--hr-primary);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: var(--hr-shadow-lg);
    transition: background 0.2s, transform 0.2s;
    z-index: 10;
}

.sidebar-toggle:hover {
    background: var(--hr-primary-strong);
    transform: translateY(-50%) scale(1.05);
}

.sidebar-nav {
    flex: 1;
    overflow-y: auto;
    padding: 16px 12px;
}

.nav-section {
    margin-bottom: 20px;
}

.nav-section:last-child {
    margin-bottom: 0;
}

.nav-section-title {
    font-size: 10px;
    font-weight: 700;
    color: var(--hr-text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 0 12px 8px;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    margin: 2px 0;
    border-radius: var(--hr-radius-sm);
    color: var(--hr-text-soft);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s;
    border: none;
    background: transparent;
    width: 100%;
    text-align: start;
}

.nav-item:hover {
    background: var(--hr-border-soft);
    color: var(--hr-text);
}

.nav-item:hover .nav-icon {
    color: var(--hr-primary);
}

.nav-item.active {
    background: var(--hr-primary-soft);
    color: var(--hr-primary);
    font-weight: 600;
}

.nav-item.active .nav-icon {
    color: var(--hr-primary);
}

.nav-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: var(--hr-text-muted);
    flex-shrink: 0;
}

.sidebar-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 20px;
    background: var(--hr-primary-soft);
    color: var(--hr-primary);
    font-weight: 600;
    margin-inline-start: auto;
}

.sidebar-footer {
    padding: 16px;
    border-top: 1px solid var(--hr-border-soft);
    background: var(--hr-border-soft);
}

.footer-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.footer-stat {
    background: var(--hr-surface);
    border-radius: var(--hr-radius-sm);
    padding: 10px;
    text-align: center;
    border: 1px solid var(--hr-border);
}

.footer-stat-value {
    font-size: 18px;
    font-weight: 800;
    color: var(--hr-primary);
}

.footer-stat-label {
    font-size: 10px;
    color: var(--hr-text-muted);
    text-transform: uppercase;
}

.hr-main {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
}

.hr-section {
    display: none;
    animation: fadeIn 0.3s ease;
}

.hr-section.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.page-header {
    margin-bottom: 24px;
}

.page-title {
    font-size: 24px;
    font-weight: 800;
    color: var(--hr-text);
    margin: 0 0 4px;
}

.page-subtitle {
    font-size: 14px;
    color: var(--hr-text-soft);
    margin: 0;
}

.card {
    background: var(--hr-surface);
    border-radius: var(--hr-radius);
    border: 1px solid var(--hr-border);
    box-shadow: var(--hr-shadow);
    padding: 20px;
    height: 100%;
}

.card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    font-size: 15px;
    font-weight: 700;
    color: var(--hr-text);
}

.card-header i {
    color: var(--hr-primary);
}

.stat-card {
    background: var(--hr-surface);
    border-radius: var(--hr-radius);
    border: 1px solid var(--hr-border);
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}

.stat-content .stat-label {
    font-size: 11px;
    text-transform: uppercase;
    color: var(--hr-text-muted);
    font-weight: 600;
    margin-bottom: 4px;
}

.stat-content .stat-value {
    font-size: 28px;
    font-weight: 800;
    color: var(--hr-text);
    line-height: 1;
}

.stat-content .stat-change {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 20px;
    margin-top: 8px;
    display: inline-block;
}

.stat-change.positive {
    background: #dcfce7;
    color: #15803d;
}

.stat-change.negative {
    background: #fee2e2;
    color: #b91c1c;
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--hr-radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.stat-icon.blue {
    background: var(--hr-primary-soft);
    color: var(--hr-primary);
}

.stat-icon.green {
    background: #dcfce7;
    color: #16a34a;
}

.stat-icon.red {
    background: #fee2e2;
    color: #b91c1c;
}

.stat-icon.yellow {
    background: #fef3c7;
    color: #d97706;
}

.quick-card {
    background: var(--hr-surface);
    border-radius: var(--hr-radius);
    border: 1px solid var(--hr-border);
    padding: 20px;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.quick-card-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 16px;
}

.quick-card-icon {
    width: 44px;
    height: 44px;
    border-radius: var(--hr-radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
}

.quick-card-icon.blue {
    background: var(--hr-primary-soft);
    color: var(--hr-primary);
}

.quick-card-icon.green {
    background: #dcfce7;
    color: #16a34a;
}

.quick-card-icon.yellow {
    background: #fef3c7;
    color: #d97706;
}

.quick-card-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--hr-text);
    margin: 0 0 4px;
}

.quick-card-desc {
    font-size: 12px;
    color: var(--hr-text-soft);
    margin: 0;
}

.quick-card-body {
    flex: 1;
}

.quick-card-footer {
    margin-top: auto;
    padding-top: 16px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    background: #0f172a;
    color: #fff;
}

.data-table thead th {
    padding: 12px 16px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    text-align: start;
}

.data-table tbody td {
    padding: 12px 16px;
    font-size: 13px;
    border-bottom: 1px solid var(--hr-border-soft);
}

.data-table tbody tr:hover {
    background: var(--hr-border-soft);
}

.progress-wizard {
    display: flex;
    justify-content: space-between;
    margin-bottom: 24px;
    position: relative;
}

.progress-wizard::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 50px;
    right: 50px;
    height: 2px;
    background: var(--hr-border);
}

.wizard-step {
    position: relative;
    z-index: 1;
    text-align: center;
    flex: 1;
}

.wizard-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--hr-surface);
    border: 2px solid var(--hr-border);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    color: var(--hr-text-soft);
    margin-bottom: 8px;
}

.wizard-step.active .wizard-circle {
    border-color: var(--hr-primary);
    color: var(--hr-primary);
    box-shadow: 0 0 0 4px var(--hr-primary-soft);
}

.wizard-step.completed .wizard-circle {
    background: var(--hr-success);
    border-color: var(--hr-success);
    color: #fff;
}

.wizard-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--hr-text-soft);
}

.wizard-step.active .wizard-label {
    color: var(--hr-primary);
}

.import-card {
    background: var(--hr-surface);
    border: 2px dashed var(--hr-border);
    border-radius: var(--hr-radius);
    padding: 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.import-card:hover {
    border-color: var(--hr-primary);
    background: var(--hr-primary-soft);
}

.import-card.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.import-card-icon {
    width: 56px;
    height: 56px;
    border-radius: var(--hr-radius);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin-bottom: 12px;
}

.avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--hr-primary-soft);
    color: var(--hr-primary);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
}

.badge-status {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 20px;
    font-weight: 600;
}

.badge-success {
    background: #dcfce7;
    color: #15803d;
}

.badge-warning {
    background: #fef3c7;
    color: #d97706;
}

.badge-danger {
    background: #fee2e2;
    color: #b91c1c;
}

.badge-info {
    background: var(--hr-primary-soft);
    color: var(--hr-primary);
}

.filter-bar {
    background: var(--hr-surface);
    border-radius: var(--hr-radius);
    border: 1px solid var(--hr-border);
    padding: 16px;
    margin-bottom: 16px;
}

.chart-container {
    height: 260px;
    position: relative;
}

.processing-screen {
    text-align: center;
    background: var(--hr-surface);
    border-radius: var(--hr-radius);
    padding: 48px 24px;
    border: 1px solid var(--hr-border);
}

.processing-spinner {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid var(--hr-border);
    border-top-color: var(--hr-primary);
    margin: 0 auto 24px;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.processing-steps {
    max-width: 400px;
    margin: 0 auto;
    text-align: start;
}

.processing-step {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    color: var(--hr-text-muted);
    font-size: 13px;
}

.processing-step.active {
    color: var(--hr-text);
    font-weight: 600;
}

.processing-step i {
    font-size: 16px;
    color: var(--hr-success);
}

.empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--hr-text-muted);
}

.empty-state i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.3;
}

[dir="rtl"] .sidebar-toggle {
    inset-inline-start: -16px;
    inset-inline-end: auto;
}

@media (max-width: 992px) {
    .hr-layout {
        flex-direction: column;
    }
    .hr-sidebar {
        position: relative;
        top: 0;
        height: auto;
        width: 100%;
    }
    .hr-sidebar.collapsed {
        width: 100%;
    }
    .sidebar-toggle {
        display: none;
    }
    .sidebar-nav {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px;
    }
    .nav-section {
        display: contents;
    }
    .nav-section-title {
        display: none;
    }
    .nav-item {
        flex: 0 0 auto;
        padding: 8px 16px;
    }
    .hr-main {
        padding: 16px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="hr-layout">
    <aside class="hr-sidebar" id="hrSidebar" role="navigation" aria-label="{{ 'HR Navigation' if lang == 'en' else 'تنقل الموارد البشرية' }}">
        <div class="sidebar-header">
            <div class="sidebar-logo" aria-hidden="true">
                <i class="fas fa-user-gear"></i>
            </div>
            <div class="sidebar-title sidebar-text">
                <h4>Mcidia HR</h4>
                <small>{{ 'AI Engine' if lang == 'en' else 'محرك الذكاء' }}</small>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="{{ 'Toggle sidebar' if lang == 'en' else 'تبديل الشريط' }}" aria-label="{{ 'Toggle sidebar' if lang == 'en' else 'تبديل الشريط الجانبي' }}" aria-expanded="true">
                <i class="fas fa-chevron-left" id="toggleIcon" aria-hidden="true"></i>
            </button>
        </div>

        <nav class="sidebar-nav" role="menubar" aria-label="{{ 'Main navigation' if lang == 'en' else 'التنقل الرئيسي' }}">
            <div class="nav-section" role="group" aria-label="{{ 'Core' if lang == 'en' else 'الأساسي' }}">
                <div class="nav-section-title sidebar-text" id="nav-core-title">{{ 'Core' if lang == 'en' else 'الأساسي' }}</div>
                <button class="nav-item active" onclick="showSection('home', this)" role="menuitem" aria-current="page">
                    <span class="nav-icon" aria-hidden="true"><i class="fas fa-house"></i></span>
                    <span class="sidebar-text">{{ 'Home' if lang == 'en' else 'الرئيسية' }}</span>
                </button>
                <button class="nav-item" onclick="showSection('dashboard', this)" role="menuitem">
                    <span class="nav-icon" aria-hidden="true"><i class="fas fa-chart-line"></i></span>
                    <span class="sidebar-text">{{ 'Dashboard' if lang == 'en' else 'لوحة القيادة' }}</span>
                </button>
            </div>

            <div class="nav-section" role="group" aria-label="{{ 'Data' if lang == 'en' else 'البيانات' }}">
                <div class="nav-section-title sidebar-text">{{ 'Data' if lang == 'en' else 'البيانات' }}</div>
                <button class="nav-item" onclick="showSection('import', this)" role="menuitem">
                    <span class="nav-icon" aria-hidden="true"><i class="fas fa-file-import"></i></span>
                    <span class="sidebar-text">{{ 'Import' if lang == 'en' else 'استيراد' }}</span>
                </button>
                <button class="nav-item" onclick="showSection('employees', this)" role="menuitem">
                    <span class="nav-icon" aria-hidden="true"><i class="fas fa-users"></i></span>
                    <span class="sidebar-text">{{ 'Employees' if lang == 'en' else 'الموظفون' }}</span>
                    <span class="sidebar-badge" id="employeesCount" aria-label="{{ 'Employee count' if lang == 'en' else 'عدد الموظفين' }}">0</span>
                </button>
            </div>

            <div class="nav-section" role="group" aria-label="{{ 'Analytics' if lang == 'en' else 'التحليلات' }}">
                <div class="nav-section-title sidebar-text">{{ 'Analytics' if lang == 'en' else 'التحليلات' }}</div>
                <button class="nav-item" onclick="showSection('performance', this)" role="menuitem">
                    <span class="nav-icon" aria-hidden="true"><i class="fas fa-star-half-stroke"></i></span>
                    <span class="sidebar-text">{{ 'Performance' if lang == 'en' else 'الأداء' }}</span>
                </button>
                <button class="nav-item" onclick="showSection('attendance', this)" role="menuitem">
                    <span class="nav-icon" aria-hidden="true"><i class="fas fa-calendar-check"></i></span>
                    <span class="sidebar-text">{{ 'Attendance' if lang == 'en' else 'الحضور' }}</span>
                </button>
                <button class="nav-item" onclick="showSection('payroll', this)" role="menuitem">
                    <span class="nav-icon" aria-hidden="true"><i class="fas fa-sack-dollar"></i></span>
                    <span class="sidebar-text">{{ 'Payroll' if lang == 'en' else 'الرواتب' }}</span>
                </button>
                <button class="nav-item" onclick="showSection('resignations', this)" role="menuitem">
                    <span class="nav-icon" aria-hidden="true"><i class="fas fa-arrow-right-from-bracket"></i></span>
                    <span class="sidebar-text">{{ 'Resignations' if lang == 'en' else 'الاستقالات' }}</span>
                </button>
            </div>

            <div class="nav-section" role="group" aria-label="{{ 'AI Engine' if lang == 'en' else 'الذكاء الاصطناعي' }}">
                <div class="nav-section-title sidebar-text">{{ 'AI Engine' if lang == 'en' else 'الذكاء الاصطناعي' }}</div>
                <button class="nav-item" onclick="showSection('turnover', this)" role="menuitem">
                    <span class="nav-icon" aria-hidden="true"><i class="fas fa-brain"></i></span>
                    <span class="sidebar-text">{{ 'Turnover AI' if lang == 'en' else 'توقع الاستقالات' }}</span>
                </button>
                <button class="nav-item" onclick="showSection('insights', this)" role="menuitem">
                    <span class="nav-icon" aria-hidden="true"><i class="fas fa-wand-magic-sparkles"></i></span>
                    <span class="sidebar-text">{{ 'Insights' if lang == 'en' else 'التوصيات' }}</span>
                </button>
            </div>

            <div class="nav-section" role="group" aria-label="{{ 'System' if lang == 'en' else 'النظام' }}">
                <div class="nav-section-title sidebar-text">{{ 'System' if lang == 'en' else 'النظام' }}</div>
                <button class="nav-item" onclick="showSection('settings', this)" role="menuitem">
                    <span class="nav-icon" aria-hidden="true"><i class="fas fa-sliders"></i></span>
                    <span class="sidebar-text">{{ 'Settings' if lang == 'en' else 'الإعدادات' }}</span>
                </button>
            </div>
        </nav>

        <div class="sidebar-footer sidebar-text">
            <div class="footer-stats">
                <div class="footer-stat">
                    <div class="footer-stat-value" id="sidebarEmpCount">0</div>
                    <div class="footer-stat-label">{{ 'Employees' if lang == 'en' else 'الموظفون' }}</div>
                </div>
                <div class="footer-stat">
                    <div class="footer-stat-value" id="sidebarHealth">--</div>
                    <div class="footer-stat-label">{{ 'Health' if lang == 'en' else 'الصحة' }}</div>
                </div>
            </div>
        </div>
    </aside>

    <main class="hr-main">
        <section id="section-home" class="hr-section active">
            <div class="page-header">
                <h1 class="page-title">{{ 'Welcome to HR Intelligence' if lang == 'en' else 'مرحباً بك في ذكاء الموارد البشرية' }}</h1>
                <p class="page-subtitle">{{ 'AI-powered analytics for better HR decisions' if lang == 'en' else 'تحليلات ذكية لقرارات أفضل في الموارد البشرية' }}</p>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-4">
                    <div class="quick-card">
                        <div class="quick-card-header">
                            <div class="quick-card-icon blue">
                                <i class="fas fa-database"></i>
                            </div>
                            <div>
                                <h3 class="quick-card-title">{{ 'HR Data Overview' if lang == 'en' else 'نظرة عامة على البيانات' }}</h3>
                                <p class="quick-card-desc">{{ 'Check status & import new files' if lang == 'en' else 'تابع حالة البيانات واستيراد ملفات جديدة' }}</p>
                            </div>
                        </div>
                        <div class="quick-card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">{{ 'Files uploaded' if lang == 'en' else 'الملفات المرفوعة' }}</small>
                                <span class="badge-status badge-success" id="homeFilesCount">0/5</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" id="homeFilesProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="quick-card-footer">
                            <button class="btn btn-primary btn-sm w-100" onclick="showSection('import')">
                                <i class="fas fa-file-import me-1"></i>{{ 'Import data' if lang == 'en' else 'استيراد البيانات' }}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="quick-card">
                        <div class="quick-card-header">
                            <div class="quick-card-icon green">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div>
                                <h3 class="quick-card-title">{{ 'AI Insights' if lang == 'en' else 'ملخص الذكاء الاصطناعي' }}</h3>
                                <p class="quick-card-desc">{{ 'Generate smart signals from your HR data' if lang == 'en' else 'توليد مؤشرات ذكية من بيانات الموارد البشرية' }}</p>
                            </div>
                        </div>
                        <div class="quick-card-body" id="aiInsightsContent">
                            <div class="alert alert-info mb-0 small">
                                <i class="fas fa-info-circle me-2"></i>
                                {{ 'Upload data to start AI analysis' if lang == 'en' else 'قم برفع بيانات الموظفين لبدء التحليل الذكي' }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="quick-card">
                        <div class="quick-card-header">
                            <div class="quick-card-icon yellow">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div>
                                <h3 class="quick-card-title">{{ 'Quick Actions' if lang == 'en' else 'إجراءات سريعة' }}</h3>
                                <p class="quick-card-desc">{{ 'Jump directly to key workflows' if lang == 'en' else 'انتقل مباشرة لأهم المهام' }}</p>
                            </div>
                        </div>
                        <div class="quick-card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="showSection('import')">
                                    <i class="fas fa-file-csv me-1"></i>{{ 'Import CSV' if lang == 'en' else 'استيراد CSV' }}
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="showSection('dashboard')">
                                    <i class="fas fa-chart-line me-1"></i>{{ 'View Dashboard' if lang == 'en' else 'عرض لوحة القيادة' }}
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="downloadTemplate()">
                                    <i class="fas fa-download me-1"></i>{{ 'Download template' if lang == 'en' else 'تحميل القالب' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-clock"></i>
                    <span>{{ 'Recent activity' if lang == 'en' else 'النشاطات الأخيرة' }}</span>
                </div>
                <div id="recentActivityList">
                    <div class="empty-state">
                        <i class="fas fa-inbox d-block"></i>
                        <p class="mb-0">{{ 'No recent activity' if lang == 'en' else 'لا توجد نشاطات حديثة' }}</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="section-import" class="hr-section">
            <div class="page-header">
                <button class="btn btn-outline-secondary btn-sm mb-3" onclick="showSection('home')">
                    <i class="fas fa-arrow-{{ 'right' if lang == 'ar' else 'left' }} me-1"></i>{{ 'Back' if lang == 'en' else 'رجوع' }}
                </button>
                <h1 class="page-title">{{ 'Data Import Wizard' if lang == 'en' else 'معالج استيراد البيانات' }}</h1>
                <p class="page-subtitle">{{ 'Import your HR data in 3 simple steps' if lang == 'en' else 'استورد بيانات الموارد البشرية في 3 خطوات بسيطة' }}</p>
            </div>

            <div class="progress-wizard">
                <div class="wizard-step active" id="wizardStep1">
                    <div class="wizard-circle">1</div>
                    <div class="wizard-label">{{ 'Import Type' if lang == 'en' else 'نوع الاستيراد' }}</div>
                </div>
                <div class="wizard-step" id="wizardStep2">
                    <div class="wizard-circle">2</div>
                    <div class="wizard-label">{{ 'Upload Files' if lang == 'en' else 'رفع الملفات' }}</div>
                </div>
                <div class="wizard-step" id="wizardStep3">
                    <div class="wizard-circle">3</div>
                    <div class="wizard-label">{{ 'Column Mapping' if lang == 'en' else 'مطابقة الأعمدة' }}</div>
                </div>
            </div>

            <div id="importStep1" class="import-step">
                <h5 class="fw-bold mb-3">{{ 'Select import method' if lang == 'en' else 'اختر طريقة الاستيراد' }}</h5>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="import-card" onclick="selectImportType('csv')">
                            <div class="import-card-icon" style="background: var(--hr-primary-soft); color: var(--hr-primary);">
                                <i class="fas fa-file-csv"></i>
                            </div>
                            <div class="fw-bold">{{ 'CSV / Excel files' if lang == 'en' else 'ملفات CSV / Excel' }}</div>
                            <small class="text-muted">{{ 'Upload files from your computer' if lang == 'en' else 'رفع الملفات من جهازك' }}</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="import-card disabled">
                            <div class="import-card-icon" style="background: #dcfce7; color: #16a34a;">
                                <i class="fas fa-plug"></i>
                            </div>
                            <div class="fw-bold">{{ 'ERP API' if lang == 'en' else 'ربط نظام ERP' }}</div>
                            <small class="text-muted">{{ 'API integration (coming soon)' if lang == 'en' else 'الربط عبر API (قريباً)' }}</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="import-card disabled">
                            <div class="import-card-icon" style="background: #fee2e2; color: #b91c1c;">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="fw-bold">{{ 'External database' if lang == 'en' else 'قاعدة بيانات خارجية' }}</div>
                            <small class="text-muted">{{ 'Direct DB connection (coming soon)' if lang == 'en' else 'الربط بقاعدة بيانات (قريباً)' }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <div id="importStep2" class="import-step" style="display:none;">
                <h5 class="fw-bold mb-3">{{ 'Upload HR files' if lang == 'en' else 'رفع ملفات الموارد البشرية' }}</h5>
                <div class="card">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>{{ 'File' if lang == 'en' else 'الملف' }}</th>
                                    <th>{{ 'Description' if lang == 'en' else 'الوصف' }}</th>
                                    <th class="text-center">{{ 'Status' if lang == 'en' else 'الحالة' }}</th>
                                    <th class="text-center">{{ 'Action' if lang == 'en' else 'الإجراء' }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="fileRowEmployees">
                                    <td><i class="fas fa-users text-primary me-2"></i><strong>employees.csv</strong></td>
                                    <td><small class="text-muted">{{ 'Employee master data' if lang == 'en' else 'بيانات الموظفين الأساسية' }}</small></td>
                                    <td class="text-center"><span class="badge-status badge-info fileStatus">{{ 'Not uploaded' if lang == 'en' else 'غير مرفوع' }}</span></td>
                                    <td class="text-center">
                                        <input type="file" id="fileEmployees" accept=".csv,.xlsx" style="display:none" onchange="handleFileUpload(this,'employees')">
                                        <button class="btn btn-sm btn-primary" onclick="document.getElementById('fileEmployees').click()">
                                            <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                        </button>
                                    </td>
                                </tr>
                                <tr id="fileRowAttendance">
                                    <td><i class="fas fa-calendar-check text-success me-2"></i><strong>attendance.csv</strong></td>
                                    <td><small class="text-muted">{{ 'Attendance records' if lang == 'en' else 'سجلات الحضور' }}</small></td>
                                    <td class="text-center"><span class="badge-status badge-info fileStatus">{{ 'Not uploaded' if lang == 'en' else 'غير مرفوع' }}</span></td>
                                    <td class="text-center">
                                        <input type="file" id="fileAttendance" accept=".csv,.xlsx" style="display:none" onchange="handleFileUpload(this,'attendance')">
                                        <button class="btn btn-sm btn-primary" onclick="document.getElementById('fileAttendance').click()">
                                            <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                        </button>
                                    </td>
                                </tr>
                                <tr id="fileRowPerformance">
                                    <td><i class="fas fa-star text-warning me-2"></i><strong>performance.csv</strong></td>
                                    <td><small class="text-muted">{{ 'Performance reviews' if lang == 'en' else 'تقييمات الأداء' }}</small></td>
                                    <td class="text-center"><span class="badge-status badge-info fileStatus">{{ 'Not uploaded' if lang == 'en' else 'غير مرفوع' }}</span></td>
                                    <td class="text-center">
                                        <input type="file" id="filePerformance" accept=".csv,.xlsx" style="display:none" onchange="handleFileUpload(this,'performance')">
                                        <button class="btn btn-sm btn-primary" onclick="document.getElementById('filePerformance').click()">
                                            <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                        </button>
                                    </td>
                                </tr>
                                <tr id="fileRowPayroll">
                                    <td><i class="fas fa-money-bill-wave text-info me-2"></i><strong>payroll.csv</strong></td>
                                    <td><small class="text-muted">{{ 'Payroll data' if lang == 'en' else 'بيانات الرواتب' }}</small></td>
                                    <td class="text-center"><span class="badge-status badge-info fileStatus">{{ 'Not uploaded' if lang == 'en' else 'غير مرفوع' }}</span></td>
                                    <td class="text-center">
                                        <input type="file" id="filePayroll" accept=".csv,.xlsx" style="display:none" onchange="handleFileUpload(this,'payroll')">
                                        <button class="btn btn-sm btn-primary" onclick="document.getElementById('filePayroll').click()">
                                            <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                        </button>
                                    </td>
                                </tr>
                                <tr id="fileRowResignations">
                                    <td><i class="fas fa-user-minus text-danger me-2"></i><strong>resignations.csv</strong></td>
                                    <td><small class="text-muted">{{ 'Resignation records' if lang == 'en' else 'سجلات الاستقالات' }}</small></td>
                                    <td class="text-center"><span class="badge-status badge-info fileStatus">{{ 'Not uploaded' if lang == 'en' else 'غير مرفوع' }}</span></td>
                                    <td class="text-center">
                                        <input type="file" id="fileResignations" accept=".csv,.xlsx" style="display:none" onchange="handleFileUpload(this,'resignations')">
                                        <button class="btn btn-sm btn-primary" onclick="document.getElementById('fileResignations').click()">
                                            <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-outline-secondary" onclick="goToImportStep(1)">
                        <i class="fas fa-arrow-{{ 'right' if lang == 'ar' else 'left' }} me-1"></i>{{ 'Previous' if lang == 'en' else 'السابق' }}
                    </button>
                    <button class="btn btn-success" onclick="processAllFiles()">
                        {{ 'Process & analyze' if lang == 'en' else 'معالجة وتحليل' }}
                        <i class="fas fa-arrow-{{ 'left' if lang == 'ar' else 'right' }} ms-1"></i>
                    </button>
                </div>
            </div>
        </section>

        <section id="section-processing" class="hr-section">
            <div class="processing-screen">
                <div class="processing-spinner"></div>
                <h4 class="fw-bold mb-3">{{ 'Processing your data...' if lang == 'en' else 'جاري معالجة البيانات...' }}</h4>
                <div class="processing-steps">
                    <div class="processing-step active">
                        <i class="fas fa-check-circle"></i>
                        <span>{{ 'Cleaning data...' if lang == 'en' else 'تنظيف البيانات...' }}</span>
                    </div>
                    <div class="processing-step">
                        <i class="fas fa-circle-notch fa-spin"></i>
                        <span>{{ 'Analyzing performance...' if lang == 'en' else 'تحليل الأداء...' }}</span>
                    </div>
                    <div class="processing-step">
                        <i class="fas fa-circle-notch"></i>
                        <span>{{ 'Calculating turnover risks...' if lang == 'en' else 'حساب احتمالات الاستقالة...' }}</span>
                    </div>
                    <div class="processing-step">
                        <i class="fas fa-circle-notch"></i>
                        <span>{{ 'Building payroll profile...' if lang == 'en' else 'بناء ملف الرواتب...' }}</span>
                    </div>
                    <div class="processing-step">
                        <i class="fas fa-circle-notch"></i>
                        <span>{{ 'Analyzing behavior patterns...' if lang == 'en' else 'تحليل السلوك...' }}</span>
                    </div>
                </div>
            </div>
        </section>

        <section id="section-dashboard" class="hr-section">
            <div class="page-header">
                <h1 class="page-title">{{ 'HR Dashboard' if lang == 'en' else 'لوحة القيادة' }}</h1>
                <p class="page-subtitle">{{ 'Full overview of your HR metrics' if lang == 'en' else 'نظرة شاملة على مؤشرات الموارد البشرية' }}</p>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-label">{{ 'Total employees' if lang == 'en' else 'إجمالي الموظفين' }}</div>
                            <div class="stat-value" id="kpiTotalEmployees">0</div>
                            <div class="stat-change positive">+5% {{ 'this month' if lang == 'en' else 'هذا الشهر' }}</div>
                        </div>
                        <div class="stat-icon blue">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-label">{{ 'Avg performance' if lang == 'en' else 'متوسط الأداء' }}</div>
                            <div class="stat-value" id="kpiAvgPerformance">0%</div>
                            <div class="stat-change positive">+2.5%</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-star"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-label">{{ 'Turnover rate' if lang == 'en' else 'معدل الاستقالات' }}</div>
                            <div class="stat-value" id="kpiTurnover">0%</div>
                            <div class="stat-change negative">-1.2%</div>
                        </div>
                        <div class="stat-icon red">
                            <i class="fas fa-arrow-right-from-bracket"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-label">{{ 'High risk' if lang == 'en' else 'مخاطر عالية' }}</div>
                            <div class="stat-value" id="kpiHighRisk">0</div>
                            <div class="stat-change negative">{{ 'employees' if lang == 'en' else 'موظف' }}</div>
                        </div>
                        <div class="stat-icon yellow">
                            <i class="fas fa-user-shield"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-bar"></i>
                            <span>{{ 'Turnover prediction' if lang == 'en' else 'توقع الاستقالات' }}</span>
                        </div>
                        <div class="chart-container">
                            <canvas id="turnoverChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-pie"></i>
                            <span>{{ 'Performance distribution' if lang == 'en' else 'توزيع الأداء' }}</span>
                        </div>
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-3">
                    <button class="btn btn-outline-primary w-100" onclick="showSection('employees')">
                        <i class="fas fa-users me-1"></i>{{ 'Employees' if lang == 'en' else 'الموظفون' }}
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-success w-100" onclick="showSection('performance')">
                        <i class="fas fa-star me-1"></i>{{ 'Performance' if lang == 'en' else 'الأداء' }}
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-warning w-100" onclick="showSection('turnover')">
                        <i class="fas fa-brain me-1"></i>{{ 'Turnover AI' if lang == 'en' else 'توقع الاستقالات' }}
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-info w-100" onclick="showSection('insights')">
                        <i class="fas fa-lightbulb me-1"></i>{{ 'AI insights' if lang == 'en' else 'التوصيات الذكية' }}
                    </button>
                </div>
            </div>
        </section>

        <section id="section-employees" class="hr-section">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
                <div>
                    <h1 class="page-title">{{ 'Employees Management' if lang == 'en' else 'إدارة الموظفين' }}</h1>
                    <p class="page-subtitle">{{ 'Complete employee database with AI signals' if lang == 'en' else 'قاعدة بيانات الموظفين مع مؤشرات ذكية' }}</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm" onclick="alert('Coming soon')">
                        <i class="fas fa-plus me-1"></i>{{ 'Add employee' if lang == 'en' else 'إضافة موظف' }}
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="showSection('import')">
                        <i class="fas fa-file-import me-1"></i>{{ 'Import CSV' if lang == 'en' else 'استيراد CSV' }}
                    </button>
                </div>
            </div>

            <div class="filter-bar">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label small text-muted">{{ 'Search' if lang == 'en' else 'بحث' }}</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" class="form-control" id="employeeSearch" placeholder="{{ 'Search by name, ID...' if lang == 'en' else 'البحث بالاسم أو الرقم...' }}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">{{ 'Department' if lang == 'en' else 'القسم' }}</label>
                        <select class="form-select form-select-sm" id="filterDepartment">
                            <option value="">{{ 'All' if lang == 'en' else 'الكل' }}</option>
                            <option value="IT">IT</option>
                            <option value="HR">HR</option>
                            <option value="Sales">Sales</option>
                            <option value="Finance">Finance</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">{{ 'Performance' if lang == 'en' else 'الأداء' }}</label>
                        <select class="form-select form-select-sm" id="filterPerformance">
                            <option value="">{{ 'All' if lang == 'en' else 'الكل' }}</option>
                            <option value="excellent">{{ 'Excellent' if lang == 'en' else 'ممتاز' }}</option>
                            <option value="good">{{ 'Good' if lang == 'en' else 'جيد' }}</option>
                            <option value="average">{{ 'Average' if lang == 'en' else 'متوسط' }}</option>
                            <option value="poor">{{ 'Poor' if lang == 'en' else 'ضعيف' }}</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">{{ 'Risk level' if lang == 'en' else 'مستوى المخاطر' }}</label>
                        <select class="form-select form-select-sm" id="filterRisk">
                            <option value="">{{ 'All' if lang == 'en' else 'الكل' }}</option>
                            <option value="high">{{ 'High' if lang == 'en' else 'مرتفع' }}</option>
                            <option value="medium">{{ 'Medium' if lang == 'en' else 'متوسط' }}</option>
                            <option value="low">{{ 'Low' if lang == 'en' else 'منخفض' }}</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                            <i class="fas fa-rotate-left me-1"></i>{{ 'Clear filters' if lang == 'en' else 'مسح الفلاتر' }}
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-users me-1 text-primary"></i>
                        {{ 'Employee list' if lang == 'en' else 'قائمة الموظفين' }}
                        <span class="badge bg-primary ms-1" id="employeeTotalBadge">0</span>
                    </h6>
                    <button class="btn btn-outline-primary btn-sm" onclick="exportEmployees()">
                        <i class="fas fa-download me-1"></i>{{ 'Export' if lang == 'en' else 'تصدير' }}
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>{{ 'Employee' if lang == 'en' else 'الموظف' }}</th>
                                <th>{{ 'Department' if lang == 'en' else 'القسم' }}</th>
                                <th>{{ 'Position' if lang == 'en' else 'المنصب' }}</th>
                                <th class="text-center">{{ 'Performance' if lang == 'en' else 'الأداء' }}</th>
                                <th class="text-center">{{ 'Attendance' if lang == 'en' else 'الانضباط' }}</th>
                                <th class="text-center">{{ 'Risk' if lang == 'en' else 'المخاطر' }}</th>
                                <th class="text-center">{{ 'Status' if lang == 'en' else 'الحالة' }}</th>
                                <th class="text-center">{{ 'Actions' if lang == 'en' else 'الإجراءات' }}</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody">
                            <tr>
                                <td colspan="8">
                                    <div class="empty-state">
                                        <i class="fas fa-users d-block"></i>
                                        <p class="mb-2">{{ 'No employees found. Please import data first.' if lang == 'en' else 'لا توجد بيانات موظفين. قم باستيراد البيانات أولاً.' }}</p>
                                        <button class="btn btn-primary btn-sm" onclick="showSection('import')">
                                            <i class="fas fa-upload me-1"></i>{{ 'Import data' if lang == 'en' else 'استيراد البيانات' }}
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted small">
                        {{ 'Showing' if lang == 'en' else 'عرض' }} <span id="showingCount">0</span>
                        {{ 'of' if lang == 'en' else 'من' }} <span id="totalCount">0</span>
                        {{ 'employees' if lang == 'en' else 'موظف' }}
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="employeesPagination">
                            <li class="page-item disabled"><a class="page-link" href="#">{{ 'Previous' if lang == 'en' else 'السابق' }}</a></li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item disabled"><a class="page-link" href="#">{{ 'Next' if lang == 'en' else 'التالي' }}</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </section>

        <section id="section-performance" class="hr-section">
            <div class="page-header">
                <h1 class="page-title">{{ 'Performance Analytics' if lang == 'en' else 'تحليل الأداء' }}</h1>
                <p class="page-subtitle">{{ 'Track and analyze employee performance' if lang == 'en' else 'تتبع وتحليل أداء الموظفين' }}</p>
            </div>
            <div class="card">
                <div class="empty-state">
                    <i class="fas fa-chart-line d-block"></i>
                    <p class="mb-0">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
                </div>
            </div>
        </section>

        <section id="section-attendance" class="hr-section">
            <div class="page-header">
                <h1 class="page-title">{{ 'Attendance Management' if lang == 'en' else 'إدارة الحضور' }}</h1>
                <p class="page-subtitle">{{ 'Track employee attendance and punctuality' if lang == 'en' else 'تتبع حضور الموظفين والالتزام' }}</p>
            </div>
            <div class="card">
                <div class="empty-state">
                    <i class="fas fa-calendar-check d-block"></i>
                    <p class="mb-0">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
                </div>
            </div>
        </section>

        <section id="section-payroll" class="hr-section">
            <div class="page-header">
                <h1 class="page-title">{{ 'Payroll Management' if lang == 'en' else 'إدارة الرواتب' }}</h1>
                <p class="page-subtitle">{{ 'Manage employee salaries and compensation' if lang == 'en' else 'إدارة رواتب الموظفين والتعويضات' }}</p>
            </div>
            <div class="card">
                <div class="empty-state">
                    <i class="fas fa-sack-dollar d-block"></i>
                    <p class="mb-0">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
                </div>
            </div>
        </section>

        <section id="section-resignations" class="hr-section">
            <div class="page-header">
                <h1 class="page-title">{{ 'Resignations' if lang == 'en' else 'الاستقالات' }}</h1>
                <p class="page-subtitle">{{ 'Track employee turnover and exit analysis' if lang == 'en' else 'تتبع دوران الموظفين وتحليل الخروج' }}</p>
            </div>
            <div class="card">
                <div class="empty-state">
                    <i class="fas fa-user-minus d-block"></i>
                    <p class="mb-0">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
                </div>
            </div>
        </section>

        <section id="section-turnover" class="hr-section">
            <div class="page-header">
                <h1 class="page-title">{{ 'Turnover Prediction' if lang == 'en' else 'توقع الاستقالات' }}</h1>
                <p class="page-subtitle">{{ 'AI-powered turnover risk analysis' if lang == 'en' else 'تحليل مخاطر الاستقالات بالذكاء الاصطناعي' }}</p>
            </div>
            <div class="card">
                <div class="empty-state">
                    <i class="fas fa-brain d-block"></i>
                    <p class="mb-0">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
                </div>
            </div>
        </section>

        <section id="section-insights" class="hr-section">
            <div class="page-header">
                <h1 class="page-title">{{ 'AI Insights' if lang == 'en' else 'التوصيات الذكية' }}</h1>
                <p class="page-subtitle">{{ 'Smart recommendations for HR decisions' if lang == 'en' else 'توصيات ذكية لقرارات الموارد البشرية' }}</p>
            </div>
            <div class="card">
                <div class="empty-state">
                    <i class="fas fa-wand-magic-sparkles d-block"></i>
                    <p class="mb-0">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
                </div>
            </div>
        </section>

        <section id="section-settings" class="hr-section">
            <div class="page-header">
                <h1 class="page-title">{{ 'Settings' if lang == 'en' else 'الإعدادات' }}</h1>
                <p class="page-subtitle">{{ 'Configure HR module settings' if lang == 'en' else 'ضبط إعدادات وحدة الموارد البشرية' }}</p>
            </div>
            <div class="card">
                <div class="empty-state">
                    <i class="fas fa-sliders d-block"></i>
                    <p class="mb-0">{{ 'Coming soon...' if lang == 'en' else 'قريباً...' }}</p>
                </div>
            </div>
        </section>
    </main>
</div>

<div class="modal fade" id="mappingModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ 'Column mapping' if lang == 'en' else 'مطابقة الأعمدة' }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="mappingForm"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'Cancel' if lang == 'en' else 'إلغاء' }}</button>
                <button type="button" class="btn btn-primary" onclick="applyMapping()">{{ 'Save & continue' if lang == 'en' else 'حفظ ومتابعة' }}</button>
            </div>
        </div>
    </div>
</div>

<script>
const lang = '{{ lang }}';
let currentImportId = null;
let currentFileType = null;
let currentHeaders = [];
let uploadedFilesCount = 0;

function showSection(name, el) {
    document.querySelectorAll('.hr-section').forEach(s => s.classList.remove('active'));
    const section = document.getElementById('section-' + name);
    if (section) section.classList.add('active');
    
    if (el) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('hrSidebar');
    const icon = document.getElementById('toggleIcon');
    const toggleBtn = document.getElementById('sidebarToggle');
    sidebar.classList.toggle('collapsed');
    
    const isCollapsed = sidebar.classList.contains('collapsed');
    if (isCollapsed) {
        icon.classList.replace('fa-chevron-left', 'fa-chevron-right');
    } else {
        icon.classList.replace('fa-chevron-right', 'fa-chevron-left');
    }
    
    toggleBtn.setAttribute('aria-expanded', !isCollapsed);
    localStorage.setItem('hrSidebarCollapsed', isCollapsed);
}

document.addEventListener('DOMContentLoaded', () => {
    const collapsed = localStorage.getItem('hrSidebarCollapsed') === 'true';
    if (collapsed) {
        const sidebar = document.getElementById('hrSidebar');
        const icon = document.getElementById('toggleIcon');
        const toggleBtn = document.getElementById('sidebarToggle');
        sidebar.classList.add('collapsed');
        icon.classList.replace('fa-chevron-left', 'fa-chevron-right');
        toggleBtn.setAttribute('aria-expanded', 'false');
    }
    loadEmployees();
});

function selectImportType(type) {
    if (type === 'csv') goToImportStep(2);
}

function goToImportStep(step) {
    document.querySelectorAll('.import-step').forEach(e => e.style.display = 'none');
    const target = document.getElementById('importStep' + step);
    if (target) target.style.display = 'block';
    
    for (let i = 1; i <= 3; i++) {
        const el = document.getElementById('wizardStep' + i);
        el.classList.remove('active', 'completed');
        if (i < step) el.classList.add('completed');
        if (i === step) el.classList.add('active');
    }
}

const requiredFields = {
    employees: ['employee_id','full_name','department','job_title','hire_date','base_salary'],
    attendance: ['employee_id','date','check_in','check_out','status'],
    performance: ['employee_id','review_period','review_date','overall_rating'],
    payroll: ['employee_id','month','year','net_salary'],
    resignations: ['employee_id','termination_type','termination_date']
};

const fieldLabels = {
    employee_id: lang === 'ar' ? 'رقم الموظف' : 'Employee ID',
    full_name: lang === 'ar' ? 'الاسم الكامل' : 'Full name',
    department: lang === 'ar' ? 'القسم' : 'Department',
    job_title: lang === 'ar' ? 'المسمى الوظيفي' : 'Job title',
    hire_date: lang === 'ar' ? 'تاريخ التعيين' : 'Hire date',
    base_salary: lang === 'ar' ? 'الراتب الأساسي' : 'Base salary',
    date: lang === 'ar' ? 'التاريخ' : 'Date',
    check_in: lang === 'ar' ? 'وقت الحضور' : 'Check in',
    check_out: lang === 'ar' ? 'وقت الانصراف' : 'Check out',
    status: lang === 'ar' ? 'الحالة' : 'Status',
    review_period: lang === 'ar' ? 'فترة التقييم' : 'Review period',
    review_date: lang === 'ar' ? 'تاريخ التقييم' : 'Review date',
    overall_rating: lang === 'ar' ? 'التقييم العام' : 'Overall rating',
    month: lang === 'ar' ? 'الشهر' : 'Month',
    year: lang === 'ar' ? 'السنة' : 'Year',
    net_salary: lang === 'ar' ? 'صافي الراتب' : 'Net salary',
    termination_type: lang === 'ar' ? 'نوع إنهاء الخدمة' : 'Termination type',
    termination_date: lang === 'ar' ? 'تاريخ إنهاء الخدمة' : 'Termination date'
};

async function handleFileUpload(input, fileType) {
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('file_type', fileType);

    try {
        const res = await fetch('/erp/hr/api/import', { method: 'POST', body: formData });
        const data = await res.json();

        if (data.success) {
            currentImportId = data.import_id;
            currentFileType = fileType;
            currentHeaders = data.headers;

            const row = document.getElementById('fileRow' + fileType.charAt(0).toUpperCase() + fileType.slice(1));
            if (row) {
                const badge = row.querySelector('.fileStatus');
                badge.className = 'badge-status badge-success';
                badge.innerHTML = '<i class="fas fa-check me-1"></i>' + (lang === 'ar' ? 'مرفوع' : 'Uploaded');
            }

            uploadedFilesCount++;
            updateHomeProgress();

            await Swal.fire({
                icon: 'success',
                title: lang === 'ar' ? 'تم رفع الملف!' : 'File uploaded!',
                text: (lang === 'ar' ? 'تم اكتشاف ' : 'Found ') + (data.total_rows || 0) + (lang === 'ar' ? ' صف' : ' rows'),
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
            });

            showMappingModal(data.headers, data.sample_rows || [], fileType);
        } else {
            await Swal.fire({
                icon: 'error',
                title: lang === 'ar' ? 'خطأ' : 'Error',
                text: data.error || (lang === 'ar' ? 'حدث خطأ أثناء رفع الملف' : 'Error uploading file'),
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
            });
        }
    } catch (err) {
        console.error(err);
        await Swal.fire({
            icon: 'error',
            title: lang === 'ar' ? 'خطأ' : 'Error',
            text: lang === 'ar' ? 'تعذر الاتصال بالخادم' : 'Failed to contact server',
            confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
        });
    } finally {
        input.value = '';
    }
}

function showMappingModal(headers, sampleRows, fileType) {
    const fields = requiredFields[fileType] || [];
    let html = '<div class="row g-3">';
    fields.forEach(field => {
        const label = fieldLabels[field] || field;
        const match = headers.find(h => h.toLowerCase().includes(field.replace('_',''))) || '';
        html += `
        <div class="col-md-6">
            <label class="form-label fw-semibold">${label}</label>
            <select class="form-select form-select-sm mapping-select" data-field="${field}">
                <option value="">-- ${lang === 'ar' ? 'اختر العمود' : 'Select column'} --</option>
                ${headers.map(h => `<option value="${h}" ${h === match ? 'selected':''}>${h}</option>`).join('')}
            </select>
        </div>`;
    });
    html += '</div>';

    if (sampleRows.length > 0) {
        html += `
        <div class="mt-4">
            <h6 class="fw-bold mb-2"><i class="fas fa-eye me-1"></i>${lang === 'ar' ? 'معاينة البيانات' : 'Data preview'}</h6>
            <div class="table-responsive" style="max-height:250px;">
                <table class="table table-sm table-bordered">
                    <thead class="table-light"><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                    <tbody>${sampleRows.slice(0,5).map(r => `<tr>${headers.map(h => `<td>${r[h] ?? '-'}</td>`).join('')}</tr>`).join('')}</tbody>
                </table>
            </div>
        </div>`;
    }

    document.getElementById('mappingForm').innerHTML = html;
    new bootstrap.Modal(document.getElementById('mappingModal')).show();
}

async function applyMapping() {
    const mapping = {};
    document.querySelectorAll('.mapping-select').forEach(sel => {
        if (sel.value) mapping[sel.dataset.field] = sel.value;
    });

    try {
        Swal.fire({ title: lang === 'ar' ? 'جاري الاستيراد...' : 'Importing...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const mapRes = await fetch(`/erp/hr/api/import/${currentImportId}/map`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ mapping })
        });
        const mapData = await mapRes.json();
        if (!mapData.success) {
            Swal.close();
            await Swal.fire({ icon: 'error', title: lang === 'ar' ? 'خطأ' : 'Error', text: mapData.error });
            return;
        }

        const processRes = await fetch(`/erp/hr/api/import/${currentImportId}/process`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'}
        });
        const processData = await processRes.json();
        Swal.close();

        if (processData.success) {
            bootstrap.Modal.getInstance(document.getElementById('mappingModal')).hide();
            await Swal.fire({
                icon: 'success',
                title: lang === 'ar' ? 'نجح' : 'Success',
                text: (lang === 'ar' ? 'تم استيراد ' : 'Imported ') + (processData.imported || 0) + (lang === 'ar' ? ' سجل' : ' records')
            });
            loadEmployees();
        } else {
            await Swal.fire({ icon: 'error', title: lang === 'ar' ? 'خطأ' : 'Error', text: processData.error });
        }
    } catch (err) {
        Swal.close();
        console.error(err);
        await Swal.fire({ icon: 'error', title: lang === 'ar' ? 'خطأ' : 'Error', text: err.message });
    }
}

function updateHomeProgress() {
    const total = 5;
    const percent = (uploadedFilesCount / total) * 100;
    document.getElementById('homeFilesCount').textContent = `${uploadedFilesCount}/${total}`;
    document.getElementById('homeFilesProgress').style.width = `${percent}%`;
}

async function processAllFiles() {
    showSection('processing');
    const steps = document.querySelectorAll('.processing-step');
    for (let i = 0; i < steps.length; i++) {
        steps[i].classList.add('active');
        steps[i].querySelector('i').className = 'fas fa-check-circle';
        await new Promise(r => setTimeout(r, 1000));
    }

    await Swal.fire({
        icon: 'success',
        title: lang === 'ar' ? 'تم التحليل' : 'Analysis complete',
        text: lang === 'ar' ? 'تم تحليل البيانات بنجاح' : 'Data analyzed successfully',
        confirmButtonText: lang === 'ar' ? 'عرض لوحة القيادة' : 'View dashboard'
    });
    showSection('dashboard');
}

function downloadTemplate() {
    Swal.fire({
        icon: 'info',
        title: lang === 'ar' ? 'قريباً' : 'Coming soon',
        text: lang === 'ar' ? 'ستتوفر قوالب جاهزة قريباً' : 'Templates will be available soon'
    });
}

function clearFilters() {
    document.getElementById('employeeSearch').value = '';
    document.getElementById('filterDepartment').value = '';
    document.getElementById('filterPerformance').value = '';
    document.getElementById('filterRisk').value = '';
    loadEmployees();
}

async function loadEmployees() {
    try {
        const res = await fetch('/erp/hr/api/employees');
        const data = await res.json();
        if (data.success && data.employees) {
            renderEmployeesTable(data.employees);
            const count = data.employees.length;
            document.getElementById('employeeTotalBadge').textContent = count;
            document.getElementById('totalCount').textContent = count;
            document.getElementById('showingCount').textContent = count;
            document.getElementById('employeesCount').textContent = count;
            document.getElementById('sidebarEmpCount').textContent = count;
        }
    } catch (err) {
        console.error('Error loading employees', err);
    }
}

function renderEmployeesTable(employees) {
    const tbody = document.getElementById('employeesTableBody');
    if (!employees || employees.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8">
                    <div class="empty-state">
                        <i class="fas fa-users d-block"></i>
                        <p>${lang === 'ar' ? 'لا توجد بيانات موظفين' : 'No employees data'}</p>
                    </div>
                </td>
            </tr>`;
        return;
    }

    tbody.innerHTML = employees.map(emp => `
        <tr>
            <td>
                <div class="d-flex align-items-center gap-2">
                    <div class="avatar">${(emp.full_name || 'U').charAt(0)}</div>
                    <div>
                        <div class="fw-semibold">${emp.full_name || 'N/A'}</div>
                        <small class="text-muted">ID: ${emp.employee_id || 'N/A'}</small>
                    </div>
                </div>
            </td>
            <td>${emp.department || 'N/A'}</td>
            <td>${emp.job_title || 'N/A'}</td>
            <td class="text-center">
                <div class="progress" style="height:6px; width:60px; margin:0 auto;">
                    <div class="progress-bar bg-success" style="width:85%;"></div>
                </div>
                <small class="text-muted">85%</small>
            </td>
            <td class="text-center">
                <div class="progress" style="height:6px; width:60px; margin:0 auto;">
                    <div class="progress-bar bg-success" style="width:92%;"></div>
                </div>
                <small class="text-muted">92%</small>
            </td>
            <td class="text-center"><span class="badge-status badge-success">${lang === 'ar' ? 'منخفض' : 'Low'}</span></td>
            <td class="text-center"><span class="badge-status badge-success">${lang === 'ar' ? 'نشط' : 'Active'}</span></td>
            <td class="text-center">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewEmployeeProfile(${emp.id})" title="${lang === 'ar' ? 'عرض' : 'View'}"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-outline-success" onclick="analyzeEmployee(${emp.id})" title="${lang === 'ar' ? 'تحليل' : 'Analyze'}"><i class="fas fa-brain"></i></button>
                </div>
            </td>
        </tr>
    `).join('');
}

function viewEmployeeProfile(id) {
    Swal.fire({ icon: 'info', title: lang === 'ar' ? 'قريباً' : 'Coming soon', text: lang === 'ar' ? 'سيتم فتح ملف الموظف قريباً' : 'Employee profile coming soon' });
}

function analyzeEmployee(id) {
    Swal.fire({ icon: 'info', title: lang === 'ar' ? 'قريباً' : 'Coming soon', text: lang === 'ar' ? 'تحليل الذكاء الاصطناعي قريباً' : 'AI analysis coming soon' });
}

function exportEmployees() {
    Swal.fire({ icon: 'info', title: lang === 'ar' ? 'قريباً' : 'Coming soon', text: lang === 'ar' ? 'سيتم دعم التصدير قريباً' : 'Export coming soon' });
}

window.addEventListener('load', () => {
    const turnoverCtx = document.getElementById('turnoverChart');
    if (turnoverCtx) {
        new Chart(turnoverCtx, {
            type: 'bar',
            data: {
                labels: lang === 'ar' ? ['يناير','فبراير','مارس','أبريل','مايو','يونيو'] : ['Jan','Feb','Mar','Apr','May','Jun'],
                datasets: [{
                    label: lang === 'ar' ? 'معدل الاستقالات' : 'Turnover rate',
                    data: [12,15,10,18,14,16],
                    backgroundColor: '#2563eb'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    const performanceCtx = document.getElementById('performanceChart');
    if (performanceCtx) {
        new Chart(performanceCtx, {
            type: 'doughnut',
            data: {
                labels: lang === 'ar' ? ['ممتاز','جيد','متوسط','ضعيف'] : ['Excellent','Good','Average','Poor'],
                datasets: [{
                    data: [30,45,20,5],
                    backgroundColor: ['#10b981','#2563eb','#f59e0b','#ef4444']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
});
</script>
{% endblock %}
