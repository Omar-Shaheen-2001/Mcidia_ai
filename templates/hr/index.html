{% extends "base.html" %}

{% block title %}{{ 'HR AI Engine' if lang == 'en' else 'محرك الموارد البشرية الذكي' }} - Mcidia{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div>
                    <h2 class="fw-bold mb-1">
                        <i class="fas fa-brain text-primary me-2"></i>
                        {{ 'HR Intelligence' if lang == 'en' else 'ذكاء الموارد البشرية' }}
                    </h2>
                    <p class="text-muted mb-0">
                        {{ 'AI-powered HR analytics and management' if lang == 'en' else 'تحليلات وإدارة الموارد البشرية المدعومة بالذكاء الاصطناعي' }}
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-lg" onclick="showImportModal()">
                        <i class="fas fa-file-import me-2"></i>
                        {{ 'Import HR Data' if lang == 'en' else 'استيراد البيانات' }}
                    </button>
                    <button class="btn btn-outline-primary btn-lg" onclick="toggleReportsHistory()">
                        <i class="fas fa-history me-2"></i>
                        {{ 'Reports History' if lang == 'en' else 'سجل التحليلات' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient py-3" style="background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-database me-2"></i>
                        {{ 'HR Data Status' if lang == 'en' else 'حالة بيانات الموارد البشرية' }}
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="px-4 py-3" style="width: 25%;">{{ 'Data Type' if lang == 'en' else 'نوع البيانات' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Status' if lang == 'en' else 'الحالة' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Records' if lang == 'en' else 'السجلات' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Last Update' if lang == 'en' else 'آخر تحديث' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Source' if lang == 'en' else 'المصدر' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Actions' if lang == 'en' else 'الإجراءات' }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="fas fa-users text-primary me-2"></i>
                                        <strong>{{ 'Employees' if lang == 'en' else 'الموظفون' }}</strong>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.employees.available %}
                                        <span class="badge bg-success-subtle text-success px-3 py-2">
                                            <i class="fas fa-check-circle me-1"></i>{{ 'Available' if lang == 'en' else 'متوفر' }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger-subtle text-danger px-3 py-2">
                                            <i class="fas fa-times-circle me-1"></i>{{ 'Not Available' if lang == 'en' else 'غير متوفر' }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="fw-semibold">{{ data_status.employees.count or 0 }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center text-muted">
                                        {% if data_status.employees.last_update %}
                                        {{ data_status.employees.last_update.strftime('%Y-%m-%d') }}
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.employees.source %}
                                        <span class="badge bg-info-subtle text-info">{{ data_status.employees.source }}</span>
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center" id="actions-employees">
                                        —
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="fas fa-clock text-warning me-2"></i>
                                        <strong>{{ 'Attendance' if lang == 'en' else 'الحضور والانصراف' }}</strong>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.attendance.available %}
                                        <span class="badge bg-success-subtle text-success px-3 py-2">
                                            <i class="fas fa-check-circle me-1"></i>{{ 'Available' if lang == 'en' else 'متوفر' }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger-subtle text-danger px-3 py-2">
                                            <i class="fas fa-times-circle me-1"></i>{{ 'Not Available' if lang == 'en' else 'غير متوفر' }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="fw-semibold">{{ data_status.attendance.count or 0 }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center text-muted">
                                        {% if data_status.attendance.last_update %}
                                        {{ data_status.attendance.last_update.strftime('%Y-%m-%d') }}
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.attendance.source %}
                                        <span class="badge bg-info-subtle text-info">{{ data_status.attendance.source }}</span>
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center" id="actions-attendance">
                                        —
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="fas fa-chart-line text-success me-2"></i>
                                        <strong>{{ 'Performance' if lang == 'en' else 'الأداء' }}</strong>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.performance.available %}
                                        <span class="badge bg-success-subtle text-success px-3 py-2">
                                            <i class="fas fa-check-circle me-1"></i>{{ 'Available' if lang == 'en' else 'متوفر' }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger-subtle text-danger px-3 py-2">
                                            <i class="fas fa-times-circle me-1"></i>{{ 'Not Available' if lang == 'en' else 'غير متوفر' }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="fw-semibold">{{ data_status.performance.count or 0 }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center text-muted">
                                        {% if data_status.performance.last_update %}
                                        {{ data_status.performance.last_update.strftime('%Y-%m-%d') }}
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.performance.source %}
                                        <span class="badge bg-info-subtle text-info">{{ data_status.performance.source }}</span>
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center" id="actions-performance">
                                        —
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="fas fa-money-bill-wave text-info me-2"></i>
                                        <strong>{{ 'Payroll' if lang == 'en' else 'الرواتب' }}</strong>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.payroll.available %}
                                        <span class="badge bg-success-subtle text-success px-3 py-2">
                                            <i class="fas fa-check-circle me-1"></i>{{ 'Available' if lang == 'en' else 'متوفر' }}
                                        </span>
                                        {% elif data_status.payroll.count > 0 %}
                                        <span class="badge bg-warning-subtle text-warning px-3 py-2">
                                            <i class="fas fa-exclamation-triangle me-1"></i>{{ 'Needs Update' if lang == 'en' else 'يحتاج تحديث' }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger-subtle text-danger px-3 py-2">
                                            <i class="fas fa-times-circle me-1"></i>{{ 'Not Available' if lang == 'en' else 'غير متوفر' }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="fw-semibold">{{ data_status.payroll.count or 0 }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center text-muted">
                                        {% if data_status.payroll.last_update %}
                                        {{ data_status.payroll.last_update.strftime('%Y-%m-%d') }}
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.payroll.source %}
                                        <span class="badge bg-info-subtle text-info">{{ data_status.payroll.source }}</span>
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center" id="actions-payroll">
                                        —
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="fas fa-user-minus text-danger me-2"></i>
                                        <strong>{{ 'Resignations' if lang == 'en' else 'الاستقالات' }}</strong>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.resignations.available %}
                                        <span class="badge bg-success-subtle text-success px-3 py-2">
                                            <i class="fas fa-check-circle me-1"></i>{{ 'Available' if lang == 'en' else 'متوفر' }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger-subtle text-danger px-3 py-2">
                                            <i class="fas fa-times-circle me-1"></i>{{ 'Not Available' if lang == 'en' else 'غير متوفر' }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="fw-semibold">{{ data_status.resignations.count or 0 }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center text-muted">
                                        {% if data_status.resignations.last_update %}
                                        {{ data_status.resignations.last_update.strftime('%Y-%m-%d') }}
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.resignations.source %}
                                        <span class="badge bg-info-subtle text-info">{{ data_status.resignations.source }}</span>
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center" id="actions-resignations">
                                        —
                                    </td>
                                </tr>
                                
                                <tr class="table-light">
                                    <td class="px-4 py-3">
                                        <i class="fas fa-plug text-secondary me-2"></i>
                                        <strong>{{ 'ERP Integration' if lang == 'en' else 'تكامل ERP' }}</strong>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.erp_integration.connected %}
                                        <span class="badge bg-success-subtle text-success px-3 py-2">
                                            <i class="fas fa-link me-1"></i>{{ 'Connected' if lang == 'en' else 'متصل' }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary-subtle text-secondary px-3 py-2">
                                            <i class="fas fa-unlink me-1"></i>{{ 'Not Connected' if lang == 'en' else 'غير متصل' }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.erp_integration.erp_type %}
                                        <span class="text-uppercase fw-semibold">{{ data_status.erp_integration.erp_type }}</span>
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center text-muted">
                                        {% if data_status.erp_integration.last_sync %}
                                        {{ data_status.erp_integration.last_sync.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if data_status.erp_integration.connected %}
                                        <span class="badge bg-primary-subtle text-primary">API / DB</span>
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        —
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0" id="analyzeCard">
                <div class="card-body text-center py-5">
                    <i class="fas fa-chart-pie fa-4x text-primary mb-4"></i>
                    <h4>{{ 'Analyze HR Data' if lang == 'en' else 'تحليل بيانات الموارد البشرية' }}</h4>
                    <p class="text-muted mb-4">
                        {{ 'Import your HR data first to unlock AI-powered analytics and insights' if lang == 'en' else 'قم باستيراد بيانات الموارد البشرية أولاً لتفعيل التحليلات والرؤى المدعومة بالذكاء الاصطناعي' }}
                    </p>
                    <button class="btn btn-primary btn-lg" onclick="analyzeHRData()">
                        <i class="fas fa-magic me-2"></i>
                        {{ 'Analyze HR Data' if lang == 'en' else 'تحليل البيانات' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4" id="reportsHistorySection">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient py-3" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-history me-2"></i>
                        {{ 'Analysis History' if lang == 'en' else 'سجل التحليلات' }}
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="px-4 py-3">{{ 'Date' if lang == 'en' else 'التاريخ' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Total Employees' if lang == 'en' else 'إجمالي الموظفين' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Active' if lang == 'en' else 'نشطون' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Avg Salary' if lang == 'en' else 'متوسط الراتب' }}</th>
                                    <th class="px-4 py-3 text-center">{{ 'Actions' if lang == 'en' else 'الإجراءات' }}</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4" id="employeesPreviewSection" style="display:none;">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient py-3" style="background: linear-gradient(135deg, #198754 0%, #15654b 100%);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-users me-2"></i>
                        {{ 'Imported Employees Preview' if lang == 'en' else 'معاينة الموظفين المستوردين' }}
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="employeesTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="px-4 py-3">{{ 'Employee Number' if lang == 'en' else 'رقم الموظف' }}</th>
                                    <th class="px-4 py-3">{{ 'Full Name' if lang == 'en' else 'الاسم الكامل' }}</th>
                                    <th class="px-4 py-3">{{ 'Department' if lang == 'en' else 'القسم' }}</th>
                                    <th class="px-4 py-3">{{ 'Job Title' if lang == 'en' else 'المسمى الوظيفي' }}</th>
                                    <th class="px-4 py-3">{{ 'Status' if lang == 'en' else 'الحالة' }}</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4" id="analyticsSection" style="display:none;">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light py-3">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-pie-chart text-primary me-2"></i>
                        {{ 'Employees by Department' if lang == 'en' else 'الموظفون حسب القسم' }}
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="departmentChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light py-3">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-doughnut text-success me-2"></i>
                        {{ 'Active vs Inactive' if lang == 'en' else 'نشطون مقابل غير نشطين' }}
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="statsSection" style="display:none;">
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm border-0 text-center py-4">
                <i class="fas fa-users fa-2x text-primary mb-3"></i>
                <h6 class="text-muted">{{ 'Total Employees' if lang == 'en' else 'إجمالي الموظفين' }}</h6>
                <h2 class="fw-bold" id="totalEmployees">0</h2>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm border-0 text-center py-4">
                <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                <h6 class="text-muted">{{ 'Active' if lang == 'en' else 'نشطون' }}</h6>
                <h2 class="fw-bold text-success" id="activeEmployees">0</h2>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm border-0 text-center py-4">
                <i class="fas fa-ban fa-2x text-danger mb-3"></i>
                <h6 class="text-muted">{{ 'Inactive' if lang == 'en' else 'غير نشطين' }}</h6>
                <h2 class="fw-bold text-danger" id="inactiveEmployees">0</h2>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm border-0 text-center py-4">
                <i class="fas fa-money-bill fa-2x text-info mb-3"></i>
                <h6 class="text-muted">{{ 'Avg Salary' if lang == 'en' else 'متوسط الراتب' }}</h6>
                <h2 class="fw-bold text-info" id="avgSalary">0</h2>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h4 class="modal-title" id="importModalLabel">
                    <i class="fas fa-file-import text-primary me-2"></i>
                    {{ 'Import HR Data' if lang == 'en' else 'استيراد بيانات الموارد البشرية' }}
                </h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-pills nav-fill mb-4" id="importTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active py-3" id="csv-tab" data-bs-toggle="pill" data-bs-target="#csv-upload" type="button" role="tab">
                            <i class="fas fa-file-csv fa-lg mb-2 d-block"></i>
                            <span class="fw-semibold">{{ 'Upload CSV / Excel' if lang == 'en' else 'رفع ملفات CSV / Excel' }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link py-3" id="erp-tab" data-bs-toggle="pill" data-bs-target="#erp-connect" type="button" role="tab">
                            <i class="fas fa-plug fa-lg mb-2 d-block"></i>
                            <span class="fw-semibold">{{ 'Connect to ERP System' if lang == 'en' else 'الاتصال بنظام ERP' }}</span>
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="importTabsContent">
                    <div class="tab-pane fade show active" id="csv-upload" role="tabpanel">
                        <div class="alert alert-info d-flex align-items-start mb-4">
                            <i class="fas fa-info-circle me-3 mt-1"></i>
                            <div>
                                <strong>{{ 'Instructions:' if lang == 'en' else 'التعليمات:' }}</strong>
                                {{ 'Download the template for each data type, fill it with your data, then upload. The system will automatically map columns.' if lang == 'en' else 'قم بتحميل القالب لكل نوع بيانات، املأه ببياناتك، ثم ارفعه. سيقوم النظام بمطابقة الأعمدة تلقائياً.' }}
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>{{ 'Required File' if lang == 'en' else 'الملف المطلوب' }}</th>
                                        <th>{{ 'Description' if lang == 'en' else 'الوصف' }}</th>
                                        <th class="text-center">{{ 'Template' if lang == 'en' else 'القالب' }}</th>
                                        <th class="text-center">{{ 'Status' if lang == 'en' else 'الحالة' }}</th>
                                        <th class="text-center">{{ 'Action' if lang == 'en' else 'إجراء' }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <i class="fas fa-users text-primary me-2"></i>
                                            <strong>employees.csv</strong>
                                        </td>
                                        <td class="text-muted">{{ 'Employee list with basic info' if lang == 'en' else 'قائمة الموظفين مع المعلومات الأساسية' }}</td>
                                        <td class="text-center">
                                            <a href="{{ url_for('hr.download_template', file_type='employees') }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download me-1"></i>{{ 'Download' if lang == 'en' else 'تحميل' }}
                                            </a>
                                        </td>
                                        <td class="text-center" id="status-employees">
                                            {% if data_status.employees.available %}
                                            <span class="badge bg-success">{{ 'Uploaded' if lang == 'en' else 'مرفوع' }}</span>
                                            {% else %}
                                            <span class="badge bg-danger">{{ 'Missing' if lang == 'en' else 'مفقود' }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <label class="btn btn-sm btn-primary">
                                                <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                                <input type="file" class="d-none" accept=".csv,.xlsx,.xls" onchange="uploadFile(this, 'employees')">
                                            </label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <i class="fas fa-clock text-warning me-2"></i>
                                            <strong>attendance.csv</strong>
                                        </td>
                                        <td class="text-muted">{{ 'Check-in/out records' if lang == 'en' else 'سجلات الحضور والانصراف' }}</td>
                                        <td class="text-center">
                                            <a href="{{ url_for('hr.download_template', file_type='attendance') }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download me-1"></i>{{ 'Download' if lang == 'en' else 'تحميل' }}
                                            </a>
                                        </td>
                                        <td class="text-center" id="status-attendance">
                                            {% if data_status.attendance.available %}
                                            <span class="badge bg-success">{{ 'Uploaded' if lang == 'en' else 'مرفوع' }}</span>
                                            {% else %}
                                            <span class="badge bg-danger">{{ 'Missing' if lang == 'en' else 'مفقود' }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <label class="btn btn-sm btn-primary">
                                                <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                                <input type="file" class="d-none" accept=".csv,.xlsx,.xls" onchange="uploadFile(this, 'attendance')">
                                            </label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <i class="fas fa-chart-line text-success me-2"></i>
                                            <strong>performance.csv</strong>
                                        </td>
                                        <td class="text-muted">{{ 'Performance evaluations' if lang == 'en' else 'تقييمات الأداء' }}</td>
                                        <td class="text-center">
                                            <a href="{{ url_for('hr.download_template', file_type='performance') }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download me-1"></i>{{ 'Download' if lang == 'en' else 'تحميل' }}
                                            </a>
                                        </td>
                                        <td class="text-center" id="status-performance">
                                            {% if data_status.performance.available %}
                                            <span class="badge bg-success">{{ 'Uploaded' if lang == 'en' else 'مرفوع' }}</span>
                                            {% else %}
                                            <span class="badge bg-danger">{{ 'Missing' if lang == 'en' else 'مفقود' }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <label class="btn btn-sm btn-primary">
                                                <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                                <input type="file" class="d-none" accept=".csv,.xlsx,.xls" onchange="uploadFile(this, 'performance')">
                                            </label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <i class="fas fa-money-bill-wave text-info me-2"></i>
                                            <strong>payroll.csv</strong>
                                        </td>
                                        <td class="text-muted">{{ 'Salary and payroll data' if lang == 'en' else 'بيانات الرواتب' }}</td>
                                        <td class="text-center">
                                            <a href="{{ url_for('hr.download_template', file_type='payroll') }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download me-1"></i>{{ 'Download' if lang == 'en' else 'تحميل' }}
                                            </a>
                                        </td>
                                        <td class="text-center" id="status-payroll">
                                            {% if data_status.payroll.available %}
                                            <span class="badge bg-success">{{ 'Uploaded' if lang == 'en' else 'مرفوع' }}</span>
                                            {% else %}
                                            <span class="badge bg-danger">{{ 'Missing' if lang == 'en' else 'مفقود' }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <label class="btn btn-sm btn-primary">
                                                <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                                <input type="file" class="d-none" accept=".csv,.xlsx,.xls" onchange="uploadFile(this, 'payroll')">
                                            </label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <i class="fas fa-user-minus text-danger me-2"></i>
                                            <strong>resignations.csv</strong>
                                        </td>
                                        <td class="text-muted">{{ 'Employee resignations/terminations' if lang == 'en' else 'استقالات وإنهاء الخدمة' }}</td>
                                        <td class="text-center">
                                            <a href="{{ url_for('hr.download_template', file_type='resignations') }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download me-1"></i>{{ 'Download' if lang == 'en' else 'تحميل' }}
                                            </a>
                                        </td>
                                        <td class="text-center" id="status-resignations">
                                            {% if data_status.resignations.available %}
                                            <span class="badge bg-success">{{ 'Uploaded' if lang == 'en' else 'مرفوع' }}</span>
                                            {% else %}
                                            <span class="badge bg-danger">{{ 'Missing' if lang == 'en' else 'مفقود' }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <label class="btn btn-sm btn-primary">
                                                <i class="fas fa-upload me-1"></i>{{ 'Upload' if lang == 'en' else 'رفع' }}
                                                <input type="file" class="d-none" accept=".csv,.xlsx,.xls" onchange="uploadFile(this, 'resignations')">
                                            </label>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="erp-connect" role="tabpanel">
                        <div class="row justify-content-center">
                            <div class="col-lg-8">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-gradient text-white py-3" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
                                        <h5 class="mb-0">
                                            <i class="fas fa-link me-2"></i>
                                            {{ 'Connect to External ERP System' if lang == 'en' else 'الاتصال بنظام ERP خارجي' }}
                                        </h5>
                                    </div>
                                    <div class="card-body p-4">
                                        <form id="erpConnectForm">
                                            <div class="mb-4">
                                                <label class="form-label fw-semibold">
                                                    <i class="fas fa-building me-1"></i>
                                                    {{ 'ERP System Type' if lang == 'en' else 'نوع نظام ERP' }}
                                                </label>
                                                <select class="form-select form-select-lg" id="erpType" name="erp_type" required>
                                                    <option value="">{{ 'Select ERP System...' if lang == 'en' else 'اختر نظام ERP...' }}</option>
                                                    <option value="odoo">Odoo</option>
                                                    <option value="sap">SAP</option>
                                                    <option value="zoho">Zoho People</option>
                                                    <option value="oracle">Oracle HCM</option>
                                                    <option value="dynamics">Microsoft Dynamics 365</option>
                                                    <option value="other">{{ 'Other' if lang == 'en' else 'آخر' }}</option>
                                                </select>
                                            </div>

                                            <div class="mb-4">
                                                <label class="form-label fw-semibold">
                                                    <i class="fas fa-globe me-1"></i>
                                                    {{ 'API Base URL' if lang == 'en' else 'عنوان API' }}
                                                </label>
                                                <input type="url" class="form-control form-control-lg" id="apiUrl" name="api_url" 
                                                       placeholder="https://your-erp-domain.com/api" required>
                                            </div>

                                            <div class="mb-4">
                                                <label class="form-label fw-semibold">
                                                    <i class="fas fa-key me-1"></i>
                                                    {{ 'API Key / Token' if lang == 'en' else 'مفتاح API' }}
                                                </label>
                                                <input type="password" class="form-control form-control-lg" id="apiKey" name="api_key" 
                                                       placeholder="{{ 'Enter your API key or access token' if lang == 'en' else 'أدخل مفتاح API أو رمز الوصول' }}">
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-4">
                                                    <label class="form-label fw-semibold">
                                                        <i class="fas fa-id-badge me-1"></i>
                                                        {{ 'Company ID' if lang == 'en' else 'معرف الشركة' }}
                                                    </label>
                                                    <input type="text" class="form-control" id="companyId" name="company_id" 
                                                           placeholder="{{ 'If applicable' if lang == 'en' else 'إن وجد' }}">
                                                </div>
                                                <div class="col-md-6 mb-4">
                                                    <label class="form-label fw-semibold">
                                                        <i class="fas fa-user me-1"></i>
                                                        {{ 'Client ID / User' if lang == 'en' else 'معرف العميل' }}
                                                    </label>
                                                    <input type="text" class="form-control" id="clientId" name="client_id"
                                                           placeholder="{{ 'If applicable' if lang == 'en' else 'إن وجد' }}">
                                                </div>
                                            </div>

                                            <div class="d-grid gap-2">
                                                <button type="submit" class="btn btn-primary btn-lg">
                                                    <i class="fas fa-plug me-2"></i>
                                                    {{ 'Connect Now' if lang == 'en' else 'اتصل الآن' }}
                                                </button>
                                            </div>
                                        </form>

                                        <div id="erpConnectionStatus" class="mt-4" style="display: none;">
                                            <div class="alert alert-success d-flex align-items-center">
                                                <i class="fas fa-check-circle fa-2x me-3"></i>
                                                <div>
                                                    <strong>{{ 'Connected Successfully!' if lang == 'en' else 'تم الاتصال بنجاح!' }}</strong>
                                                    <p class="mb-0" id="erpConnectionMessage"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {{ 'Close' if lang == 'en' else 'إغلاق' }}
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mappingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-columns text-primary me-2"></i>
                    {{ 'Column Mapping' if lang == 'en' else 'مطابقة الأعمدة' }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    {{ 'Match your CSV columns to the required fields. Some columns may be auto-detected.' if lang == 'en' else 'قم بمطابقة أعمدة ملف CSV مع الحقول المطلوبة. قد يتم اكتشاف بعض الأعمدة تلقائياً.' }}
                </div>
                <div id="mappingForm">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'Cancel' if lang == 'en' else 'إلغاء' }}</button>
                <button type="button" class="btn btn-primary" onclick="applyMapping()">
                    <i class="fas fa-check me-2"></i>{{ 'Apply & Import' if lang == 'en' else 'تطبيق واستيراد' }}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentImportId = null;
let currentFileType = null;
let currentHeaders = [];

const lang = '{{ lang }}';

const requiredFields = {
    'employees': ['employee_number', 'full_name', 'department', 'job_title', 'hire_date', 'base_salary'],
    'attendance': ['employee_number', 'date', 'check_in', 'check_out', 'status'],
    'performance': ['employee_number', 'review_period', 'review_date', 'overall_rating'],
    'payroll': ['employee_number', 'month', 'year', 'base_salary', 'net_salary'],
    'resignations': ['employee_number', 'employee_name', 'termination_type', 'termination_date']
};

const fieldLabels = {
    'employee_number': lang === 'ar' ? 'رقم الموظف' : 'Employee Number',
    'full_name': lang === 'ar' ? 'الاسم الكامل' : 'Full Name',
    'department': lang === 'ar' ? 'القسم' : 'Department',
    'job_title': lang === 'ar' ? 'المسمى الوظيفي' : 'Job Title',
    'hire_date': lang === 'ar' ? 'تاريخ التعيين' : 'Hire Date',
    'base_salary': lang === 'ar' ? 'الراتب الأساسي' : 'Base Salary',
    'date': lang === 'ar' ? 'التاريخ' : 'Date',
    'check_in': lang === 'ar' ? 'وقت الحضور' : 'Check In',
    'check_out': lang === 'ar' ? 'وقت الانصراف' : 'Check Out',
    'status': lang === 'ar' ? 'الحالة' : 'Status',
    'review_period': lang === 'ar' ? 'فترة التقييم' : 'Review Period',
    'review_date': lang === 'ar' ? 'تاريخ التقييم' : 'Review Date',
    'overall_rating': lang === 'ar' ? 'التقييم العام' : 'Overall Rating',
    'month': lang === 'ar' ? 'الشهر' : 'Month',
    'year': lang === 'ar' ? 'السنة' : 'Year',
    'net_salary': lang === 'ar' ? 'صافي الراتب' : 'Net Salary',
    'employee_name': lang === 'ar' ? 'اسم الموظف' : 'Employee Name',
    'termination_type': lang === 'ar' ? 'نوع إنهاء الخدمة' : 'Termination Type',
    'termination_date': lang === 'ar' ? 'تاريخ إنهاء الخدمة' : 'Termination Date'
};

function showImportModal() {
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
}

async function uploadFile(input, fileType) {
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('file_type', fileType);

    try {
        const response = await fetch('/erp/hr/api/import', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            currentImportId = data.import_id;
            currentFileType = fileType;
            currentHeaders = data.headers;
            
            // Show success message
            Swal.fire({
                icon: 'success',
                title: lang === 'ar' ? 'تم رفع الملف بنجاح!' : 'File uploaded successfully!',
                text: lang === 'ar' ? `تم اكتشاف ${data.total_rows} صف. اختر الأعمدة المطابقة.` : `Found ${data.total_rows} rows. Select matching columns.`,
                confirmButtonText: lang === 'ar' ? 'التالي' : 'Next',
                didClose: () => showMappingModal(data.headers, data.sample_rows, fileType)
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: lang === 'ar' ? 'خطأ' : 'Error',
                text: data.error || (lang === 'ar' ? 'حدث خطأ أثناء رفع الملف' : 'Error uploading file'),
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
            });
        }
    } catch (error) {
        console.error('Upload error:', error);
        Swal.fire({
            icon: 'error',
            title: lang === 'ar' ? 'خطأ' : 'Error',
            text: lang === 'ar' ? 'حدث خطأ أثناء رفع الملف' : 'Error uploading file',
            confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
        });
    }
    
    input.value = '';
}

function showMappingModal(headers, sampleRows, fileType) {
    const fields = requiredFields[fileType] || [];
    let html = '<div class="row">';
    
    // File information card
    html += `
        <div class="col-12 mb-3">
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-file fa-2x me-3"></i>
                <div>
                    <strong>${lang === 'ar' ? 'معلومات الملف' : 'File Information'}</strong><br>
                    <small>${lang === 'ar' ? 'عدد الأعمدة' : 'Columns'}: ${headers.length} | ${lang === 'ar' ? 'عدد الصفوف' : 'Rows'}: ${sampleRows ? sampleRows.length : 0}</small>
                </div>
            </div>
        </div>
    `;
    
    html += '<div class="row">';
    fields.forEach(field => {
        const matchingHeader = headers.find(h => 
            h.toLowerCase().includes(field.replace('_', '')) ||
            field.includes(h.toLowerCase().replace(' ', '_'))
        );
        
        html += `
            <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">${fieldLabels[field] || field}</label>
                <select class="form-select mapping-select" data-field="${field}">
                    <option value="">-- ${lang === 'ar' ? 'اختر العمود' : 'Select Column'} --</option>
                    ${headers.map(h => `<option value="${h}" ${h === matchingHeader ? 'selected' : ''}>${h}</option>`).join('')}
                </select>
            </div>
        `;
    });
    
    html += '</div>';
    
    if (sampleRows && sampleRows.length > 0) {
        html += `
            <div class="mt-4">
                <div class="d-flex align-items-center mb-3">
                    <h6 class="mb-0">
                        <i class="fas fa-eye me-2"></i>
                        ${lang === 'ar' ? 'معاينة البيانات:' : 'Data Preview:'}
                    </h6>
                </div>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-bordered table-hover">
                        <thead class="table-light sticky-top">
                            <tr>${headers.map(h => `<th class="fw-bold">${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${sampleRows.map((row, idx) => `
                                <tr>
                                    ${headers.map(h => `<td class="small">${row[h] || '<span class="text-muted">—</span>'}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    document.getElementById('mappingForm').innerHTML = html;
    
    const mappingModal = new bootstrap.Modal(document.getElementById('mappingModal'));
    mappingModal.show();
}

async function applyMapping() {
    const mapping = {};
    document.querySelectorAll('.mapping-select').forEach(select => {
        if (select.value) {
            mapping[select.dataset.field] = select.value;
        }
    });
    
    try {
        // Show loading state
        Swal.fire({
            title: lang === 'ar' ? 'جاري الاستيراد...' : 'Importing...',
            html: lang === 'ar' ? 'يتم استيراد البيانات، يرجى الانتظار' : 'Importing data, please wait...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // First, send mapping
        const mapResponse = await fetch(`/erp/hr/api/import/${currentImportId}/map`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ mapping: mapping })
        });
        
        const mapResult = await mapResponse.json();
        
        if (!mapResult.success) {
            Swal.fire({
                icon: 'error',
                title: lang === 'ar' ? 'خطأ' : 'Error',
                text: mapResult.error || (lang === 'ar' ? 'حدث خطأ أثناء حفظ التعيين' : 'Mapping error'),
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
            });
            return;
        }
        
        // Then, process the import
        const processResponse = await fetch(`/erp/hr/api/import/${currentImportId}/process`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await processResponse.json();
        
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('mappingModal')).hide();
            
            const statusEl = document.getElementById(`status-${currentFileType}`);
            if (statusEl) {
                statusEl.innerHTML = `<span class="badge bg-success">${lang === 'ar' ? 'مرفوع' : 'Uploaded'}</span>`;
            }
            
            // Update data status table and enable analysis
            updateDataStatusFromImport(currentFileType, result.imported || 0);
            
            Swal.fire({
                icon: 'success',
                title: lang === 'ar' ? 'نجح!' : 'Success!',
                html: lang === 'ar' ? `تم استيراد ${result.imported || 0} سجل بنجاح!` : `Successfully imported ${result.imported || 0} records!`,
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK',
                didClose: () => {
                    // Load employees preview
                    if (currentFileType === 'employees') {
                        loadEmployeesPreview();
                    }
                }
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: lang === 'ar' ? 'خطأ' : 'Error',
                text: result.error || (lang === 'ar' ? 'حدث خطأ أثناء الاستيراد' : 'Import error'),
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
            });
        }
    } catch (error) {
        console.error('Mapping error:', error);
        Swal.fire({
            icon: 'error',
            title: lang === 'ar' ? 'خطأ' : 'Error',
            text: lang === 'ar' ? 'حدث خطأ أثناء الاستيراد: ' + error.message : 'Import error: ' + error.message,
            confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
        });
    }
}

document.getElementById('erpConnectForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        erp_type: document.getElementById('erpType').value,
        api_url: document.getElementById('apiUrl').value,
        api_key: document.getElementById('apiKey').value,
        company_id: document.getElementById('companyId').value,
        client_id: document.getElementById('clientId').value
    };
    
    try {
        const response = await fetch('/erp/hr/api/erp/connect', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('erpConnectionStatus').style.display = 'block';
            document.getElementById('erpConnectionMessage').textContent = data.message;
            
            Swal.fire({
                icon: 'success',
                title: lang === 'ar' ? 'متصل' : 'Connected!',
                text: data.message,
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK',
                didClose: () => location.reload()
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: lang === 'ar' ? 'فشل' : 'Failed',
                text: data.error || (lang === 'ar' ? 'فشل الاتصال' : 'Connection failed'),
                confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
            });
        }
    } catch (error) {
        console.error('ERP connect error:', error);
        Swal.fire({
            icon: 'error',
            title: lang === 'ar' ? 'خطأ' : 'Error',
            text: lang === 'ar' ? 'حدث خطأ أثناء الاتصال' : 'Connection error',
            confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
        });
    }
});

async function updateDataStatusFromImport(fileType, count) {
    // Find table rows and update them
    const rows = document.querySelectorAll('table tbody tr');
    const typeMap = {
        'employees': 'الموظفون',
        'attendance': 'الحضور والانصراف',
        'performance': 'الأداء',
        'payroll': 'الرواتب',
        'resignations': 'الاستقالات'
    };
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 0) {
            const firstCell = cells[0].textContent.trim();
            // Check if this is the row for the imported file type
            if (firstCell.includes(typeMap[fileType]) || firstCell.includes(fileType)) {
                // Update status badge
                const statusCell = cells[1];
                if (statusCell) {
                    statusCell.innerHTML = `<span class="badge bg-success-subtle text-success px-3 py-2"><i class="fas fa-check-circle me-1"></i>${lang === 'ar' ? 'متوفر' : 'Available'}</span>`;
                }
                // Update count
                if (cells[2]) {
                    cells[2].innerHTML = `<span class="fw-semibold">${count}</span>`;
                }
                // Update date
                if (cells[3]) {
                    const today = new Date().toISOString().split('T')[0];
                    cells[3].textContent = today;
                }
                // Update source
                if (cells[4]) {
                    cells[4].innerHTML = `<span class="badge bg-info-subtle text-info">CSV</span>`;
                }
            }
        }
    });
    
    // Enable analyze button
    const analyzeCard = document.getElementById('analyzeCard');
    if (analyzeCard && count > 0) {
        analyzeCard.style.opacity = '1';
        analyzeCard.style.pointerEvents = 'auto';
        const btn = analyzeCard.querySelector('button');
        if (btn) btn.disabled = false;
    }
}

async function loadEmployeesPreview() {
    try {
        const response = await fetch('/erp/hr/api/employees');
        const data = await response.json();
        
        if (data.success && data.employees.length > 0) {
            document.getElementById('employeesPreviewSection').style.display = 'block';
            const tbody = document.getElementById('employeesTableBody');
            tbody.innerHTML = data.employees.map(emp => `
                <tr>
                    <td class="px-4 py-3"><strong>${emp.employee_number}</strong></td>
                    <td class="px-4 py-3">${emp.full_name}</td>
                    <td class="px-4 py-3">${emp.department}</td>
                    <td class="px-4 py-3">${emp.job_title}</td>
                    <td class="px-4 py-3"><span class="badge bg-success">${emp.status}</span></td>
                </tr>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading employees:', error);
    }
}

let departmentChart = null;
let statusChart = null;

async function analyzeHRData() {
    try {
        Swal.fire({
            title: lang === 'ar' ? 'جاري التحليل...' : 'Analyzing...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        const response = await fetch('/erp/hr/api/hr-stats');
        const stats = await response.json();

        if (!stats.success) throw new Error(stats.error);

        // Show sections
        document.getElementById('statsSection').style.display = 'grid';
        document.getElementById('analyticsSection').style.display = 'grid';

        // Update stats cards
        document.getElementById('totalEmployees').textContent = stats.total_employees;
        document.getElementById('activeEmployees').textContent = stats.active_employees;
        document.getElementById('inactiveEmployees').textContent = stats.inactive_employees;
        document.getElementById('avgSalary').textContent = Math.round(stats.salary_stats.average).toLocaleString();

        // Destroy old charts if they exist
        if (departmentChart) departmentChart.destroy();
        if (statusChart) statusChart.destroy();

        // Create department chart
        const deptCtx = document.getElementById('departmentChart');
        if (deptCtx) {
            departmentChart = new Chart(deptCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(stats.departments),
                    datasets: [{
                        data: Object.values(stats.departments),
                        backgroundColor: ['#0d6efd', '#198754', '#fd7e14', '#dc3545', '#6f42c1', '#20c997']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: lang === 'ar' ? 'right' : 'left' }
                    }
                }
            });
        }

        // Create status chart
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: [lang === 'ar' ? 'نشط' : 'Active', lang === 'ar' ? 'غير نشط' : 'Inactive'],
                    datasets: [{
                        data: [stats.active_employees, stats.inactive_employees],
                        backgroundColor: ['#198754', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: lang === 'ar' ? 'right' : 'left' }
                    }
                }
            });
        }

        // Load employees preview
        await loadEmployeesPreview();

        // Save analysis report
        const saveResp = await fetch('/erp/hr/api/save-analysis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(stats)
        });
        
        if (saveResp.ok) {
            // Auto-update reports history
            await loadPreviousReports();
        }

        // Show export buttons
        const exportBtns = document.createElement('div');
        exportBtns.className = 'mt-4 d-flex gap-2 justify-content-center';
        exportBtns.innerHTML = `
            <button class="btn btn-outline-primary" onclick="loadAnalysisReports()">
                <i class="fas fa-history me-2"></i>${lang === 'ar' ? 'سجل التحليلات' : 'Reports'}
            </button>
            <button class="btn btn-outline-success" onclick="exportToPDF()">
                <i class="fas fa-file-pdf me-2"></i>${lang === 'ar' ? 'تحميل PDF' : 'Export PDF'}
            </button>
            <button class="btn btn-outline-info" onclick="exportToExcel()">
                <i class="fas fa-file-excel me-2"></i>${lang === 'ar' ? 'تحميل Excel' : 'Export Excel'}
            </button>
        `;
        document.getElementById('analyticsSection').appendChild(exportBtns);

        Swal.close();
        Swal.fire({
            icon: 'success',
            title: lang === 'ar' ? 'تم التحليل بنجاح!' : 'Analysis Complete!',
            text: lang === 'ar' ? 'تم تحليل بيانات الموارد البشرية بنجاح وحفظ النتائج' : 'HR analysis completed and report saved',
            confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
        });
    } catch (error) {
        console.error('Analysis error:', error);
        Swal.fire({
            icon: 'error',
            title: lang === 'ar' ? 'خطأ' : 'Error',
            text: error.message || (lang === 'ar' ? 'حدث خطأ أثناء التحليل' : 'Error during analysis'),
            confirmButtonText: lang === 'ar' ? 'حسناً' : 'OK'
        });
    }
}

async function loadAnalysisReports() {
    try {
        const response = await fetch('/erp/hr/api/analysis-reports');
        const data = await response.json();
        
        if (!data.success || !data.reports.length) {
            Swal.fire('No reports', lang === 'ar' ? 'لا توجد تقارير' : '', 'info');
            return;
        }

        let html = '<div class="table-responsive"><table class="table"><thead><tr><th>Date</th><th>Total</th><th>Active</th><th>Avg Salary</th><th>Actions</th></tr></thead><tbody>';
        data.reports.forEach(r => {
            html += `<tr>
                <td>${new Date(r.created_at).toLocaleString()}</td>
                <td>${r.total_employees}</td>
                <td>${r.active_employees}</td>
                <td>${Math.round(r.salary_stats.average).toLocaleString()}</td>
                <td>
                    <a href="/erp/hr/api/export-analysis/${r.id}/pdf" class="btn btn-sm btn-danger"><i class="fas fa-download"></i> PDF</a>
                    <a href="/erp/hr/api/export-analysis/${r.id}/excel" class="btn btn-sm btn-success"><i class="fas fa-download"></i> Excel</a>
                </td>
            </tr>`;
        });
        html += '</tbody></table></div>';

        Swal.fire({
            title: lang === 'ar' ? 'سجل التحليلات' : 'Analysis Reports',
            html: html,
            width: '90%'
        });
    } catch (error) {
        Swal.fire('Error', error.message, 'error');
    }
}

function exportToPDF() {
    if (currentReportId === null) {
        // Get latest report
        fetch('/erp/hr/api/analysis-reports').then(r => r.json()).then(d => {
            if (d.reports.length) {
                window.location = `/erp/hr/api/export-analysis/${d.reports[0].id}/pdf`;
            }
        });
    }
}

function exportToExcel() {
    if (currentReportId === null) {
        fetch('/erp/hr/api/analysis-reports').then(r => r.json()).then(d => {
            if (d.reports.length) {
                window.location = `/erp/hr/api/export-analysis/${d.reports[0].id}/excel`;
            }
        });
    }
}

let currentReportId = null;

async function loadPreviousReports() {
    try {
        const response = await fetch('/erp/hr/api/analysis-reports');
        const data = await response.json();
        
        if (data.success && data.reports && data.reports.length > 0) {
            const tbody = document.getElementById('reportsTableBody');
            tbody.innerHTML = data.reports.map(r => `
                <tr>
                    <td class="px-4 py-3"><small>${new Date(r.created_at).toLocaleString()}</small></td>
                    <td class="px-4 py-3 text-center"><strong>${r.total_employees}</strong></td>
                    <td class="px-4 py-3 text-center"><span class="badge bg-success">${r.active_employees}</span></td>
                    <td class="px-4 py-3 text-center">${Math.round(r.salary_stats.average || 0).toLocaleString()}</td>
                    <td class="px-4 py-3 text-center">
                        <a href="/erp/hr/api/export-analysis/${r.id}/pdf" class="btn btn-sm btn-outline-danger" title="Export PDF">
                            <i class="fas fa-file-pdf"></i>
                        </a>
                        <a href="/erp/hr/api/export-analysis/${r.id}/excel" class="btn btn-sm btn-outline-success" title="Export Excel">
                            <i class="fas fa-file-excel"></i>
                        </a>
                    </td>
                </tr>
            `).join('');
        } else {
            document.getElementById('reportsTableBody').innerHTML = `
                <tr>
                    <td colspan="5" class="px-4 py-3 text-center text-muted">
                        {{ 'No analysis reports yet' if lang == 'en' else 'لا توجد تقارير تحليل حتى الآن' }}
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Error loading reports:', error);
    }
}

function toggleReportsHistory() {
    const section = document.getElementById('reportsHistorySection');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
}

async function updateDataStatus() {
    try {
        const response = await fetch('/erp/hr/api/data-status');
        const status = await response.json();
        
        if (status.success) {
            // Update employees row
            updateStatusRow('employees', status.employees);
            updateStatusRow('attendance', status.attendance);
            updateStatusRow('performance', status.performance);
            updateStatusRow('payroll', status.payroll);
            updateStatusRow('resignations', status.resignations);
            
            // Check if any data available
            const hasData = status.employees.available || status.attendance.available || 
                          status.performance.available || status.payroll.available;
            
            if (hasData) {
                const analyzeCard = document.getElementById('analyzeCard');
                if (analyzeCard) {
                    analyzeCard.style.opacity = '1';
                    analyzeCard.style.pointerEvents = 'auto';
                    analyzeCard.querySelector('button').disabled = false;
                }
            }
        }
    } catch (error) {
        console.error('Error updating data status:', error);
    }
}

function updateStatusRow(type, statusData) {
    // Update count
    const countCells = document.querySelectorAll(`table td:nth-child(3)`);
    const typeCells = document.querySelectorAll(`table td:first-child`);
    
    for (let i = 0; i < typeCells.length; i++) {
        if (typeCells[i].textContent.toLowerCase().includes(type.replace('_', ' '))) {
            // Update status badge
            const statusCell = typeCells[i].parentElement.querySelector('td:nth-child(2)');
            if (statusCell) {
                if (statusData.available) {
                    statusCell.innerHTML = `<span class="badge bg-success-subtle text-success px-3 py-2">
                        <i class="fas fa-check-circle me-1"></i>متوفر / Available
                    </span>`;
                }
            }
            // Update record count
            const countCell = typeCells[i].parentElement.querySelector('td:nth-child(3)');
            if (countCell) {
                countCell.textContent = statusData.count;
            }
            // Update last update date
            if (statusData.last_update) {
                const dateCell = typeCells[i].parentElement.querySelector('td:nth-child(4)');
                if (dateCell) {
                    const date = new Date(statusData.last_update);
                    dateCell.textContent = date.toISOString().split('T')[0];
                }
            }
            break;
        }
    }
}

async function loadUploadedFiles() {
    try {
        const response = await fetch('/erp/hr/api/uploaded-files');
        const data = await response.json();
        
        if (data.success && data.files) {
            Object.keys(data.files).forEach(fileType => {
                const file = data.files[fileType];
                const actionsCell = document.getElementById(`actions-${fileType}`);
                if (actionsCell) {
                    actionsCell.innerHTML = `
                        <a href="/erp/hr/api/preview-file/${file.id}" target="_blank" class="btn btn-sm btn-outline-primary" title="${lang === 'ar' ? 'معاينة' : 'Preview'}">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="/erp/hr/api/download-file/${file.id}" class="btn btn-sm btn-outline-success" title="${lang === 'ar' ? 'تحميل' : 'Download'}">
                            <i class="fas fa-download"></i>
                        </a>
                    `;
                }
            });
        }
    } catch (error) {
        console.error('Error loading uploaded files:', error);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Update data status from server
    updateDataStatus();
    
    // Load previous analysis reports on page load
    loadPreviousReports();
    
    // Load uploaded files to show preview/download buttons
    loadUploadedFiles();
    
    // Refresh status every 5 seconds
    setInterval(updateDataStatus, 5000);
});
</script>

<style>
.nav-pills .nav-link {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    margin: 0 5px;
    transition: all 0.3s ease;
}

.nav-pills .nav-link:hover {
    border-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.05);
}

.nav-pills .nav-link.active {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.table th {
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge {
    font-weight: 500;
}

.modal-xl {
    max-width: 1100px;
}

#analyzeCard {
    transition: opacity 0.3s ease;
}

.form-control-lg, .form-select-lg {
    padding: 0.75rem 1rem;
}
</style>
{% endblock %}
