{% extends "base.html" %}

{% block title %}{{ 'ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™' if lang == 'ar' else 'Notifications' }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-0">{{ 'ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™Ÿä' if lang == 'ar' else 'My Notifications' }}</h2>
            <p class="text-muted">{{ 'ÿ•ÿØÿßÿ±ÿ© ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ŸÉ ÿßŸÑÿ¥ÿÆÿµŸäÿ©' if lang == 'ar' else 'Manage your personal notifications' }}</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="stat-card">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-icon" style="background: rgba(10, 39, 86, 0.1); color: #0A2756;">
                            <i class="fas fa-bell"></i>
                        </div>
                    </div>
                    <div class="text-{{ 'start' if lang == 'en' else 'end' }}">
                        <div class="stat-value">{{ total_notifications }}</div>
                        <div class="stat-label">{{ 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™' if lang == 'ar' else 'Total Notifications' }}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="stat-card">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-icon" style="background: rgba(220, 53, 69, 0.1); color: #DC3545;">
                            <i class="fas fa-envelope"></i>
                        </div>
                    </div>
                    <div class="text-{{ 'start' if lang == 'en' else 'end' }}">
                        <div class="stat-value">{{ unread_notifications }}</div>
                        <div class="stat-label">{{ 'ÿ∫Ÿäÿ± ŸÖŸÇÿ±Ÿàÿ°ÿ©' if lang == 'ar' else 'Unread' }}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="stat-card">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-icon" style="background: rgba(44, 140, 86, 0.1); color: #2C8C56;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="text-{{ 'start' if lang == 'en' else 'end' }}">
                        <div class="stat-value">{{ read_notifications }}</div>
                        <div class="stat-label">{{ 'ŸÖŸÇÿ±Ÿàÿ°ÿ©' if lang == 'ar' else 'Read' }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Table -->
    <div class="card">
        <div class="card-body">
            {% if notifications %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>{{ 'ÿßŸÑÿπŸÜŸàÿßŸÜ' if lang == 'ar' else 'Title' }}</th>
                            <th>{{ 'ÿßŸÑŸÜŸàÿπ' if lang == 'ar' else 'Type' }}</th>
                            <th>{{ 'ÿßŸÑÿ≠ÿßŸÑÿ©' if lang == 'ar' else 'Status' }}</th>
                            <th>{{ 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ' if lang == 'ar' else 'Date' }}</th>
                            <th>{{ 'ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™' if lang == 'ar' else 'Actions' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for notification in notifications %}
                        <tr style="background-color: {% if not notification.is_read %}#f8f9fa{% endif %}; cursor: pointer;" 
                            data-notification-id="{{ notification.id }}"
                            data-notification-title="{{ notification.title | e }}"
                            data-notification-message="{{ notification.message | e }}"
                            data-notification-type="{{ notification.notification_type }}"
                            data-notification-read="{{ notification.is_read }}"
                            onclick="showNotificationDetail(this)">
                            <td>
                                <strong>{{ notification.title }}</strong>
                            </td>
                            <td>
                                {% if notification.notification_type == 'login' %}
                                <span class="badge bg-success">‚úÖ {{ 'ÿØÿÆŸàŸÑ' if lang == 'ar' else 'Login' }}</span>
                                {% else %}
                                <span class="badge bg-primary">{{ notification.notification_type }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if notification.is_read %}
                                <span class="badge bg-success">{{ 'ŸÖŸÇÿ±Ÿàÿ°' if lang == 'ar' else 'Read' }}</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">{{ 'ÿ¨ÿØŸäÿØ' if lang == 'ar' else 'New' }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ notification.created_at.strftime('%Y-%m-%d %H:%M') if notification.created_at else '-' }}</small>
                            </td>
                            <td onclick="event.stopPropagation();">
                                {% if not notification.is_read %}
                                <button class="btn btn-sm btn-outline-primary" onclick="markAsRead({{ notification.id }})">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Notification Detail Modal -->
            <div class="modal fade" id="notificationDetailModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="notificationDetailTitle"></h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body" id="notificationDetailContent">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ 'ÿ•ÿ∫ŸÑÿßŸÇ' if lang == 'ar' else 'Close' }}</button>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                <p class="text-muted">{{ 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™' if lang == 'ar' else 'No notifications' }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function markAsRead(notificationId) {
        fetch(`/user/notifications/mark-read/${notificationId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => response.json()).then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }

    function showNotificationDetail(row) {
        const notificationId = row.dataset.notificationId;
        const title = row.dataset.notificationTitle || '';
        const message = row.dataset.notificationMessage || '';
        const type = row.dataset.notificationType || '';
        const isRead = row.dataset.notificationRead === 'True';

        console.log('Notification Details:', {notificationId, title, message, type});

        let data = {};
        let isLoginNotification = false;
        
        try {
            data = JSON.parse(message);
            if (data.login_time) {
                isLoginNotification = true;
            }
        } catch(e) {
            data = { message: message };
        }

        let content = '';
        let lang = '{{ lang }}';

        if (isLoginNotification && type === 'login' && data.login_time) {
            content = `
                <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0; font-size: 16px;">‚úÖ ${title}</h4>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 3px solid #28a745;">
                        <div style="color: #666; font-size: 12px;">${lang === 'ar' ? 'ŸàŸÇÿ™ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ' : 'Login Time'}</div>
                        <div style="font-weight: 600; color: #000; margin-top: 4px;">${data.login_time}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 3px solid #28a745;">
                        <div style="color: #666; font-size: 12px;">${lang === 'ar' ? 'ÿßŸÑÿ¨Ÿáÿßÿ≤' : 'Device'}</div>
                        <div style="font-weight: 600; color: #000; margin-top: 4px;">${data.device || ''}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 3px solid #28a745;">
                        <div style="color: #666; font-size: 12px;">IP Address</div>
                        <div style="font-weight: 600; color: #000; margin-top: 4px; font-size: 12px;">${data.ip_address || ''}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 3px solid #28a745;">
                        <div style="color: #666; font-size: 12px;">${lang === 'ar' ? 'ÿßŸÑŸÖÿ™ÿµŸÅÿ≠' : 'Browser'}</div>
                        <div style="font-weight: 600; color: #000; margin-top: 4px;">${data.browser || ''}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 3px solid #28a745;">
                        <div style="color: #666; font-size: 12px;">${lang === 'ar' ? 'ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ' : 'OS'}</div>
                        <div style="font-weight: 600; color: #000; margin-top: 4px;">${data.os || ''}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 3px solid #28a745;">
                        <div style="color: #666; font-size: 12px;">${lang === 'ar' ? 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ' : 'User'}</div>
                        <div style="font-weight: 600; color: #000; margin-top: 4px;">${data.user_name || ''}</div>
                    </div>
                </div>
                <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; border-left: 3px solid #0d6efd;">
                    <div style="color: #666; font-size: 12px;">${lang === 'ar' ? 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä' : 'Email'}</div>
                    <div style="font-weight: 600; color: #000; margin-top: 4px; word-break: break-all;">${data.user_email || ''}</div>
                </div>
            `;
        } else {
            // Handle regular notifications (broadcast messages, etc)
            const displayMessage = message || '(ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±ÿ≥ÿßŸÑÿ© / No message)';
            content = `
                <div style="background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0; font-size: 16px;">üì¢ ${title}</h4>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 3px solid #0d6efd; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">
                    ${displayMessage}
                </div>
            `;
        }

        document.getElementById('notificationDetailTitle').textContent = title;
        document.getElementById('notificationDetailContent').innerHTML = content;
        $('#notificationDetailModal').modal('show');

        if (!isRead) {
            markAsRead(notificationId);
        }
    }
</script>
{% endblock %}
