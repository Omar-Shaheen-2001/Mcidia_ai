{% extends "base.html" %}

{% block title %}{{ offering.title_ar if lang == 'ar' else offering.title_en }} - Mcidia{% endblock %}

{% block content %}
<!-- Mobile Sidebar Toggle -->
<div class="d-lg-none bg-white border-bottom py-2 sticky-top" style="top: 70px; z-index: 1030;">
    <div class="container">
        <button class="btn btn-sm btn-outline-primary" type="button" id="sidebarToggle">
            <i class="fas fa-bars me-2"></i>
            {{ 'الوحدات الاستشارية' if lang == 'ar' else 'Consulting Modules' }}
        </button>
    </div>
</div>

<!-- Offering Header -->
<section class="py-4" style="background: linear-gradient(135deg, {{ service.color }} 0%, {{ service.color }}dd 100%);">
    <div class="container text-white">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-3">
                <li class="breadcrumb-item"><a href="{{ url_for('services.index') }}" class="text-white-50">{{ 'الخدمات' if lang == 'ar' else 'Services' }}</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('services.service_detail', service_slug=service.slug) }}" class="text-white-50">{{ service.title_ar if lang == 'ar' else service.title_en }}</a></li>
                <li class="breadcrumb-item active text-white" aria-current="page">{{ offering.title_ar if lang == 'ar' else offering.title_en }}</li>
            </ol>
        </nav>
        
        <div class="row align-items-center">
            <div class="col-lg-9">
                <div class="d-flex align-items-start gap-3">
                    <div class="icon-box flex-shrink-0" style="background-color: rgba(255,255,255,0.2); width: 4rem; height: 4rem;">
                        <i class="fas {{ offering.icon or 'fa-star' }} fa-2x text-white"></i>
                    </div>
                    <div>
                        <h1 class="fw-bold mb-2 text-white h3">
                            {{ offering.title_ar if lang == 'ar' else offering.title_en }}
                        </h1>
                        <p class="mb-0" style="color: rgba(255,255,255,0.9);">
                            {{ offering.description_ar if lang == 'ar' else offering.description_en }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 text-lg-end mt-3 mt-lg-0">
                <span class="badge bg-white text-dark px-3 py-2">
                    <i class="fas fa-brain me-1"></i>
                    {{ offering.ai_credits_cost or 1 }} {{ 'رصيد AI' if lang == 'ar' else 'AI Credits' }}
                </span>
            </div>
        </div>
    </div>
</section>

<!-- Content with Sidebar -->
<div class="container-fluid" style="flex: 1; display: flex; flex-direction: column;">
    <div class="row" style="flex: 1;">
        <!-- Sidebar -->
        <div class="col-lg-3 px-0">
            {% include 'components/services_sidebar.html' %}
        </div>
        
        <!-- Main Content -->
        <div class="col-lg-9">
            <div class="container my-5" style="min-height: calc(100vh - 300px);">
                <div class="row">
        <!-- AI Form Section -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm">
                <div class="card__header">
                    <h4 class="card__title mb-0">
                        <i class="fas fa-magic me-2" style="color: {{ service.color }};"></i>
                        {{ 'احصل على استشارة ذكية' if lang == 'ar' else 'Get AI-Powered Consultation' }}
                    </h4>
                </div>
                <div class="card__body">
                    {% if not current_user %}
                    <!-- Login Required Message -->
                    <div class="text-center py-5">
                        <i class="fas fa-lock fa-3x text-muted mb-3"></i>
                        <h5 class="mb-3">{{ 'يجب تسجيل الدخول للحصول على استشارة' if lang == 'ar' else 'Login Required for Consultation' }}</h5>
                        <p class="text-muted mb-4">
                            {{ 'سجل الدخول أو أنشئ حساباً جديداً للاستفادة من خدمات الاستشارة الذكية' if lang == 'ar' else 'Login or create an account to access AI consultation services' }}
                        </p>
                        <div class="d-flex gap-2 justify-content-center">
                            <a href="{{ url_for('auth.login') }}?next={{ request.path }}" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                {{ 'تسجيل الدخول' if lang == 'ar' else 'Login' }}
                            </a>
                            <a href="{{ url_for('auth.register') }}?next={{ request.path }}" class="btn btn-outline-primary">
                                <i class="fas fa-user-plus me-2"></i>
                                {{ 'إنشاء حساب' if lang == 'ar' else 'Register' }}
                            </a>
                        </div>
                    </div>
                    {% else %}
                    <form id="aiConsultationForm">
                        <!-- Project Name (Always Required) -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-folder me-1"></i>
                                {{ 'اسم المشروع' if lang == 'ar' else 'Project Name' }}
                                <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" name="project_name" 
                                   placeholder="{{ 'أدخل اسم المشروع' if lang == 'ar' else 'Enter project name' }}" required>
                        </div>
                        
                        {% if offering.form_fields %}
                        <!-- Dynamic Custom Fields -->
                        <div id="customFieldsContainer"></div>
                        {% else %}
                        <!-- Default Fields (if no custom fields defined) -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-align-left me-1"></i>
                                {{ 'وصف الاحتياجات' if lang == 'ar' else 'Description of Needs' }}
                                <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" name="description" rows="6"
                                      placeholder="{{ 'صف احتياجاتك بالتفصيل للحصول على استشارة دقيقة...' if lang == 'ar' else 'Describe your needs in detail for accurate consultation...' }}" required></textarea>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                {{ 'كلما كانت المعلومات أكثر تفصيلاً، كانت النتائج أفضل' if lang == 'ar' else 'The more detailed the information, the better the results' }}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-list me-1"></i>
                                {{ 'معلومات إضافية (اختياري)' if lang == 'ar' else 'Additional Information (Optional)' }}
                            </label>
                            <textarea class="form-control" name="additional_context" rows="3"
                                      placeholder="{{ 'أضف أي معلومات إضافية تساعد في تقديم استشارة أفضل' if lang == 'ar' else 'Add any additional information for better consultation' }}"></textarea>
                        </div>
                        {% endif %}
                        
                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-lg w-100" style="background-color: {{ service.color }}; color: white;" id="generateBtn">
                            <i class="fas fa-robot me-2"></i>
                            {{ 'إنشاء الاستشارة الذكية' if lang == 'ar' else 'Generate AI Consultation' }}
                        </button>
                    </form>
                    {% endif %}
                    
                    <!-- Loading State -->
                    <div id="loadingState" class="d-none text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted">
                            <i class="fas fa-brain me-2"></i>
                            {{ 'جاري إنشاء الاستشارة الذكية...' if lang == 'ar' else 'Generating AI consultation...' }}
                        </p>
                    </div>
                    
                    <!-- Result Section -->
                    <div id="resultSection" class="d-none mt-4">
                        <hr class="my-4">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            {{ 'نتيجة الاستشارة' if lang == 'ar' else 'Consultation Result' }}
                        </h5>
                        <div id="resultContent" class="card bg-light p-4" style="white-space: pre-wrap; line-height: 1.8;"></div>
                        
                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="window.print()">
                                <i class="fas fa-print me-1"></i>
                                {{ 'طباعة' if lang == 'ar' else 'Print' }}
                            </button>
                            <button class="btn btn-outline-secondary" id="newConsultationBtn">
                                <i class="fas fa-plus me-1"></i>
                                {{ 'استشارة جديدة' if lang == 'ar' else 'New Consultation' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Info Card -->
            <div class="card mb-4">
                <div class="card__header" style="background-color: {{ service.color }}10;">
                    <h6 class="card__title mb-0" style="color: {{ service.color }};">
                        <i class="fas fa-info-circle me-2"></i>
                        {{ 'معلومات الخدمة' if lang == 'ar' else 'Service Information' }}
                    </h6>
                </div>
                <div class="card__body">
                    <div class="mb-3">
                        <div class="small text-muted mb-1">{{ 'الفئة' if lang == 'ar' else 'Category' }}</div>
                        <div class="fw-semibold">{{ service.title_ar if lang == 'ar' else service.title_en }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="small text-muted mb-1">{{ 'تكلفة الاستخدام' if lang == 'ar' else 'Usage Cost' }}</div>
                        <div class="fw-semibold">{{ offering.ai_credits_cost or 1 }} {{ 'رصيد AI' if lang == 'ar' else 'AI Credits' }}</div>
                    </div>
                    <div>
                        <div class="small text-muted mb-1">{{ 'النموذج المستخدم' if lang == 'ar' else 'AI Model' }}</div>
                        <div class="fw-semibold">{{ offering.ai_model or 'GPT-4' }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Projects -->
            {% if projects %}
            <div class="card">
                <div class="card__header">
                    <h6 class="card__title mb-0">
                        <i class="fas fa-history me-2"></i>
                        {{ 'المشاريع الأخيرة' if lang == 'ar' else 'Recent Projects' }}
                    </h6>
                </div>
                <div class="card__body p-0">
                    <div class="list-group list-group-flush">
                        {% for project in projects %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 small">{{ project.title }}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ project.created_at.strftime('%Y-%m-%d') }}
                                    </small>
                                </div>
                                <span class="badge badge--success small">{{ project.status }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Help Card -->
            <div class="card mt-4" style="background-color: {{ service.color }}10; border-color: {{ service.color }}20;">
                <div class="card__body text-center">
                    <div class="icon-box mb-3 mx-auto" style="background-color: {{ service.color }}; color: white;">
                        <i class="fas fa-headset fa-2x"></i>
                    </div>
                    <h6 class="fw-bold mb-2">{{ 'هل تحتاج مساعدة؟' if lang == 'ar' else 'Need Help?' }}</h6>
                    <p class="small text-muted mb-3">
                        {{ 'فريقنا جاهز لمساعدتك' if lang == 'ar' else 'Our team is ready to help' }}
                    </p>
                    <a href="{{ url_for('consultation.index') }}" class="btn btn-sm btn-outline-primary">
                        {{ 'تحدث مع مستشار' if lang == 'ar' else 'Talk to Consultant' }}
                    </a>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar Overlay for Mobile -->
<div class="sidebar-overlay d-lg-none" id="sidebarOverlay"></div>

<script>
// Mobile sidebar toggle
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('servicesSidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const overlay = document.getElementById('sidebarOverlay');
    
    if (sidebarToggle && sidebar && overlay) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        });
        
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        });
    }
    
    // Generate dynamic custom fields
    {% if offering.form_fields %}
    const customFieldsContainer = document.getElementById('customFieldsContainer');
    if (customFieldsContainer) {
        try {
            const fields = {{ offering.form_fields | tojson | safe }};
            const parsedFields = typeof fields === 'string' ? JSON.parse(fields) : fields;
            const lang = '{{ lang }}';
            
            if (Array.isArray(parsedFields)) {
                parsedFields.forEach(field => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'mb-4';
                    
                    const label = field['label_' + lang] || field.label_ar || field.label_en || field.name;
                    const isRequired = field.required;
                    
                    let fieldHTML = `
                        <label class="form-label fw-semibold">
                            <i class="fas fa-${getFieldIcon(field.type)} me-1"></i>
                            ${label}
                            ${isRequired ? '<span class="text-danger">*</span>' : ''}
                        </label>
                    `;
                    
                    switch (field.type) {
                        case 'textarea':
                            fieldHTML += `<textarea class="form-control" name="${field.name}" rows="4" ${isRequired ? 'required' : ''}></textarea>`;
                            break;
                        case 'select':
                            fieldHTML += `<select class="form-select" name="${field.name}" ${isRequired ? 'required' : ''}>`;
                            fieldHTML += `<option value="">${lang === 'ar' ? 'اختر...' : 'Select...'}</option>`;
                            if (field.options && Array.isArray(field.options)) {
                                field.options.forEach(option => {
                                    fieldHTML += `<option value="${option}">${option}</option>`;
                                });
                            }
                            fieldHTML += `</select>`;
                            break;
                        case 'number':
                            fieldHTML += `<input type="number" class="form-control" name="${field.name}" ${isRequired ? 'required' : ''}>`;
                            break;
                        case 'email':
                            fieldHTML += `<input type="email" class="form-control" name="${field.name}" ${isRequired ? 'required' : ''}>`;
                            break;
                        case 'date':
                            fieldHTML += `<input type="date" class="form-control" name="${field.name}" ${isRequired ? 'required' : ''}>`;
                            break;
                        default: // text
                            fieldHTML += `<input type="text" class="form-control" name="${field.name}" ${isRequired ? 'required' : ''}>`;
                    }
                    
                    fieldDiv.innerHTML = fieldHTML;
                    customFieldsContainer.appendChild(fieldDiv);
                });
            }
        } catch (e) {
            console.error('Error loading custom fields:', e);
        }
    }
    
    function getFieldIcon(type) {
        const icons = {
            'text': 'keyboard',
            'textarea': 'align-left',
            'number': 'hashtag',
            'email': 'envelope',
            'select': 'list',
            'date': 'calendar'
        };
        return icons[type] || 'edit';
    }
    {% endif %}
    
    // AI Form functionality (only if user is logged in)
    const form = document.getElementById('aiConsultationForm');
    if (!form) {
        // User not logged in, skip form initialization
        return;
    }
    
    const loadingState = document.getElementById('loadingState');
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');
    const generateBtn = document.getElementById('generateBtn');
    const newConsultationBtn = document.getElementById('newConsultationBtn');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Get form data - collect ALL form inputs including dynamic fields
        const formData = new FormData(form);
        const jsonData = {};
        
        // Convert FormData to JSON object
        for (const [key, value] of formData.entries()) {
            jsonData[key] = value;
        }
        
        // Show loading, hide form
        form.classList.add('d-none');
        loadingState.classList.remove('d-none');
        resultSection.classList.add('d-none');
        
        try {
            const response = await fetch('{{ url_for("services.api_generate_content", service_slug=service.slug, offering_slug=offering.slug) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(jsonData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Show result
                resultContent.textContent = data.response;
                loadingState.classList.add('d-none');
                resultSection.classList.remove('d-none');
                
                // Show success message
                alert('{{ "تم إنشاء الاستشارة بنجاح!" if lang == "ar" else "Consultation generated successfully!" }}');
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            alert('{{ "حدث خطأ: " if lang == "ar" else "Error: " }}' + error.message);
            form.classList.remove('d-none');
            loadingState.classList.add('d-none');
        }
    });
    
    newConsultationBtn.addEventListener('click', function() {
        form.reset();
        form.classList.remove('d-none');
        resultSection.classList.add('d-none');
    });
});
</script>

<style>
.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0,0,0,0.5);
    z-index: 1035;
    display: none;
}

.sidebar-overlay.show {
    display: block;
}
</style>
{% endblock %}
