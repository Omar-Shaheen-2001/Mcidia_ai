{% extends "admin/base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    .kb-sidebar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        height: calc(100vh - 100px);
        overflow-y: auto;
    }
    .kb-sidebar .nav-link {
        color: rgba(255,255,255,0.8);
        padding: 10px 15px;
        border-radius: 5px;
        margin: 5px 0;
        transition: all 0.3s;
    }
    .kb-sidebar .nav-link:hover {
        color: white;
        background: rgba(255,255,255,0.1);
    }
    .kb-sidebar .nav-link.active {
        background: rgba(255,255,255,0.2);
        color: white;
        border-left: 3px solid white;
    }
    .kb-sidebar .section-title {
        font-size: 0.85rem;
        text-transform: uppercase;
        color: rgba(255,255,255,0.6);
        margin: 15px 0 10px 0;
        padding: 0 15px;
        font-weight: bold;
    }
    .quality-badge {
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: 20px;
    }
    .quality-excellent { background: #28a745; color: white; }
    .quality-good { background: #17a2b8; color: white; }
    .quality-fair { background: #ffc107; color: black; }
    .quality-poor { background: #dc3545; color: white; }
    .main-content {
        background: #f8f9fa;
        min-height: 100vh;
    }
</style>

<div class="container-fluid">
    <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-md-2 kb-sidebar p-3">
            <h5 class="mb-3">๐ ูุงุนุฏุฉ ุงููุนุฑูุฉ</h5>
            
            <div class="section-title">ุงูุฃูุณุงู ุงูุฃุณุงุณูุฉ</div>
            <nav class="nav flex-column">
                <a href="#" class="nav-link active" data-category="all">
                    <i class="fas fa-layer-group"></i> ุงููู
                </a>
                <a href="/admin/knowledge/business-fundamentals" class="nav-link" data-category="business">
                    <i class="fas fa-book"></i> ุฃุณุงุณูุงุช ุงูุฃุนูุงู
                </a>
                <a href="/admin/knowledge/feasibility-studies" class="nav-link" data-category="feasibility">
                    <i class="fas fa-chart-bar"></i> ุฏุฑุงุณุงุช ุงูุฌุฏูู
                </a>
                <a href="#" class="nav-link" data-category="strategy">
                    <i class="fas fa-compass"></i> ุงูุชุฎุทูุท ุงูุงุณุชุฑุงุชูุฌู
                </a>
                <a href="#" class="nav-link" data-category="hr">
                    <i class="fas fa-building"></i> ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ
                </a>
                <a href="#" class="nav-link" data-category="finance">
                    <i class="fas fa-coins"></i> ุงูููุฐุฌุฉ ุงููุงููุฉ
                </a>
                <a href="#" class="nav-link" data-category="market">
                    <i class="fas fa-chart-line"></i> ุฃุจุญุงุซ ุงูุณูู
                </a>
                <a href="#" class="nav-link" data-category="operations">
                    <i class="fas fa-cog"></i> ุงูุนูููุงุช ูุงูุนูููุงุช
                </a>
            </nav>

            <div class="section-title mt-4">ุงููุดุงุฑูุน</div>
            <nav class="nav flex-column">
                <a href="#" class="nav-link" data-category="user-projects">
                    <i class="fas fa-lock"></i> ูุนุฑูุฉ ุงููุณุชุฎุฏู
                </a>
                <a href="#" class="nav-link" data-category="templates">
                    <i class="fas fa-file-alt"></i> ููุชุจุฉ ุงูููุงูุจ
                </a>
            </nav>

            <div class="section-title mt-4">ุฃุฏูุงุช ุงูุฅุฏุงุฑุฉ</div>
            <nav class="nav flex-column">
                <a href="#" class="nav-link" data-tool="quality">
                    <i class="fas fa-check-circle"></i> ูุญุต ุงูุฌูุฏุฉ
                </a>
                <a href="#" class="nav-link" data-tool="duplicates">
                    <i class="fas fa-copy"></i> ูุดู ุงูุชูุฑุงุฑ
                </a>
                <a href="#" class="nav-link" data-tool="reembed">
                    <i class="fas fa-sync-alt"></i> ุฅุนุงุฏุฉ ุงููุนุงูุฌุฉ
                </a>
                <a href="#" class="nav-link" data-tool="analytics">
                    <i class="fas fa-chart-pie"></i> ุงูุชุญูููุงุช
                </a>
                <a href="#" class="nav-link" data-tool="agents">
                    <i class="fas fa-robot"></i> ุชุฎุทูุท ุงููููุงุก
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="col-md-10 main-content p-4">
            <!-- Top Navigation Bar -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4>๐ ูุงุนุฏุฉ ุงููุนุฑูุฉ ุงูุฑุฆูุณูุฉ</h4>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="fas fa-cloud-upload-alt"></i> ุฑูุน ููู ุฌุฏูุฏ
                            </button>
                            <button class="btn btn-success btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#templateModal">
                                <i class="fas fa-plus"></i> ูุงูุจ ุฌุฏูุฏ
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ms-2" id="searchToggle">
                                <i class="fas fa-sliders-h"></i> ุงูููุงุชุฑ
                            </button>
                            <button class="btn btn-outline-info btn-sm ms-2" href="/admin/knowledge/settings">
                                <i class="fas fa-cog"></i> ุงูุฅุนุฏุงุฏุงุช
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">ุฅุฌูุงูู ุงููููุงุช</h6>
                            <h3 id="stat-total">{{ total_docs }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">ุงูุฃูุณุงู</h6>
                            <h3 id="stat-categories">{{ categories|length }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">ูุชูุณุท ุงูุฌูุฏุฉ</h6>
                            <h3 id="stat-quality"><span class="badge bg-success">ุฌูุฏ</span></h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">Chunks ุงููุนุงูุฌุฉ</h6>
                            <h3 id="stat-chunks">{{ documents|length }}</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search & Filters Panel -->
            <div class="card mb-4 shadow-sm" id="filtersPanel" style="display:none;">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">ุงูุจุญุซ</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="ุงุจุญุซ...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ุงููุณู</label>
                            <select class="form-select" id="categoryFilter">
                                <option value="">ุงููู</option>
                                {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ุงูุฌูุฏุฉ</label>
                            <select class="form-select" id="qualityFilter">
                                <option value="">ุงููู</option>
                                <option value="excellent">ููุชุงุฒ</option>
                                <option value="good">ุฌูุฏ</option>
                                <option value="fair">ููุจูู</option>
                                <option value="poor">ุถุนูู</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ุงูููุน</label>
                            <select class="form-select" id="typeFilter">
                                <option value="">ุงููู</option>
                                <option value="PDF">PDF</option>
                                <option value="DOCX">Word</option>
                                <option value="TXT">Text</option>
                                <option value="MD">Markdown</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Business Fundamentals Panel (Hidden by default) -->
            <div class="card shadow-sm mb-4" id="businessFundamentalsPanel" style="display:none;">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">๐ ุฃุณุงุณูุงุช ุงูุฃุนูุงู - Business Fundamentals</h5>
                        <button class="btn btn-sm btn-light" onclick="closePanels()"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <strong>๐ก ุงููุตู:</strong> ูุณู ูุฑุฌุนู ุดุงูู ูุญุชูู ุนูู ุงูููุงููู ูุงูุฃุฏูุงุช ุงูุฃุณุงุณูุฉ ุงูุชู ูุนุชูุฏ ุนูููุง ูู ูุดุฑูุน ุงุณุชุดุงุฑู. ูุณุชุฎุฏูู ุฌููุน ุงููููุงุก ูุฃุณุงุณ ููุชูุณูุฑ ูุงูุชุญููู.
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <h6 class="border-bottom pb-2">๐ ุชุนุฑููุงุช ุงูุฃุนูุงู</h6>
                            <ul class="list-unstyled">
                                <li><strong>ูููุฐุฌ ุงูุฃุนูุงู:</strong> ุงูุทุฑููุฉ ุงูุชู ุชุญูู ุงูุดุฑูุฉ ุจูุง ุงูุฅูุฑุงุฏุงุช</li>
                                <li><strong>Value Proposition:</strong> ุงููููุฉ ุงูููุฏูุฉ ููุนููุงุก</li>
                                <li><strong>Business Model Canvas:</strong> 9 ุนูุงุตุฑ ุฃุณุงุณูุฉ ูููููุฐุฌ</li>
                            </ul>
                        </div>
                        <div class="col-md-6 mb-4">
                            <h6 class="border-bottom pb-2">๐ ุงููุคุดุฑุงุช ุงููุงููุฉ ุงูุฃุณุงุณูุฉ</h6>
                            <ul class="list-unstyled">
                                <li><strong>ROI:</strong> ุงูุนุงุฆุฏ ุนูู ุงูุงุณุชุซูุงุฑ</li>
                                <li><strong>Market Size:</strong> ุญุฌู ุงูุณูู ุงูุฅุฌูุงูู (TAM, SAM, SOM)</li>
                                <li><strong>CAC:</strong> ุชูููุฉ ุงูุญุตูู ุนูู ุนููู</li>
                                <li><strong>CLV:</strong> ูููุฉ ุญูุงุฉ ุงูุนููู</li>
                                <li><strong>Break-even:</strong> ููุทุฉ ุงูุชุนุงุฏู</li>
                            </ul>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <h6 class="border-bottom pb-2">๐ฏ ุงูุฅุทุงุฑุงุช ุงูุงุณุชุฑุงุชูุฌูุฉ</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6>McKinsey 7S</h6>
                                            <small>ุชุญููู 7 ุนูุงูู ุฏุงุฎููุฉ: ุงูุงุณุชุฑุงุชูุฌูุฉุ ุงูููููุ ุงูุฃูุธูุฉุ ุงูููุงุฑุงุชุ ุงูุฃุณููุจุ ุงูููุธูููุ ุงูููู ุงููุดุชุฑูุฉ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6>BCG Matrix</h6>
                                            <small>ุชุญููู ูุญูุธุฉ ุงูุฃุนูุงู ุจูุงุกู ุนูู ุงูููู ูุงูุญุตุฉ ุงูุณูููุฉ: ูุฌููุ ุฃุจูุงุฑ ููุฏูุฉุ ุนูุงูุงุช ุงุณุชููุงูุ ููุงุจ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light mt-3">
                                        <div class="card-body">
                                            <h6>Porter's Five Forces</h6>
                                            <small>ุชุญููู ุงูููู ุงูุชูุงูุณูุฉ: ุงูููุงูุณูู ุงูุฌุฏุฏุ ุงูุจุงุฆุนููุ ุงููุดุชุฑููุ ุงูุจุฏุงุฆูุ ุงูุดุฏุฉ ุงูุชูุงูุณูุฉ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light mt-3">
                                        <div class="card-body">
                                            <h6>SWOT Analysis</h6>
                                            <small>ููุงุท ุงูููุฉ ูุงูุถุนู ูุงููุฑุต ูุงูุชูุฏูุฏุงุช</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <strong>โ ุงูุงุณุชุฎุฏุงู ุจูุงุณุทุฉ ุงููููุงุก:</strong>
                        <ul class="mb-0 mt-2">
                            <li>๐ค <strong>ูููู ุงูุชุฎุทูุท ุงูุงุณุชุฑุงุชูุฌู:</strong> ุงุณุชุฎุฏุงู ุฅุทุงุฑ 7S ู Porter</li>
                            <li>๐ค <strong>ูููู ุฏุฑุงุณุงุช ุงูุฌุฏูู:</strong> ุญุณุงุจุงุช ROI ูุงูู Market Size</li>
                            <li>๐ค <strong>ูููู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ:</strong> ุงููููู ุงูุชูุธููู ูุงูุซูุงูุฉ</li>
                            <li>๐ค <strong>ูููู ุงูุชูููู:</strong> ุงููุคุดุฑุงุช ุงููุงููุฉ ูุงูุชุฏูู ุงูููุฏู</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Documents Table -->
            <div class="card shadow-sm" id="documentsPanel">
                <div class="card-header bg-light">
                    <h5 class="mb-0">๐ ุงููููุงุช ุงููุฑููุนุฉ</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 30px;">๐</th>
                                <th>ุงุณู ุงูููู</th>
                                <th>ุงูููุน</th>
                                <th>ุงููุณู</th>
                                <th>Chunks</th>
                                <th>ุงูุฌูุฏุฉ</th>
                                <th>ุงูุชุงุฑูุฎ</th>
                                <th style="width: 200px;">ุงูุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody id="documentsTable">
                            {% for doc in documents %}
                            <tr>
                                <td>
                                    <button class="btn btn-sm btn-outline-warning" onclick="pinDocument({{ doc.id }})" title="ุชุซุจูุช">
                                        <i class="fas fa-thumbtack"></i>
                                    </button>
                                </td>
                                <td>
                                    <i class="fas fa-file"></i> 
                                    <strong>{{ doc.filename }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ doc.file_type|upper }}</span>
                                </td>
                                <td>
                                    {% if doc.embeddings %}
                                        {% set meta = doc.embeddings|from_json %}
                                        {{ meta.get('category', 'ุนุงู') }}
                                    {% else %}
                                        ุนุงู
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-info">{{ documents|length }}</span></td>
                                <td>
                                    <span class="quality-badge quality-good">ุฌูุฏ</span>
                                </td>
                                <td>{{ doc.uploaded_at.strftime('%Y-%m-%d') if doc.uploaded_at else '-' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-info" onclick="previewDocument({{ doc.id }})" title="ูุนุงููุฉ">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-warning" onclick="editMetadata({{ doc.id }})" title="ุชุนุฏูู">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-success" onclick="reembedDocument({{ doc.id }})" title="ุฅุนุงุฏุฉ ูุนุงูุฌุฉ">
                                            <i class="fas fa-sync"></i>
                                        </button>
                                        <button class="btn btn-danger" onclick="deleteDocument({{ doc.id }})" title="ุญุฐู">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    ูุง ุชูุฌุฏ ูููุงุช ูุฑููุนุฉ ุญุงููุงู
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">๐ค ุฑูุน ููู ุฌุฏูุฏ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">ุงุฎุชุฑ ุงูููู</label>
                    <input type="file" class="form-control" id="fileInput" accept=".pdf,.docx,.txt,.md,.doc">
                    <small class="text-muted">ุฃููุงุน ูุฏุนููุฉ: PDF, DOCX, TXT, MD, DOC</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">ุงููุณู</label>
                    <select class="form-select" id="categorySelect">
                        <option value="Business Fundamentals">ุฃุณุงุณูุงุช ุงูุฃุนูุงู</option>
                        <option value="Feasibility Studies">ุฏุฑุงุณุงุช ุงูุฌุฏูู</option>
                        <option value="Strategic Planning">ุงูุชุฎุทูุท ุงูุงุณุชุฑุงุชูุฌู</option>
                        <option value="HR">ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ</option>
                        <option value="Finance">ุงูุชูููู</option>
                        <option value="Market Research">ุฃุจุญุงุซ ุงูุณูู</option>
                        <option value="Operations">ุงูุนูููุงุช</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">ุงููุณูู (Tags)</label>
                    <input type="text" class="form-control" id="tagsInput" placeholder="ูุตู ุจูู ุงููุณูู ุจููุงุตู">
                </div>
                <div id="uploadProgress" style="display:none;">
                    <div class="text-center mb-2">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ุฌุงุฑู ุงููุนุงูุฌุฉ...</span>
                        </div>
                    </div>
                    <ul id="processingSteps" class="list-group">
                        <li class="list-group-item"><i class="fas fa-check text-success"></i> ุงุณุชุฎุฑุงุฌ ุงููุต</li>
                        <li class="list-group-item"><i class="fas fa-hourglass-start text-warning"></i> ุชูุธูู ุงููุญุชูู</li>
                        <li class="list-group-item"><i class="fas fa-hourglass-start text-warning"></i> ุชูุณูู Chunks</li>
                        <li class="list-group-item"><i class="fas fa-hourglass-start text-warning"></i> ุฅูุดุงุก Embeddings</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                <button type="button" class="btn btn-primary" id="uploadBtn" onclick="uploadFile()">
                    <i class="fas fa-cloud-upload-alt"></i> ุฑูุน
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Template Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">โ ุฅูุดุงุก ูุงูุจ ุฌุฏูุฏ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">ูุฑูุจุงู - ุณูุชู ุฅุถุงูุฉ ูุฐู ุงูููุฒุฉ ูุฑูุจุงู</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script>
const lang = 'ar';

// Toggle Filters
document.getElementById('searchToggle').addEventListener('click', () => {
    const panel = document.getElementById('filtersPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
});

// Upload File
async function uploadFile() {
    const fileInput = document.getElementById('fileInput');
    const categorySelect = document.getElementById('categorySelect');
    const tagsInput = document.getElementById('tagsInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    
    if (!fileInput.files.length) {
        Swal.fire('ุชุญุฐูุฑ', 'ุงุฎุชุฑ ูููุงู', 'warning');
        return;
    }
    
    uploadBtn.disabled = true;
    uploadProgress.style.display = 'block';
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('category', categorySelect.value);
    formData.append('tags', tagsInput.value);
    
    try {
        const response = await fetch('/admin/knowledge/api/documents', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            uploadProgress.style.display = 'none';
            Swal.fire({
                icon: 'success',
                title: 'ูุฌุงุญ!',
                text: 'ุชู ุฑูุน ุงูููู ุจูุฌุงุญ',
                didClose: () => location.reload()
            });
        } else {
            const error = await response.json();
            Swal.fire('ุฎุทุฃ', error.error || 'ูุดู ุงูุฑูุน', 'error');
        }
    } catch (error) {
        Swal.fire('ุฎุทุฃ', error.message, 'error');
    } finally {
        uploadBtn.disabled = false;
        uploadProgress.style.display = 'none';
    }
}

// Preview Document
function previewDocument(docId) {
    Swal.fire('ูุฑูุจุงู', 'ุณูุชู ุฅุถุงูุฉ ูุฐู ุงูููุฒุฉ ูุฑูุจุงู', 'info');
}

// Edit Metadata
function editMetadata(docId) {
    Swal.fire('ูุฑูุจุงู', 'ุณูุชู ุฅุถุงูุฉ ูุญุฑุฑ ุงูุจูุงูุงุช ุงููุตููุฉ ูุฑูุจุงู', 'info');
}

// Re-embed Document
async function reembedDocument(docId) {
    Swal.fire({
        icon: 'info',
        title: 'ุฅุนุงุฏุฉ ุงููุนุงูุฌุฉ',
        text: 'ุฌุงุฑู ุฅุนุงุฏุฉ ูุนุงูุฌุฉ ุงูููู...',
        allowOutsideClick: false,
        didOpen: async () => {
            Swal.showLoading();
            try {
                const response = await fetch(`/admin/knowledge/api/documents/${docId}/re-embed`, {
                    method: 'POST'
                });
                if (response.ok) {
                    Swal.fire('ุชู', 'ุชู ุฅุนุงุฏุฉ ุงููุนุงูุฌุฉ ุจูุฌุงุญ', 'success').then(() => location.reload());
                }
            } catch (error) {
                Swal.fire('ุฎุทุฃ', error.message, 'error');
            }
        }
    });
}

// Delete Document
async function deleteDocument(docId) {
    Swal.fire({
        icon: 'question',
        title: 'ุชุฃููุฏ ุงูุญุฐู',
        text: 'ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงููููุ',
        showCancelButton: true,
        confirmButtonText: 'ูุนูุ ุงุญุฐูู',
        cancelButtonText: 'ุฅูุบุงุก'
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const response = await fetch(`/admin/knowledge/api/documents/${docId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    Swal.fire('ุชู ุงูุญุฐู', 'ุชู ุงูุญุฐู ุจูุฌุงุญ', 'success').then(() => location.reload());
                }
            } catch (error) {
                Swal.fire('ุฎุทุฃ', error.message, 'error');
            }
        }
    });
}

// Pin Document
function pinDocument(docId) {
    Swal.fire('ูุฑูุจุงู', 'ุณูุชู ุฅุถุงูุฉ ููุฒุฉ ุงูุชุซุจูุช ูุฑูุจุงู', 'info');
}

// Close All Panels
function closePanels() {
    document.getElementById('businessFundamentalsPanel').style.display = 'none';
    document.getElementById('documentsPanel').style.display = 'block';
    document.querySelectorAll('.kb-sidebar .nav-link').forEach(l => l.classList.remove('active'));
    document.querySelector('[data-category="all"]').classList.add('active');
}

// Sidebar Navigation
document.querySelectorAll('.kb-sidebar .nav-link').forEach(link => {
    link.addEventListener('click', (e) => {
        const href = link.getAttribute('href');
        // If it's an external link (starts with /), allow normal navigation
        if (href && href.startsWith('/')) {
            return; // Let the link work normally
        }
        
        e.preventDefault();
        document.querySelectorAll('.kb-sidebar .nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');

        const category = link.getAttribute('data-category');
        const documentsPanel = document.getElementById('documentsPanel');
        const businessPanel = document.getElementById('businessFundamentalsPanel');

        if (category === 'business') {
            documentsPanel.style.display = 'none';
            businessPanel.style.display = 'block';
        } else {
            businessPanel.style.display = 'none';
            documentsPanel.style.display = 'block';
        }
    });
});
</script>
{% endblock %}
