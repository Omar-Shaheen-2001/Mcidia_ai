{% extends "admin/base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    .biz-container {
        display: flex;
        height: calc(100vh - 100px);
    }
    .biz-sidebar { width: 250px; border-right: 1px solid #ddd; overflow-y: auto; padding: 20px; }
    .biz-main { flex: 1; display: flex; flex-direction: column; }
    .biz-header { background: white; border-bottom: 1px solid #ddd; padding: 20px; }
    .biz-content { flex: 1; overflow-y: auto; padding: 20px; }
    .biz-preview { 
        width: 350px; 
        border-left: 1px solid #ddd; 
        overflow-y: auto; 
        padding: 20px; 
        background: #f8f9fa; 
        display: none; 
        box-shadow: -2px 0 8px rgba(0,0,0,0.1);
    }
    .preview-item { margin-bottom: 20px; }
    .preview-item-label { font-size: 0.85rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
    .preview-item-value { font-size: 0.95rem; color: #333; word-break: break-word; }
    .preview-badge { display: inline-block; background: #007bff; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; margin-bottom: 8px; }
    .preview-tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .preview-tag { display: inline-block; background: #e9ecef; color: #495057; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; }
    .preview-divider { border-top: 1px solid #ddd; margin: 15px 0; }
    @media (max-width: 768px) {
        .biz-preview { width: 100%; border-left: none; border-top: 1px solid #ddd; padding: 15px; }
        .biz-container { flex-direction: column; }
        .biz-sidebar { width: 100%; border-right: none; border-bottom: 1px solid #ddd; }
    }
    .biz-sidebar .nav-link { padding: 10px 15px; cursor: pointer; border-radius: 5px; margin-bottom: 10px; transition: all 0.3s; display: block; color: #333; }
    .biz-sidebar .nav-link:hover { background: #f0f0f0; }
    .biz-sidebar .nav-link.active { background: #007bff; color: white; }
    .search-box { position: relative; }
    .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; display: none; max-height: 300px; overflow-y: auto; z-index: 1000; }
    .suggestions.show { display: block; }
    .suggestion-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; }
    .suggestion-item:hover { background: #f0f0f0; }
    .quality-circle { width: 20px; height: 20px; border-radius: 50%; display: inline-block; }
    .quality-high { background: #28a745; }
    .quality-medium { background: #ffc107; }
    .quality-low { background: #dc3545; }
    .view-toggle { display: flex; gap: 10px; }
    .view-toggle button { padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
    .view-toggle button.active { background: #007bff; color: white; border-color: #007bff; }
    .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .doc-grid-item { border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; }
    .tag { display: inline-block; background: #e9ecef; color: #495057; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 5px; }
    .empty-state { text-align: center; padding: 40px; color: #999; }
    .step-indicator { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .step { text-align: center; flex: 1; }
    .step.active { color: #007bff; font-weight: bold; }
    .step.done::before { content: 'âœ“'; color: #28a745; font-weight: bold; }
    .progress-step { background: #e9ecef; padding: 10px; border-radius: 4px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    .progress-step.done { background: #d4edda; }
</style>

<div class="biz-container">
    <!-- Sidebar Navigation -->
    <div class="biz-sidebar">
        <h5 class="mb-4">ğŸ“š Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</h5>
        <a href="#" class="nav-link active" data-filter="all" onclick="filterByCategory('all', event)">ğŸ“„ Ø§Ù„Ù…Ù„ÙØ§Øª</a>
        <a href="#" class="nav-link" data-filter="definitions" onclick="filterByCategory('Definition', event)">ğŸ“– Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª</a>
        <a href="#" class="nav-link" data-filter="frameworks" onclick="filterByCategory('Framework', event)">ğŸ¯ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª</a>
        <a href="#" class="nav-link" data-filter="guides" onclick="filterByCategory('Guide', event)">ğŸ“š Ø§Ù„Ø£Ø¯Ù„Ø©</a>
        <a href="#" class="nav-link" data-filter="templates" onclick="filterByCategory('Template', event)">ğŸ“‹ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨</a>
    </div>

    <!-- Main Content -->
    <div class="biz-main">
        <!-- Top Bar -->
        <div class="biz-header">
            <div class="row align-items-center mb-3">
                <div class="col-md-8">
                    <h4 class="mb-0">ğŸ“š Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ - Business Fundamentals</h4>
                </div>
                <div class="col-md-4 text-end">
                    <div class="view-toggle">
                        <button class="active" onclick="switchView('list')" title="List View">
                            <i class="fas fa-list"></i>
                        </button>
                        <button onclick="switchView('grid')" title="Grid View">
                            <i class="fas fa-th"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Search & Filters -->
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <div class="search-box">
                        <input type="text" class="form-control" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„â€¦" autocomplete="off">
                        <div class="suggestions" id="suggestions"></div>
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterType">
                        <option value="">Ø§Ù„Ù†ÙˆØ¹</option>
                        <option value="Framework">Ø¥Ø·Ø§Ø± Ø¹Ù…Ù„</option>
                        <option value="Template">Ù‚Ø§Ù„Ø¨</option>
                        <option value="Guide">Ø¯Ù„ÙŠÙ„</option>
                        <option value="Definition">ØªØ¹Ø±ÙŠÙ</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterQuality">
                        <option value="">Ø§Ù„Ø¬ÙˆØ¯Ø©</option>
                        <option value="high">Ø¹Ø§Ù„ÙŠØ©</option>
                        <option value="medium">Ù…ØªÙˆØ³Ø·Ø©</option>
                        <option value="low">Ù…Ù†Ø®ÙØ¶Ø©</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="sortBy">
                        <option value="recent">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
                        <option value="oldest">Ø§Ù„Ø£Ù‚Ø¯Ù…</option>
                        <option value="quality">Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø©</option>
                        <option value="name">Ø§Ù„Ø£Ø¨Ø¬Ø¯ÙŠ</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-md-12">
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-cloud-upload-alt"></i> Ø±ÙØ¹ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="biz-content">
            <div id="listView">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ğŸ“„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„ÙˆØ³ÙˆÙ…</th>
                                <th>Ø§Ù„Ø¬ÙˆØ¯Ø©</th>
                                <th>Ø§Ù„Ø­Ø¬Ù…</th>
                                <th>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="documentsList"></tbody>
                    </table>
                </div>
                <div id="emptyState" class="empty-state" style="display:none;">
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….</p>
                    <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        ğŸ“¤ Ø±ÙØ¹ Ù…Ù„ÙÙƒ Ø§Ù„Ø£ÙˆÙ„
                    </button>
                </div>
            </div>

            <div id="gridView" style="display:none;" class="grid-view"></div>
        </div>
    </div>

    <!-- Preview Panel -->
    <div class="biz-preview" id="previewPanel">
        <button class="btn btn-sm btn-outline-secondary mb-3 w-100" onclick="closePreview()">
            <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
        </button>
        <div id="previewContent"></div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ - Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="step-indicator mb-4">
                    <div class="step active">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù</div>
                    <div class="step">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
                    <div class="step">Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
                    <div class="step">Ø§Ù„ØªØ£ÙƒÙŠØ¯</div>
                </div>

                <div id="step1">
                    <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù</label>
                    <input type="file" class="form-control mb-3" id="fileInput" accept=".pdf,.docx,.txt,.md,.doc">
                    <small class="text-muted">Ø£Ù†ÙˆØ§Ø¹ Ù…Ø¯Ø¹ÙˆÙ…Ø©: PDF, DOCX, TXT, Markdown</small>
                </div>

                <div id="step2" style="display:none;">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                        <input type="text" class="form-control" id="docTitle">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ù†ÙˆØ¹</label>
                        <select class="form-select" id="docType">
                            <option value="Definition">ØªØ¹Ø±ÙŠÙ</option>
                            <option value="Framework">Ø¥Ø·Ø§Ø± Ø¹Ù…Ù„</option>
                            <option value="Guide">Ø¯Ù„ÙŠÙ„</option>
                            <option value="Template">Ù‚Ø§Ù„Ø¨</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙˆØ³ÙˆÙ…</label>
                        <input type="text" class="form-control" id="docTags" placeholder="Market, Strategy, Finance">
                    </div>
                </div>

                <div id="step3" style="display:none;">
                    <div class="progress-step done"><span>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ</span></div>
                    <div class="progress-step done"><span>ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</span></div>
                    <div class="progress-step"><span>ØªÙ‚Ø³ÙŠÙ… Chunks</span><div class="spinner-border spinner-border-sm ms-auto"></div></div>
                    <div class="progress-step"><span>Ø¥Ù†Ø´Ø§Ø¡ Embeddings</span></div>
                    <div class="progress-step"><span>ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø©</span></div>
                </div>

                <div id="step4" style="display:none;">
                    <div class="alert alert-success">
                        <strong>âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!</strong>
                        <p class="mb-0 mt-2">ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù‚Ø³Ù… Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button type="button" class="btn btn-success" id="uploadBtnFinal" onclick="finalUpload()" style="display:none;">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script>
let currentStep = 1;
let currentFilter = 'all';
let documents = [
    { id: 1, title: 'Business Model Canvas', type: 'Framework', tags: ['Business', 'Model'], quality: 'high', date: '2025-11-26', size: '2.5 MB' },
    { id: 2, title: 'ROI Calculator', type: 'Template', tags: ['Finance', 'ROI'], quality: 'high', date: '2025-11-25', size: '1.2 MB' },
    { id: 3, title: 'Market Size Analysis', type: 'Guide', tags: ['Market', 'Strategy'], quality: 'medium', date: '2025-11-24', size: '3.1 MB' },
    { id: 4, title: 'ROI Definition', type: 'Definition', tags: ['Finance'], quality: 'high', date: '2025-11-23', size: '0.8 MB' },
];

const suggestions = ['ROI', 'Business Model Canvas', 'McKinsey 7S', 'Porter 5 Forces', 'SWOT', 'Break-even', 'Market Size', 'CAC', 'CLV'];

function loadDocuments() {
    const saved = localStorage.getItem('bf-documents');
    if (saved) {
        try {
            documents = JSON.parse(saved);
        } catch (e) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', e);
        }
    }
}

function saveDocuments() {
    localStorage.setItem('bf-documents', JSON.stringify(documents));
}

document.addEventListener('DOMContentLoaded', () => {
    loadDocuments();
    renderDocuments();
    setupSearch();
    setupFilters();
});

function renderDocuments() {
    const tbody = document.getElementById('documentsList');
    const gridView = document.getElementById('gridView');
    tbody.innerHTML = '';
    gridView.innerHTML = '';
    
    let filteredDocs = documents;
    if (currentFilter !== 'all') {
        filteredDocs = documents.filter(d => d.type === currentFilter);
    }
    
    if (filteredDocs.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        return;
    }
    document.getElementById('emptyState').style.display = 'none';
    
    filteredDocs.forEach(doc => {
        const qualityCircle = `<span class="quality-circle quality-${doc.quality}"></span>`;
        const qualityLabel = doc.quality === 'high' ? 'â­â­â­' : doc.quality === 'medium' ? 'â­â­' : 'â­';
        
        // List View
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><a href="#" onclick="showPreview(${doc.id}); return false;"><strong>${doc.title}</strong></a></td>
            <td><span class="badge bg-secondary">${doc.type}</span></td>
            <td>${doc.tags.map(t => `<span class="tag">${t}</span>`).join('')}</td>
            <td>${qualityCircle}</td>
            <td>${doc.size}</td>
            <td>${doc.date}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-info" onclick="showPreview(${doc.id})"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-danger" onclick="deleteDocument(${doc.id})"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
        
        // Grid View
        const gridItem = document.createElement('div');
        gridItem.className = 'doc-grid-item';
        gridItem.innerHTML = `
            <div style="text-align: center;">
                <h6 style="margin: 0 0 10px 0; color: #007bff; min-height: 40px; word-wrap: break-word;">${doc.title}</h6>
                <p style="margin: 0 0 8px 0; font-size: 0.85rem; color: #999;">${doc.type}</p>
                <div style="margin-bottom: 10px; display: flex; justify-content: center; gap: 5px; flex-wrap: wrap;">
                    ${doc.tags.map(t => `<span class="preview-tag">${t}</span>`).join('')}
                </div>
                <p style="margin: 0 0 8px 0; font-size: 0.85rem;">Ø§Ù„Ø¬ÙˆØ¯Ø©: ${qualityLabel}</p>
                <p style="margin: 0 0 12px 0; font-size: 0.8rem; color: #999;">${doc.date}</p>
                <div style="display: flex; gap: 5px; justify-content: center;">
                    <button class="btn btn-sm btn-primary" onclick="showPreview(${doc.id})"><i class="fas fa-eye"></i> Ø¹Ø±Ø¶</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDocument(${doc.id})"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;
        gridView.appendChild(gridItem);
    });
}

function filterByCategory(filter, event) {
    event.preventDefault();
    currentFilter = filter;
    
    document.querySelectorAll('.biz-sidebar .nav-link').forEach(l => l.classList.remove('active'));
    event.target.closest('.nav-link').classList.add('active');
    
    renderDocuments();
}

function setupSearch() {
    const input = document.getElementById('searchInput');
    const suggestionsDiv = document.getElementById('suggestions');
    
    input.addEventListener('focus', () => {
        suggestionsDiv.innerHTML = suggestions.map(s => `<div class="suggestion-item" onclick="selectSuggestion('${s}')">${s}</div>`).join('');
        suggestionsDiv.classList.add('show');
    });
    
    input.addEventListener('input', (e) => {
        const val = e.target.value.toLowerCase();
        const filtered = suggestions.filter(s => s.toLowerCase().includes(val));
        suggestionsDiv.innerHTML = filtered.map(s => `<div class="suggestion-item" onclick="selectSuggestion('${s}')">${s}</div>`).join('');
    });
    
    document.addEventListener('click', (e) => {
        if (!input.contains(e.target)) suggestionsDiv.classList.remove('show');
    });
}

function selectSuggestion(text) {
    document.getElementById('searchInput').value = text;
    document.getElementById('suggestions').classList.remove('show');
}

function setupFilters() {
    document.getElementById('filterType').addEventListener('change', renderDocuments);
    document.getElementById('filterQuality').addEventListener('change', renderDocuments);
    document.getElementById('sortBy').addEventListener('change', renderDocuments);
}

function switchView(view) {
    document.getElementById('listView').style.display = view === 'list' ? 'block' : 'none';
    document.getElementById('gridView').style.display = view === 'grid' ? 'grid' : 'none';
}

function showPreview(id) {
    const doc = documents.find(d => d.id === id);
    const panel = document.getElementById('previewPanel');
    const content = document.getElementById('previewContent');
    
    const qualityLabel = doc.quality === 'high' ? 'Ø¹Ø§Ù„ÙŠØ© â­' : doc.quality === 'medium' ? 'Ù…ØªÙˆØ³Ø·Ø©' : 'Ù…Ù†Ø®ÙØ¶Ø©';
    const qualityColor = doc.quality === 'high' ? '#28a745' : doc.quality === 'medium' ? '#ffc107' : '#dc3545';
    
    content.innerHTML = `
        <div class="preview-item">
            <div class="preview-item-label">ğŸ“„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
            <h5 style="color: #007bff; margin: 0; word-wrap: break-word;">${doc.title}</h5>
        </div>
        
        <div class="preview-divider"></div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ·ï¸ Ø§Ù„Ù†ÙˆØ¹</div>
            <div class="preview-badge">${doc.type}</div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">â­ Ø§Ù„Ø¬ÙˆØ¯Ø©</div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span class="quality-circle" style="background: ${qualityColor}; width: 16px; height: 16px;"></span>
                <span class="preview-item-value">${qualityLabel}</span>
            </div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ·ï¸ Ø§Ù„ÙˆØ³ÙˆÙ…</div>
            <div class="preview-tags-container">
                ${doc.tags.map(t => `<span class="preview-tag">${t}</span>`).join('')}
            </div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ“Š Ø§Ù„Ø­Ø¬Ù…</div>
            <div class="preview-item-value">${doc.size}</div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</div>
            <div class="preview-item-value">${doc.date}</div>
        </div>
    `;
    panel.style.display = 'block';
}

function closePreview() {
    document.getElementById('previewPanel').style.display = 'none';
}

function deleteDocument(id) {
    Swal.fire({icon: 'question', title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ', showCancelButton: true, confirmButtonText: 'Ù†Ø¹Ù…', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'}).then(r => {
        if (r.isConfirmed) {
            documents = documents.filter(d => d.id !== id);
            saveDocuments();
            renderDocuments();
            Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', '', 'success');
        }
    });
}

function nextStep() {
    if (currentStep === 1) {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.value) {
            Swal.fire({icon: 'error', title: 'ØªØ­Ø°ÙŠØ±', text: 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹'});
            return;
        }
        currentStep = 2;
    } else if (currentStep === 2) {
        const title = document.getElementById('docTitle').value.trim();
        const type = document.getElementById('docType').value.trim();
        if (!title || !type) {
            Swal.fire({icon: 'error', title: 'ØªØ­Ø°ÙŠØ±', text: 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'});
            return;
        }
        // Show processing step
        currentStep = 3;
        document.querySelectorAll('[id^="step"]').forEach(e => e.style.display = 'none');
        document.getElementById('step3').style.display = 'block';
        document.getElementById('nextBtn').disabled = true;
        
        // Simulate processing with delays
        simulateProcessing();
    } else {
        currentStep++;
        document.querySelectorAll('[id^="step"]').forEach(e => e.style.display = 'none');
        document.getElementById(`step${currentStep}`).style.display = 'block';
        
        if (currentStep === 4) {
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('uploadBtnFinal').style.display = 'inline-block';
        }
    }
}

function simulateProcessing() {
    const steps = document.querySelectorAll('#step3 .progress-step');
    let stepIndex = 2; // Start from "Chunking" (index 2)
    
    function markStepDone() {
        if (stepIndex < steps.length) {
            steps[stepIndex].classList.add('done');
            const spinner = steps[stepIndex].querySelector('.spinner-border');
            if (spinner) spinner.style.display = 'none';
            stepIndex++;
            setTimeout(markStepDone, 800);
        } else {
            // All done, move to step 4
            setTimeout(() => {
                currentStep = 4;
                document.getElementById('step3').style.display = 'none';
                document.getElementById('step4').style.display = 'block';
                document.getElementById('nextBtn').disabled = false;
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('uploadBtnFinal').style.display = 'inline-block';
            }, 500);
        }
    }
    markStepDone();
}

function finalUpload() {
    const title = document.getElementById('docTitle').value;
    const type = document.getElementById('docType').value;
    const tags = document.getElementById('docTags').value.split(',').map(t => t.trim());
    
    const newDoc = {
        id: documents.length + 1,
        title: title || 'Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯',
        type: type,
        tags: tags,
        quality: 'medium',
        date: new Date().toISOString().split('T')[0],
        size: '1.0 MB'
    };
    
    documents.push(newDoc);
    saveDocuments();
    
    Swal.fire({icon: 'success', title: 'Ù†Ø¬Ø§Ø­!', text: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­', didClose: () => {
        document.getElementById('uploadModal').querySelector('.btn-close').click();
        currentStep = 1;
        document.querySelectorAll('[id^="step"]').forEach(e => e.style.display = 'none');
        document.getElementById('step1').style.display = 'block';
        document.getElementById('nextBtn').style.display = 'inline-block';
        document.getElementById('uploadBtnFinal').style.display = 'none';
        document.getElementById('fileInput').value = '';
        document.getElementById('docTitle').value = '';
        document.getElementById('docTags').value = '';
        renderDocuments();
    }});
}
</script>
{% endblock %}
