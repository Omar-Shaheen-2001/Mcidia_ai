{% extends "admin/base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    .fs-container { display: flex; height: calc(100vh - 100px); }
    .fs-sidebar { width: 250px; border-right: 1px solid #ddd; overflow-y: auto; padding: 20px; }
    .fs-main { flex: 1; display: flex; flex-direction: column; }
    .fs-header { background: white; border-bottom: 1px solid #ddd; padding: 20px; }
    .fs-content { flex: 1; overflow-y: auto; padding: 20px; }
    .fs-preview { width: 400px; border-left: 1px solid #ddd; overflow-y: auto; padding: 20px; background: #f8f9fa; display: none; box-shadow: -2px 0 8px rgba(0,0,0,0.1); }
    .fs-sidebar .nav-link { padding: 10px 15px; cursor: pointer; border-radius: 5px; margin-bottom: 10px; transition: all 0.3s; display: block; color: #333; }
    .fs-sidebar .nav-link:hover { background: #f0f0f0; }
    .fs-sidebar .nav-link.active { background: #28a745; color: white; }
    .search-box { position: relative; }
    .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; display: none; max-height: 300px; overflow-y: auto; z-index: 1000; }
    .suggestions.show { display: block; }
    .suggestion-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; }
    .suggestion-item:hover { background: #f0f0f0; }
    .quality-circle { width: 20px; height: 20px; border-radius: 50%; display: inline-block; }
    .quality-high { background: #28a745; }
    .quality-medium { background: #ffc107; }
    .quality-low { background: #dc3545; }
    .view-toggle { display: flex; gap: 10px; }
    .view-toggle button { padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
    .view-toggle button.active { background: #28a745; color: white; border-color: #28a745; }
    .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .doc-grid-item { border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; background: white; }
    .tag { display: inline-block; background: #e9ecef; color: #495057; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 5px; }
    .empty-state { text-align: center; padding: 40px; color: #999; }
    .step-indicator { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .step { text-align: center; flex: 1; font-size: 0.9rem; }
    .step.active { color: #28a745; font-weight: bold; }
    .step.done::before { content: 'âœ“'; color: #28a745; font-weight: bold; }
    .progress-step { background: #e9ecef; padding: 10px; border-radius: 4px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    .progress-step.done { background: #d4edda; }
    .preview-item { margin-bottom: 20px; }
    .preview-item-label { font-size: 0.85rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
    .preview-item-value { font-size: 0.95rem; color: #333; word-break: break-word; }
    .preview-badge { display: inline-block; background: #28a745; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; margin-bottom: 8px; }
    .preview-tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .preview-tag { display: inline-block; background: #e9ecef; color: #495057; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; }
    .preview-divider { border-top: 1px solid #ddd; margin: 15px 0; }
    .financial-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; margin-right: 5px; }
    .roi-high { background: #d4edda; color: #155724; }
    .roi-med { background: #fff3cd; color: #856404; }
    .roi-low { background: #f8d7da; color: #721c24; }
    .sector-badge { display: inline-block; background: #e7f3ff; color: #004085; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; margin-right: 5px; }
    .action-btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
    .action-btn-group button { font-size: 0.85rem; padding: 8px 12px; }
    .sector-column { color: #28a745; font-weight: 600; }
    @media (max-width: 768px) {
        .fs-preview { width: 100%; border-left: none; border-top: 1px solid #ddd; padding: 15px; }
        .fs-container { flex-direction: column; }
        .fs-sidebar { width: 100%; border-right: none; border-bottom: 1px solid #ddd; }
    }
</style>

<div class="fs-container">
    <!-- Sidebar Navigation -->
    <div class="fs-sidebar">
        <h5 class="mb-4">ğŸ“Š Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ‰</h5>
        <a href="#" class="nav-link active" data-filter="all" onclick="filterByCategory('all', event)">ğŸ“„ Ø§Ù„Ù…Ù„ÙØ§Øª</a>
        <a href="#" class="nav-link" data-filter="cost-data" onclick="filterByCategory('Cost Data', event)">ğŸ’° Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</a>
        <a href="#" class="nav-link" data-filter="market-research" onclick="filterByCategory('Market Study', event)">ğŸ“ˆ Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø³ÙˆÙ‚</a>
        <a href="#" class="nav-link" data-filter="revenue-models" onclick="filterByCategory('Revenue Model', event)">ğŸ’µ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</a>
        <a href="#" class="nav-link" data-filter="templates" onclick="filterByCategory('Feasibility Template', event)">ğŸ“‹ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨</a>
        <a href="#" class="nav-link" data-filter="benchmarks" onclick="filterByCategory('Pricing Benchmarks', event)">ğŸ“Š Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª</a>
    </div>

    <!-- Main Content -->
    <div class="fs-main">
        <!-- Top Bar -->
        <div class="fs-header">
            <div class="row align-items-center mb-3">
                <div class="col-md-8">
                    <h4 class="mb-0">ğŸ“Š Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ‰ - Feasibility Studies</h4>
                </div>
                <div class="col-md-4 text-end">
                    <div class="view-toggle">
                        <button class="active" onclick="switchView('list')" title="List View">
                            <i class="fas fa-list"></i>
                        </button>
                        <button onclick="switchView('grid')" title="Grid View">
                            <i class="fas fa-th"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Search & Filters -->
            <div class="row g-3 mb-3">
                <div class="col-md-5">
                    <div class="search-box">
                        <input type="text" class="form-control" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ‰â€¦" autocomplete="off">
                        <div class="suggestions" id="suggestions"></div>
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterSector">
                        <option value="">Ø§Ù„Ù‚Ø·Ø§Ø¹</option>
                        <option value="Ù…Ø·Ø§Ø¹Ù…">ğŸ½ï¸ Ù…Ø·Ø§Ø¹Ù…</option>
                        <option value="Ù…Ù‚Ø§Ù‡ÙŠ">â˜• Ù…Ù‚Ø§Ù‡ÙŠ</option>
                        <option value="ØªØ¬Ø§Ø±Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©">ğŸ›ï¸ ØªØ¬Ø§Ø±Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
                        <option value="SaaS">ğŸ’» SaaS</option>
                        <option value="ØªØ¹Ù„ÙŠÙ…">ğŸ“š ØªØ¹Ù„ÙŠÙ…</option>
                        <option value="Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª">ğŸšš Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª</option>
                        <option value="Ø¹Ù‚Ø§Ø±">ğŸ¢ Ø¹Ù‚Ø§Ø±</option>
                        <option value="ØµÙ†Ø§Ø¹Ø©">ğŸ­ ØµÙ†Ø§Ø¹Ø©</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterType">
                        <option value="">Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
                        <option value="Cost Data">Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</option>
                        <option value="Revenue Model">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</option>
                        <option value="Market Study">Ø§Ù„Ø³ÙˆÙ‚</option>
                        <option value="Risk">Ø§Ù„Ù…Ø®Ø§Ø·Ø±</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterROI">
                        <option value="">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£Ù‡Ù…ÙŠØ©</option>
                        <option value="high">Ø¹Ø§Ù„ÙŠØ©</option>
                        <option value="medium">Ù…ØªÙˆØ³Ø·Ø©</option>
                        <option value="low">Ù…Ù†Ø®ÙØ¶Ø©</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-md-12">
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-cloud-upload-alt"></i> Ø±ÙØ¹ Ø¯Ø±Ø§Ø³Ø© Ø¬Ø¯ÙˆÙ‰
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="fs-content">
            <div id="listView">
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>ğŸ“„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>ğŸ¢ Ø§Ù„Ù‚Ø·Ø§Ø¹</th>
                                <th>ğŸ“Š Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>â­ Ø§Ù„Ø£Ù‡Ù…ÙŠØ©</th>
                                <th>ğŸ“… Ø§Ù„Ø³Ù†Ø©</th>
                                <th>ğŸ¯ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="documentsList"></tbody>
                    </table>
                </div>
                <div id="emptyState" class="empty-state" style="display:none;">
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø§Ø³Ø§Øª Ø¬Ø¯ÙˆÙ‰ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….</p>
                    <button class="btn btn-success mt-3" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        ğŸ“¤ Ø±ÙØ¹ Ø¯Ø±Ø§Ø³Ø© Ø¬Ø¯ÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>
            </div>

            <div id="gridView" style="display:none;" class="grid-view"></div>
        </div>
    </div>

    <!-- Preview Panel -->
    <div class="fs-preview" id="previewPanel">
        <button class="btn btn-sm btn-outline-secondary mb-3 w-100" onclick="closePreview()">
            <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
        </button>
        <div id="previewContent"></div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">ğŸ“¤ Ø±ÙØ¹ Ø¯Ø±Ø§Ø³Ø© Ø¬Ø¯ÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="step-indicator mb-4">
                    <div class="step active">Ø§Ù„Ù…Ù„Ù</div>
                    <div class="step">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
                    <div class="step">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
                    <div class="step">Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
                    <div class="step">Ø§Ù„ØªØ£ÙƒÙŠØ¯</div>
                </div>

                <!-- Step 1: File Upload -->
                <div id="step1">
                    <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù</label>
                    <input type="file" class="form-control mb-3" id="fileInput" accept=".pdf,.docx,.xlsx,.xls,.txt">
                    <small class="text-muted">Ø£Ù†ÙˆØ§Ø¹ Ù…Ø¯Ø¹ÙˆÙ…Ø©: PDF, DOCX, Excel, TXT</small>
                </div>

                <!-- Step 2: Basic Info -->
                <div id="step2" style="display:none;">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                        <input type="text" class="form-control" id="docTitle">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ù‚Ø·Ø§Ø¹</label>
                        <select class="form-select" id="docSector">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø·Ø§Ø¹</option>
                            <option value="Ù…Ø·Ø§Ø¹Ù…">ğŸ½ï¸ Ù…Ø·Ø§Ø¹Ù…</option>
                            <option value="Ù…Ù‚Ø§Ù‡ÙŠ">â˜• Ù…Ù‚Ø§Ù‡ÙŠ</option>
                            <option value="ØªØ¬Ø§Ø±Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©">ğŸ›ï¸ ØªØ¬Ø§Ø±Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
                            <option value="SaaS">ğŸ’» SaaS</option>
                            <option value="ØªØ¹Ù„ÙŠÙ…">ğŸ“š ØªØ¹Ù„ÙŠÙ…</option>
                            <option value="Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª">ğŸšš Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª</option>
                            <option value="Ø¹Ù‚Ø§Ø±">ğŸ¢ Ø¹Ù‚Ø§Ø±</option>
                            <option value="ØµÙ†Ø§Ø¹Ø©">ğŸ­ ØµÙ†Ø§Ø¹Ø©</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø¯ÙˆÙ„Ø© / Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                        <input type="text" class="form-control" id="docCountry" placeholder="Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŒ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§ØªØŒ Ù…ØµØ±ØŒ Ø¥Ù„Ø®">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
                        <select class="form-select" id="docDataType">
                            <option value="Cost Data">ğŸ’° Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</option>
                            <option value="Revenue Model">ğŸ’µ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</option>
                            <option value="Market Study">ğŸ“ˆ Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø³ÙˆÙ‚</option>
                            <option value="Risk">âš ï¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</option>
                            <option value="CAPEX">ğŸ—ï¸ Ø±Ø£Ø³ Ù…Ø§Ù„ Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ</option>
                        </select>
                    </div>
                </div>

                <!-- Step 3: Financial Data -->
                <div id="step3" style="display:none;">
                    <div class="mb-3">
                        <label class="form-label">Ø³Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
                        <input type="number" class="form-control" id="docYear" placeholder="2025">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¯Ù‚Ø©</label>
                        <select class="form-select" id="docAccuracy">
                            <option value="High Confidence">âœ… Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø«Ù‚Ø©</option>
                            <option value="Medium">ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø©</option>
                            <option value="Low">âš ï¸ Ù…Ù†Ø®ÙØ¶Ø©</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙˆØ³ÙˆÙ… (ÙØµÙ„ Ø¨ÙÙˆØ§ØµÙ„)</label>
                        <input type="text" class="form-control" id="docTags" placeholder="Ù…Ø«Ø§Ù„: Cost, Rent, Labor, COGS">
                    </div>
                </div>

                <!-- Step 4: Processing -->
                <div id="step4" style="display:none;">
                    <div class="progress-step done"><span>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ</span></div>
                    <div class="progress-step done"><span>ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</span></div>
                    <div class="progress-step"><span>ÙƒØ´Ù Ø§Ù„Ù‚Ø·Ø§Ø¹</span><div class="spinner-border spinner-border-sm ms-auto"></div></div>
                    <div class="progress-step"><span>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</span></div>
                    <div class="progress-step"><span>ÙƒØ´Ù Ø§Ù„Ù…Ø®Ø§Ø·Ø±</span></div>
                    <div class="progress-step"><span>ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø©</span></div>
                </div>

                <!-- Step 5: Confirm -->
                <div id="step5" style="display:none;">
                    <div class="alert alert-success">
                        <strong>âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!</strong>
                        <p class="mb-0 mt-2">ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ‰ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ‰.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-success" id="nextBtn" onclick="nextStep()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button type="button" class="btn btn-success" id="uploadBtnFinal" onclick="finalUpload()" style="display:none;">Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script>
let currentStep = 1;
let currentFilter = 'all';
const defaultDocuments = [
    { id: 1, title: 'Ù…ØªÙˆØ³Ø· ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ù…Ø·Ø§Ø¹Ù… Ø§Ù„Ø®Ù„ÙŠØ¬', sector: 'Ù…Ø·Ø§Ø¹Ù…', type: 'Cost Data', roi: 'high', year: 2025, accuracy: 'High Confidence', tags: ['Labor', 'Rent', 'COGS'] },
    { id: 2, title: 'Ø­Ø¬Ù… Ø³ÙˆÙ‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', sector: 'ØªØ¹Ù„ÙŠÙ…', type: 'Market Study', roi: 'high', year: 2024, accuracy: 'High Confidence', tags: ['Market', 'CAGR'] },
    { id: 3, title: 'Ù†Ù…ÙˆØ°Ø¬ Ø¯Ø±Ø§Ø³Ø© Ø¬Ø¯ÙˆÙ‰ Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', sector: 'ØªØ¬Ø§Ø±Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©', type: 'Revenue Model', roi: 'medium', year: 2025, accuracy: 'Medium', tags: ['Revenue', 'Template'] },
    { id: 4, title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø¹Ø§Ø± SaaS', sector: 'SaaS', type: 'Cost Data', roi: 'medium', year: 2025, accuracy: 'Medium', tags: ['Pricing', 'ARR'] },
];

let documents = JSON.parse(JSON.stringify(defaultDocuments));

const suggestions = ['Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ', 'Ø­Ø¬Ù… Ø§Ù„Ø³ÙˆÙ‚', 'Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ†', 'Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø³Ø¹Ø±', 'Ø¯Ø±Ø§Ø³Ø© Ø¬Ø¯ÙˆÙ‰', 'Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„'];

function loadDocuments() {
    const saved = localStorage.getItem('fs-documents');
    if (saved) {
        try {
            const savedDocs = JSON.parse(saved);
            documents = savedDocs.length > 0 ? savedDocs : JSON.parse(JSON.stringify(defaultDocuments));
        } catch (e) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', e);
            documents = JSON.parse(JSON.stringify(defaultDocuments));
        }
    } else {
        documents = JSON.parse(JSON.stringify(defaultDocuments));
    }
}

function saveDocuments() {
    localStorage.setItem('fs-documents', JSON.stringify(documents));
}

document.addEventListener('DOMContentLoaded', () => {
    loadDocuments();
    renderDocuments();
    setupSearch();
    setupFilters();
});

function renderDocuments() {
    const tbody = document.getElementById('documentsList');
    const gridView = document.getElementById('gridView');
    tbody.innerHTML = '';
    gridView.innerHTML = '';
    
    let filteredDocs = documents;
    if (currentFilter !== 'all') {
        filteredDocs = documents.filter(d => d.type === currentFilter);
    }
    
    if (filteredDocs.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        return;
    }
    document.getElementById('emptyState').style.display = 'none';
    
    filteredDocs.forEach(doc => {
        const roiClass = doc.roi === 'high' ? 'roi-high' : doc.roi === 'medium' ? 'roi-med' : 'roi-low';
        const roiLabel = doc.roi === 'high' ? 'â­â­â­' : doc.roi === 'medium' ? 'â­â­' : 'â­';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><a href="#" onclick="showPreview(${doc.id}); return false;"><strong>${doc.title}</strong></a></td>
            <td><span class="sector-column">${doc.sector}</span></td>
            <td><span class="badge bg-info">${doc.type}</span></td>
            <td><span class="financial-badge ${roiClass}">${roiLabel}</span></td>
            <td>${doc.year}</td>
            <td>${doc.accuracy}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-info" onclick="showPreview(${doc.id})"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-danger" onclick="deleteDocument(${doc.id})"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
        
        // Grid View
        const gridItem = document.createElement('div');
        gridItem.className = 'doc-grid-item';
        gridItem.innerHTML = `
            <div style="text-align: center;">
                <h6 style="margin: 0 0 10px 0; color: #28a745; min-height: 40px; word-wrap: break-word;">${doc.title}</h6>
                <p style="margin: 0 0 8px 0;"><span class="sector-badge">${doc.sector}</span></p>
                <p style="margin: 0 0 8px 0; font-size: 0.85rem; color: #666;">${doc.type}</p>
                <p style="margin: 0 0 8px 0;"><span class="financial-badge ${roiClass}">${roiLabel}</span></p>
                <p style="margin: 0 0 8px 0; font-size: 0.8rem; color: #999;">Ø§Ù„Ø³Ù†Ø©: ${doc.year}</p>
                <div style="display: flex; gap: 5px; justify-content: center; margin-top: 12px;">
                    <button class="btn btn-sm btn-success" onclick="showPreview(${doc.id})"><i class="fas fa-eye"></i> Ø¹Ø±Ø¶</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDocument(${doc.id})"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;
        gridView.appendChild(gridItem);
    });
}

function filterByCategory(filter, event) {
    event.preventDefault();
    currentFilter = filter;
    
    document.querySelectorAll('.fs-sidebar .nav-link').forEach(l => l.classList.remove('active'));
    event.target.closest('.nav-link').classList.add('active');
    
    renderDocuments();
}

function setupSearch() {
    const input = document.getElementById('searchInput');
    const suggestionsDiv = document.getElementById('suggestions');
    
    input.addEventListener('focus', () => {
        suggestionsDiv.innerHTML = suggestions.map(s => `<div class="suggestion-item" onclick="selectSuggestion('${s}')">${s}</div>`).join('');
        suggestionsDiv.classList.add('show');
    });
    
    input.addEventListener('input', (e) => {
        const val = e.target.value.toLowerCase();
        const filtered = suggestions.filter(s => s.toLowerCase().includes(val));
        suggestionsDiv.innerHTML = filtered.map(s => `<div class="suggestion-item" onclick="selectSuggestion('${s}')">${s}</div>`).join('');
    });
    
    document.addEventListener('click', (e) => {
        if (!input.contains(e.target)) suggestionsDiv.classList.remove('show');
    });
}

function selectSuggestion(text) {
    document.getElementById('searchInput').value = text;
    document.getElementById('suggestions').classList.remove('show');
}

function setupFilters() {
    document.getElementById('filterSector').addEventListener('change', renderDocuments);
    document.getElementById('filterType').addEventListener('change', renderDocuments);
    document.getElementById('filterROI').addEventListener('change', renderDocuments);
}

function switchView(view) {
    document.getElementById('listView').style.display = view === 'list' ? 'block' : 'none';
    document.getElementById('gridView').style.display = view === 'grid' ? 'grid' : 'none';
}

function showPreview(id) {
    const doc = documents.find(d => d.id === id);
    const panel = document.getElementById('previewPanel');
    const content = document.getElementById('previewContent');
    
    const roiLabel = doc.roi === 'high' ? 'Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ â­â­â­' : doc.roi === 'medium' ? 'Ù…ØªÙˆØ³Ø·Ø© â­â­' : 'Ù…Ù†Ø®ÙØ¶Ø© â­';
    const roiColor = doc.roi === 'high' ? '#28a745' : doc.roi === 'medium' ? '#ffc107' : '#dc3545';
    
    content.innerHTML = `
        <div class="preview-item">
            <div class="preview-item-label">ğŸ“„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
            <h5 style="color: #28a745; margin: 0; word-wrap: break-word;">${doc.title}</h5>
        </div>
        
        <div class="preview-divider"></div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ¢ Ø§Ù„Ù‚Ø·Ø§Ø¹</div>
            <div><span class="sector-badge">${doc.sector}</span></div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ“Š Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
            <div class="preview-badge" style="background: #007bff;">${doc.type}</div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">â­ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£Ù‡Ù…ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: ${roiColor};"></span>
                <span class="preview-item-value">${roiLabel}</span>
            </div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ“… Ø³Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
            <div class="preview-item-value">${doc.year}</div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ¯ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</div>
            <div class="preview-item-value">${doc.accuracy}</div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ·ï¸ Ø§Ù„ÙˆØ³ÙˆÙ…</div>
            <div class="preview-tags-container">
                ${doc.tags.map(t => `<span class="preview-tag">${t}</span>`).join('')}
            </div>
        </div>
        
        <div class="preview-divider"></div>
        
        <div class="action-btn-group">
            <button class="btn btn-sm btn-success"><i class="fas fa-plus"></i> Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø§Ù„ÙŠ</button>
            <button class="btn btn-sm btn-info"><i class="fas fa-chart-bar"></i> Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø§Ù„ÙŠØ©</button>
            <button class="btn btn-sm btn-warning"><i class="fas fa-flask"></i> Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶Ø§Øª</button>
        </div>
    `;
    panel.style.display = 'block';
}

function closePreview() {
    document.getElementById('previewPanel').style.display = 'none';
}

function deleteDocument(id) {
    Swal.fire({icon: 'question', title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©ØŸ', showCancelButton: true, confirmButtonText: 'Ù†Ø¹Ù…', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'}).then(r => {
        if (r.isConfirmed) {
            documents = documents.filter(d => d.id !== id);
            saveDocuments();
            renderDocuments();
            Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', '', 'success');
        }
    });
}

function nextStep() {
    if (currentStep === 1) {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.value) {
            Swal.fire({icon: 'error', title: 'ØªØ­Ø°ÙŠØ±', text: 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹'});
            return;
        }
        currentStep = 2;
    } else if (currentStep === 2) {
        const title = document.getElementById('docTitle').value.trim();
        const sector = document.getElementById('docSector').value.trim();
        if (!title || !sector) {
            Swal.fire({icon: 'error', title: 'ØªØ­Ø°ÙŠØ±', text: 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'});
            return;
        }
        currentStep = 3;
    } else if (currentStep === 3) {
        currentStep = 4;
        document.querySelectorAll('[id^="step"]').forEach(e => e.style.display = 'none');
        document.getElementById('step4').style.display = 'block';
        document.getElementById('nextBtn').disabled = true;
        simulateProcessing();
        return;
    } else {
        currentStep++;
    }
    
    document.querySelectorAll('[id^="step"]').forEach(e => e.style.display = 'none');
    document.getElementById(`step${currentStep}`).style.display = 'block';
    
    if (currentStep === 5) {
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('uploadBtnFinal').style.display = 'inline-block';
    }
}

function simulateProcessing() {
    const steps = document.querySelectorAll('#step4 .progress-step');
    let stepIndex = 2;
    
    function markStepDone() {
        if (stepIndex < steps.length) {
            steps[stepIndex].classList.add('done');
            const spinner = steps[stepIndex].querySelector('.spinner-border');
            if (spinner) spinner.style.display = 'none';
            stepIndex++;
            setTimeout(markStepDone, 600);
        } else {
            setTimeout(() => {
                currentStep = 5;
                document.getElementById('step4').style.display = 'none';
                document.getElementById('step5').style.display = 'block';
                document.getElementById('nextBtn').disabled = false;
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('uploadBtnFinal').style.display = 'inline-block';
            }, 500);
        }
    }
    markStepDone();
}

function finalUpload() {
    const title = document.getElementById('docTitle').value;
    const sector = document.getElementById('docSector').value;
    const dataType = document.getElementById('docDataType').value;
    const tags = document.getElementById('docTags').value.split(',').map(t => t.trim()).filter(t => t);
    const year = parseInt(document.getElementById('docYear').value) || 2025;
    const accuracy = document.getElementById('docAccuracy').value;
    
    const newDoc = {
        id: documents.length + 1,
        title: title || 'Ø¯Ø±Ø§Ø³Ø© Ø¬Ø¯ÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©',
        sector: sector || 'Ø¹Ø§Ù…',
        type: dataType,
        roi: 'medium',
        year: year,
        accuracy: accuracy,
        tags: tags.length > 0 ? tags : ['Ø¬Ø¯ÙŠØ¯']
    };
    
    documents.push(newDoc);
    saveDocuments();
    
    Swal.fire({icon: 'success', title: 'Ù†Ø¬Ø§Ø­!', text: 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­', didClose: () => {
        document.getElementById('uploadModal').querySelector('.btn-close').click();
        currentStep = 1;
        document.querySelectorAll('[id^="step"]').forEach(e => e.style.display = 'none');
        document.getElementById('step1').style.display = 'block';
        document.getElementById('nextBtn').disabled = false;
        document.getElementById('nextBtn').style.display = 'inline-block';
        document.getElementById('uploadBtnFinal').style.display = 'none';
        document.getElementById('fileInput').value = '';
        document.getElementById('docTitle').value = '';
        document.getElementById('docTags').value = '';
        renderDocuments();
    }});
}
</script>
{% endblock %}
