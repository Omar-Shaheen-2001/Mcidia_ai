{% extends "admin/base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.css">
<style>
    .sp-container { display: flex; height: calc(100vh - 100px); }
    .sp-sidebar { width: 250px; border-right: 1px solid #ddd; overflow-y: auto; padding: 20px; }
    .sp-main { flex: 1; display: flex; flex-direction: column; }
    .sp-header { background: white; border-bottom: 1px solid #ddd; padding: 20px; }
    .sp-content { flex: 1; overflow-y: auto; padding: 20px; }
    .sp-preview { width: 420px; border-left: 1px solid #ddd; overflow-y: auto; padding: 20px; background: #f8f9fa; display: none; box-shadow: -2px 0 8px rgba(0,0,0,0.1); }
    .sp-sidebar .nav-link { padding: 10px 15px; cursor: pointer; border-radius: 5px; margin-bottom: 10px; transition: all 0.3s; display: block; color: #333; }
    .sp-sidebar .nav-link:hover { background: #f0f0f0; }
    .sp-sidebar .nav-link.active { background: #6f42c1; color: white; }
    .search-box { position: relative; }
    .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; display: none; max-height: 300px; overflow-y: auto; z-index: 1000; }
    .suggestions.show { display: block; }
    .suggestion-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; }
    .suggestion-item:hover { background: #f0f0f0; }
    .view-toggle { display: flex; gap: 10px; }
    .view-toggle button { padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
    .view-toggle button.active { background: #6f42c1; color: white; border-color: #6f42c1; }
    .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .doc-grid-item { border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; background: white; }
    .tag { display: inline-block; background: #e9ecef; color: #495057; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 5px; }
    .empty-state { text-align: center; padding: 40px; color: #999; }
    .step-indicator { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .step { text-align: center; flex: 1; font-size: 0.9rem; }
    .step.active { color: #6f42c1; font-weight: bold; }
    .step.done::before { content: 'âœ“'; color: #28a745; font-weight: bold; }
    .progress-step { background: #e9ecef; padding: 10px; border-radius: 4px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    .progress-step.done { background: #d4edda; }
    .preview-item { margin-bottom: 20px; }
    .preview-item-label { font-size: 0.85rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
    .preview-item-value { font-size: 0.95rem; color: #333; word-break: break-word; }
    .preview-badge { display: inline-block; background: #6f42c1; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; margin-bottom: 8px; }
    .preview-tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .preview-tag { display: inline-block; background: #e9ecef; color: #495057; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; }
    .preview-divider { border-top: 1px solid #ddd; margin: 15px 0; }
    .strategy-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; margin-right: 5px; }
    .critical { background: #dc3545; color: white; }
    .high { background: #fd7e14; color: white; }
    .medium { background: #ffc107; color: #333; }
    .low { background: #17a2b8; color: white; }
    .theme-badge { display: inline-block; background: #e7e7ff; color: #6f42c1; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; margin-right: 5px; font-weight: 600; }
    .action-btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
    .action-btn-group button { font-size: 0.85rem; padding: 8px 12px; background: #6f42c1; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .action-btn-group button:hover { background: #5a32a3; }
    .theme-column { color: #6f42c1; font-weight: 600; }
    #strategyMapContainer { width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 8px; background: white; }
    .map-controls { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
    .map-layer-legend { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px; font-size: 0.9rem; }
    .legend-item { display: flex; align-items: center; gap: 8px; }
    .legend-color { width: 20px; height: 20px; border-radius: 4px; }
    .map-editor-panel { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-top: 15px; }
    .editor-section { margin-bottom: 15px; }
    .editor-section h6 { color: #6f42c1; margin-bottom: 10px; font-weight: 600; }
    .form-group { margin-bottom: 12px; }
    .form-group label { font-size: 0.85rem; color: #666; margin-bottom: 5px; display: block; }
    .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; }
    .color-picker-group { display: flex; gap: 10px; align-items: center; }
    .color-picker-group input[type="color"] { width: 50px; height: 35px; border: none; cursor: pointer; }
    .node-list { background: white; border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 200px; overflow-y: auto; }
    .node-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
    .node-item:last-child { border-bottom: none; }
    .node-item button { padding: 4px 8px; font-size: 0.75rem; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; }
    .btn-add-node { background: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-top: 10px; }
    .btn-add-node:hover { background: #218838; }
    @media (max-width: 768px) {
        .sp-preview { width: 100%; border-left: none; border-top: 1px solid #ddd; padding: 15px; }
        .sp-container { flex-direction: column; }
        .sp-sidebar { width: 100%; border-right: none; border-bottom: 1px solid #ddd; }
    }
</style>

<div class="sp-container">
    <!-- Sidebar Navigation -->
    <div class="sp-sidebar">
        <h5 class="mb-4">ğŸ¯ Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ</h5>
        <a href="#" class="nav-link active" data-filter="all" onclick="filterByCategory('all', event)">ğŸ“„ Ø§Ù„Ù…Ù„ÙØ§Øª</a>
        <a href="#" class="nav-link" data-filter="Framework" onclick="filterByCategory('Framework', event)">ğŸ“˜ Ø£Ø·Ø± Ø§Ù„Ø¹Ù…Ù„</a>
        <a href="#" class="nav-link" data-filter="KPIs" onclick="filterByCategory('KPIs', event)">ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</a>
        <a href="#" class="nav-link" data-filter="Objectives" onclick="filterByCategory('Objectives', event)">ğŸ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</a>
        <a href="#" class="nav-link" data-filter="Template" onclick="filterByCategory('Template', event)">ğŸ“‹ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨</a>
        <a href="#" class="nav-link" data-filter="Guidance" onclick="filterByCategory('Guidance', event)">ğŸ“š Ø£Ø¯Ù„Ø©</a>
    </div>

    <!-- Main Content -->
    <div class="sp-main">
        <!-- Top Bar -->
        <div class="sp-header">
            <div class="row align-items-center mb-3">
                <div class="col-md-8">
                    <h4 class="mb-0">ğŸ¯ Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ - Strategic Planning</h4>
                </div>
                <div class="col-md-4 text-end">
                    <div class="view-toggle">
                        <button class="active" onclick="switchView('list')" title="List View">
                            <i class="fas fa-list"></i>
                        </button>
                        <button onclick="switchView('grid')" title="Grid View">
                            <i class="fas fa-th"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Search & Filters -->
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <div class="search-box">
                        <input type="text" class="form-control" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠâ€¦" autocomplete="off">
                        <div class="suggestions" id="suggestions"></div>
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterTheme">
                        <option value="">Ø§Ù„Ù…Ø­ÙˆØ±</option>
                        <option value="Ø§Ù„Ù†Ù…Ùˆ">ğŸš€ Ø§Ù„Ù†Ù…Ùˆ</option>
                        <option value="Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ">ğŸ’» Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ</option>
                        <option value="Ø§Ù„ØªÙ…ÙŠÙŠØ²">â­ Ø§Ù„ØªÙ…ÙŠÙŠØ²</option>
                        <option value="Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option>
                        <option value="Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±">ğŸ’¡ Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterFramework">
                        <option value="">Ø§Ù„Ø¥Ø·Ø§Ø±</option>
                        <option value="BSC">BSC</option>
                        <option value="OKR">OKR</option>
                        <option value="SWOT">SWOT</option>
                        <option value="PESTEL">PESTEL</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterScope">
                        <option value="">Ø§Ù„Ù†Ø·Ø§Ù‚</option>
                        <option value="Ù…Ø¤Ø³Ø³Ø© ÙƒØ§Ù…Ù„Ø©">Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</option>
                        <option value="Ù‚Ø³Ù…">Ø§Ù„Ù‚Ø³Ù…</option>
                        <option value="Ù…Ø´Ø±ÙˆØ¹">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterValue">
                        <option value="">Ø§Ù„Ø£Ù‡Ù…ÙŠØ©</option>
                        <option value="Critical">Ø­Ø±Ø¬</option>
                        <option value="High">Ø¹Ø§Ù„ÙŠØ©</option>
                        <option value="Medium">Ù…ØªÙˆØ³Ø·Ø©</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-md-12">
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal" style="background: #6f42c1; border-color: #6f42c1;">
                        <i class="fas fa-cloud-upload-alt"></i> Ø±ÙØ¹ Ø®Ø·Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="sp-content">
            <div id="listView">
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>ğŸ“„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>ğŸ¯ Ø§Ù„Ù…Ø­ÙˆØ±</th>
                                <th>ğŸ“˜ Ø§Ù„Ø¥Ø·Ø§Ø±</th>
                                <th>ğŸ“ Ø§Ù„Ù†Ø·Ø§Ù‚</th>
                                <th>âš¡ Ø§Ù„Ø£Ù‡Ù…ÙŠØ©</th>
                                <th>â±ï¸ Ø§Ù„ÙØªØ±Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="documentsList"></tbody>
                    </table>
                </div>
                <div id="emptyState" class="empty-state" style="display:none;">
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø· Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                    <button class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal" style="background: #6f42c1; color: white; border: none;">
                        ğŸ“¤ Ø±ÙØ¹ Ø®Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>
            </div>

            <div id="gridView" style="display:none;" class="grid-view"></div>
        </div>
    </div>

    <!-- Preview Panel -->
    <div class="sp-preview" id="previewPanel">
        <button class="btn btn-sm btn-outline-secondary mb-3 w-100" onclick="closePreview()">
            <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
        </button>
        <div id="previewContent"></div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: #6f42c1; color: white;">
                <h5 class="modal-title">ğŸ“¤ Ø±ÙØ¹ Ø®Ø·Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="step-indicator mb-4">
                    <div class="step active">Ø§Ù„Ù…Ù„Ù</div>
                    <div class="step">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
                    <div class="step">Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</div>
                    <div class="step">Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
                    <div class="step">Ø§Ù„ØªØ£ÙƒÙŠØ¯</div>
                </div>

                <div id="step1">
                    <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù</label>
                    <input type="file" class="form-control mb-3" id="fileInput" accept=".pdf,.docx,.pptx">
                    <small class="text-muted">Ø£Ù†ÙˆØ§Ø¹ Ù…Ø¯Ø¹ÙˆÙ…Ø©: PDF, Word, PowerPoint</small>
                </div>

                <div id="step2" style="display:none;">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                        <input type="text" class="form-control" id="docTitle">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø·Ø§Ø±</label>
                        <select class="form-select" id="docFramework">
                            <option value="BSC">ğŸ“Š Balanced Scorecard</option>
                            <option value="OKR">ğŸ¯ OKRs</option>
                            <option value="Strategy Map">ğŸ—ºï¸ Strategy Map</option>
                            <option value="Governance">âš™ï¸ Governance</option>
                            <option value="VMV">ğŸ’¡ Vision-Mission</option>
                        </select>
                    </div>
                </div>

                <div id="step3" style="display:none;">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ</label>
                        <select class="form-select" id="docTheme">
                            <option value="Ø§Ù„Ù†Ù…Ùˆ">ğŸš€ Ø§Ù„Ù†Ù…Ùˆ</option>
                            <option value="Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ">ğŸ’» Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ</option>
                            <option value="Ø§Ù„ØªÙ…ÙŠÙŠØ²">â­ Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ</option>
                            <option value="Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option>
                            <option value="Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±">ğŸ’¡ Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ù†Ø·Ø§Ù‚</label>
                        <select class="form-select" id="docScope">
                            <option value="Ù…Ø¤Ø³Ø³Ø© ÙƒØ§Ù…Ù„Ø©">Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø¨Ø£ÙƒÙ…Ù„Ù‡Ø§</option>
                            <option value="Ù‚Ø³Ù…">Ù‚Ø³Ù… Ù…Ø­Ø¯Ø¯</option>
                            <option value="Ù…Ø´Ø±ÙˆØ¹">Ù…Ø´Ø±ÙˆØ¹</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</label>
                        <select class="form-select" id="docHorizon">
                            <option value="1 Ø³Ù†Ø©">Ø³Ù†Ø© ÙˆØ§Ø­Ø¯Ø©</option>
                            <option value="3 Ø³Ù†ÙˆØ§Øª">3 Ø³Ù†ÙˆØ§Øª</option>
                            <option value="5 Ø³Ù†ÙˆØ§Øª">5 Ø³Ù†ÙˆØ§Øª</option>
                        </select>
                    </div>
                </div>

                <div id="step4" style="display:none;">
                    <div class="progress-step done"><span>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ</span></div>
                    <div class="progress-step done"><span>ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</span></div>
                    <div class="progress-step"><span>ÙƒØ´Ù Ø§Ù„Ø±Ø¤ÙŠØ© ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©</span><div class="spinner-border spinner-border-sm ms-auto"></div></div>
                    <div class="progress-step"><span>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</span></div>
                    <div class="progress-step"><span>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</span></div>
                    <div class="progress-step"><span>ÙØ­Øµ Ø§Ù„ØªÙˆØ§ÙÙ‚</span></div>
                </div>

                <div id="step5" style="display:none;">
                    <div class="alert alert-success">
                        <strong>âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!</strong>
                        <p class="mb-0 mt-2">ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()" style="background: #6f42c1; border-color: #6f42c1;">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button type="button" class="btn btn-success" id="uploadBtnFinal" onclick="finalUpload()" style="display:none;">Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø©</button>
            </div>
        </div>
    </div>
</div>

<!-- Strategy Map Modal -->
<div class="modal fade" id="strategyMapModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: #6f42c1; color: white;">
                <h5 class="modal-title" id="mapTitle">ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="map-layer-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF6B6B;"></div>
                        <span>ØªÙ…ÙˆÙŠÙ„ (Financial)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4ECDC4;"></div>
                        <span>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Customer)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FFE66D;"></div>
                        <span>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Internal)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #95E1D3;"></div>
                        <span>Ø§Ù„ØªØ¹Ù„Ù… (Learning)</span>
                    </div>
                </div>
                <div id="strategyMapContainer"></div>
                <div class="map-controls">
                    <button class="btn btn-sm btn-primary" onclick="zoomIn()"><i class="fas fa-plus"></i> ØªÙƒØ¨ÙŠØ±</button>
                    <button class="btn btn-sm btn-primary" onclick="zoomOut()"><i class="fas fa-minus"></i> ØªØµØºÙŠØ±</button>
                    <button class="btn btn-sm btn-success" onclick="downloadMap()"><i class="fas fa-download"></i> Ø­ÙØ¸ ØµÙˆØ±Ø©</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>
</div>

<!-- Strategic Plan Builder Modal -->
<div class="modal fade" id="planBuilderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: #6f42c1; color: white;">
                <h5 class="modal-title" id="planBuilderTitle">ğŸ“‹ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
                <p style="color: #666; margin-bottom: 20px; font-size: 0.9rem;">
                    âœ… ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯. Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©:
                </p>
                <div id="extractedElements"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-success" onclick="addToStrategicPlan()" style="background: #6f42c1; border-color: #6f42c1;">
                    <i class="fas fa-check"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø®Ø·Ø©
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-cose-bilkent@4.1.0/dist/cytoscape-cose-bilkent.cjs"></script>
<script>
let currentStep = 1;
let currentFilter = 'all';
let documents = [
    { id: 1, title: 'Ø®Ø·Ø© Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© 2025', theme: 'Ø§Ù„Ù†Ù…Ùˆ', framework: 'OKR', scope: 'Ù…Ø¤Ø³Ø³Ø© ÙƒØ§Ù…Ù„Ø©', value: 'Critical', horizon: '3 Ø³Ù†ÙˆØ§Øª', tags: ['Growth', 'OKR'] },
    { id: 2, title: 'Ø®Ø§Ø±Ø·Ø© Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ', theme: 'Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ', framework: 'Strategy Map', scope: 'Ù…Ø¤Ø³Ø³Ø© ÙƒØ§Ù…Ù„Ø©', value: 'High', horizon: '5 Ø³Ù†ÙˆØ§Øª', tags: ['Digital', 'Innovation'] },
    { id: 3, title: 'Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ', theme: 'Ø§Ù„ØªÙ…ÙŠÙŠØ²', framework: 'BSC', scope: 'Ù‚Ø³Ù…', value: 'High', horizon: '3 Ø³Ù†ÙˆØ§Øª', tags: ['Excellence', 'Operations'] },
    { id: 4, title: 'Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©', theme: 'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©', framework: 'Governance', scope: 'Ù…Ø¤Ø³Ø³Ø© ÙƒØ§Ù…Ù„Ø©', value: 'Medium', horizon: '1 Ø³Ù†Ø©', tags: ['HR', 'People'] },
];

const suggestions = ['Ø±Ø¤ÙŠØ© ÙˆØ±Ø³Ø§Ù„Ø©', 'Ø£Ù‡Ø¯Ø§Ù Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©', 'Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡', 'Ø®Ø±ÙŠØ·Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©', 'Ø­ÙˆÙƒÙ…Ø©', 'OKRs', 'Balanced Scorecard'];

// localStorage Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø¦Ù…
function loadDocuments() {
    const saved = localStorage.getItem('sp-documents');
    if (saved) {
        try {
            documents = JSON.parse(saved);
        } catch (e) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', e);
        }
    }
}

function saveDocuments() {
    localStorage.setItem('sp-documents', JSON.stringify(documents));
}

document.addEventListener('DOMContentLoaded', () => {
    loadDocuments();
    renderDocuments();
    setupSearch();
    setupFilters();
});

function renderDocuments() {
    const tbody = document.getElementById('documentsList');
    const gridView = document.getElementById('gridView');
    tbody.innerHTML = '';
    gridView.innerHTML = '';
    
    let filteredDocs = documents;
    if (currentFilter !== 'all') {
        filteredDocs = documents.filter(d => d.framework === currentFilter || d.type === currentFilter);
    }
    
    if (filteredDocs.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        return;
    }
    document.getElementById('emptyState').style.display = 'none';
    
    filteredDocs.forEach(doc => {
        const valueClass = doc.value === 'Critical' ? 'critical' : doc.value === 'High' ? 'high' : doc.value === 'Medium' ? 'medium' : 'low';
        const valueLabel = doc.value === 'Critical' ? 'ğŸ”´ Ø­Ø±Ø¬' : doc.value === 'High' ? 'ğŸŸ  Ø¹Ø§Ù„ÙŠØ©' : 'ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø©';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><a href="#" onclick="showPreview(${doc.id}); return false;"><strong>${doc.title}</strong></a></td>
            <td><span class="theme-column">${doc.theme}</span></td>
            <td><span class="badge" style="background: #6f42c1;">${doc.framework}</span></td>
            <td>${doc.scope}</td>
            <td><span class="strategy-badge ${valueClass}">${valueLabel}</span></td>
            <td>${doc.horizon}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-info" onclick="showPreview(${doc.id})"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-danger" onclick="deleteDocument(${doc.id})"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
        
        const gridItem = document.createElement('div');
        gridItem.className = 'doc-grid-item';
        gridItem.innerHTML = `
            <div style="text-align: center;">
                <h6 style="margin: 0 0 10px 0; color: #6f42c1; min-height: 40px; word-wrap: break-word;">${doc.title}</h6>
                <p style="margin: 0 0 8px 0;"><span class="theme-badge">${doc.theme}</span></p>
                <p style="margin: 0 0 8px 0; font-size: 0.85rem; color: #666;">${doc.framework}</p>
                <p style="margin: 0 0 8px 0;"><span class="strategy-badge ${valueClass}">${valueLabel}</span></p>
                <p style="margin: 0 0 12px 0; font-size: 0.8rem; color: #999;">${doc.horizon}</p>
                <div style="display: flex; gap: 5px; justify-content: center;">
                    <button class="btn btn-sm btn-primary" onclick="showPreview(${doc.id})" style="background: #6f42c1; border-color: #6f42c1;"><i class="fas fa-eye"></i> Ø¹Ø±Ø¶</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDocument(${doc.id})"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;
        gridView.appendChild(gridItem);
    });
}

function filterByCategory(filter, event) {
    event.preventDefault();
    currentFilter = filter;
    document.querySelectorAll('.sp-sidebar .nav-link').forEach(l => l.classList.remove('active'));
    event.target.closest('.nav-link').classList.add('active');
    renderDocuments();
}

function setupSearch() {
    const input = document.getElementById('searchInput');
    const suggestionsDiv = document.getElementById('suggestions');
    
    input.addEventListener('focus', () => {
        suggestionsDiv.innerHTML = suggestions.map(s => `<div class="suggestion-item" onclick="selectSuggestion('${s}')">${s}</div>`).join('');
        suggestionsDiv.classList.add('show');
    });
    
    input.addEventListener('input', (e) => {
        const val = e.target.value.toLowerCase();
        const filtered = suggestions.filter(s => s.toLowerCase().includes(val));
        suggestionsDiv.innerHTML = filtered.map(s => `<div class="suggestion-item" onclick="selectSuggestion('${s}')">${s}</div>`).join('');
    });
    
    document.addEventListener('click', (e) => {
        if (!input.contains(e.target)) suggestionsDiv.classList.remove('show');
    });
}

function selectSuggestion(text) {
    document.getElementById('searchInput').value = text;
    document.getElementById('suggestions').classList.remove('show');
}

function setupFilters() {
    document.getElementById('filterTheme').addEventListener('change', renderDocuments);
    document.getElementById('filterFramework').addEventListener('change', renderDocuments);
    document.getElementById('filterScope').addEventListener('change', renderDocuments);
    document.getElementById('filterValue').addEventListener('change', renderDocuments);
}

function switchView(view) {
    document.getElementById('listView').style.display = view === 'list' ? 'block' : 'none';
    document.getElementById('gridView').style.display = view === 'grid' ? 'grid' : 'none';
}

function showPreview(id) {
    const doc = documents.find(d => d.id === id);
    const panel = document.getElementById('previewPanel');
    const content = document.getElementById('previewContent');
    
    const valueClass = doc.value === 'Critical' ? 'critical' : doc.value === 'High' ? 'high' : doc.value === 'Medium' ? 'medium' : 'low';
    const valueLabel = doc.value === 'Critical' ? 'ğŸ”´ Ø­Ø±Ø¬' : doc.value === 'High' ? 'ğŸŸ  Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹' : 'ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø©';
    
    content.innerHTML = `
        <div class="preview-item">
            <div class="preview-item-label">ğŸ“„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
            <h5 style="color: #6f42c1; margin: 0; word-wrap: break-word;">${doc.title}</h5>
        </div>
        
        <div class="preview-divider"></div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ¯ Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ</div>
            <div><span class="theme-badge">${doc.theme}</span></div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ“˜ Ø¥Ø·Ø§Ø± Ø§Ù„Ø¹Ù…Ù„</div>
            <div class="preview-badge" style="background: #6f42c1;">${doc.framework}</div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ“ Ø§Ù„Ù†Ø·Ø§Ù‚</div>
            <div class="preview-item-value">${doc.scope}</div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">âš¡ Ø§Ù„Ø£Ù‡Ù…ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</div>
            <div><span class="strategy-badge ${valueClass}">${valueLabel}</span></div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">â±ï¸ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</div>
            <div class="preview-item-value">${doc.horizon}</div>
        </div>
        
        <div class="preview-item">
            <div class="preview-item-label">ğŸ·ï¸ Ø§Ù„ÙˆØ³ÙˆÙ…</div>
            <div class="preview-tags-container">
                ${doc.tags.map(t => `<span class="preview-tag">${t}</span>`).join('')}
            </div>
        </div>
        
        <div class="preview-divider"></div>
        
        <div class="action-btn-group">
            <button onclick="openPlanBuilder(${doc.id})"><i class="fas fa-plus"></i> Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©</button>
            <button onclick="showStrategyMap(${doc.id})"><i class="fas fa-sitemap"></i> Ø¹Ø±Ø¶ Ø®Ø±ÙŠØ·Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</button>
            <button><i class="fas fa-chart-line"></i> Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</button>
            <button><i class="fas fa-link"></i> Ø±Ø¨Ø· Ù…Ø¹ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</button>
        </div>
    `;
    panel.style.display = 'block';
}

function extractIntelligentElements(doc) {
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø°ÙƒÙŠ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ†Ø¯
    const visionMap = {
        'Ø§Ù„Ù†Ù…Ùˆ': 'ØªØ­Ù‚ÙŠÙ‚ Ù†Ù…Ùˆ Ù…Ø³ØªØ¯Ø§Ù… ÙˆØªÙˆØ³Ø¹ ÙÙŠ Ø­ØµØªÙ†Ø§ Ù…Ù† Ø§Ù„Ø³ÙˆÙ‚',
        'Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ': 'Ø¨Ù†Ø§Ø¡ Ù…Ù†Ø¸Ù…Ø© Ø±Ù‚Ù…ÙŠØ© Ù…ØªØ·ÙˆØ±Ø© Ù…Ø¹ ØªÙ‚Ù†ÙŠØ§Øª Ø­Ø¯ÙŠØ«Ø©',
        'Ø§Ù„ØªÙ…ÙŠÙŠØ²': 'ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„ØªÙ…ÙŠØ² Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ ÙˆØ§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©',
        'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©': 'Ø¨Ù†Ø§Ø¡ ÙØ±ÙŠÙ‚ Ø¹Ù…Ù„ Ù…ÙˆÙ‡ÙˆØ¨ ÙˆÙ…Ù„ØªØ²Ù…',
        'Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±': 'Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø³ÙˆÙ‚ Ø¨Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø± ÙˆØ§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©'
    };
    
    const missionMap = {
        'Ø§Ù„Ù†Ù…Ùˆ': 'ØªØ­Ù‚ÙŠÙ‚ Ø¹Ø§Ø¦Ø¯ Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ Ø¹Ø§Ù„ÙŠ ÙˆØ®Ù„Ù‚ Ù‚ÙŠÙ…Ø© Ù„Ù„Ù…Ø³Ø§Ù‡Ù…ÙŠÙ†',
        'Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ': 'ØªÙˆÙÙŠØ± Ø­Ù„ÙˆÙ„ Ø±Ù‚Ù…ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø© ÙˆØ¢Ù…Ù†Ø©',
        'Ø§Ù„ØªÙ…ÙŠÙŠØ²': 'ØªÙ‚Ø¯ÙŠÙ… Ù…Ù†ØªØ¬Ø§Øª ÙˆØ®Ø¯Ù…Ø§Øª Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹',
        'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©': 'ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…ÙˆØ§Ù‡Ø¨ ÙˆØªÙˆÙÙŠØ± Ø¨ÙŠØ¦Ø© Ø¹Ù…Ù„ Ù…Ø­ÙØ²Ø©',
        'Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±': 'ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£ÙÙƒØ§Ø± Ø¥Ù„Ù‰ Ø­Ù„ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© ÙˆÙ‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ°'
    };
    
    const objectivesMap = {
        'Ø§Ù„Ù†Ù…Ùˆ': ['Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø¨Ù€ 35% Ø®Ù„Ø§Ù„ 3 Ø³Ù†ÙˆØ§Øª', 'Ø§Ù„ØªÙˆØ³Ø¹ Ø¥Ù„Ù‰ Ø£Ø³ÙˆØ§Ù‚ Ø¬Ø¯ÙŠØ¯Ø©', 'ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ­ÙˆØ§Ø° Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡'],
        'Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ': ['ØªØ·Ø¨ÙŠÙ‚ ØªÙ‚Ù†ÙŠØ§Øª Ø³Ø­Ø§Ø¨ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©', 'Ø£ØªÙ…ØªØ© 70% Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª', 'ØªØ­Ø³ÙŠÙ† Ø³Ø±Ø¹Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª'],
        'Ø§Ù„ØªÙ…ÙŠÙŠØ²': ['ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© Ø¨Ù€ 40%', 'ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¥Ù„Ù‰ Ø£Ù‚Ù„ Ù…Ù† 1%', 'Ø±ÙØ¹ Ø±Ø¶Ø§ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¥Ù„Ù‰ 95%'],
        'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©': ['ØªØ·ÙˆÙŠØ± Ù…Ù‡Ø§Ø±Ø§Øª 100% Ù…Ù† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', 'ØªÙ‚Ù„ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', 'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø¨Ù€ 25%'],
        'Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±': ['Ø¥Ø·Ù„Ø§Ù‚ 5 Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø³Ù†ÙˆÙŠØ§Ù‹', 'ØªØ®ØµÙŠØµ 15% Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø²Ù†Ø© Ù„Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±', 'Ø¨Ù†Ø§Ø¡ Ø´Ø±Ø§ÙƒØ§Øª Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©']
    };
    
    const kpisMap = {
        'Ø§Ù„Ù†Ù…Ùˆ': [
            { name: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ø³Ù†ÙˆÙŠ', value: '30-35%', category: 'Financial' },
            { name: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯', value: '+40%', category: 'Customer' },
            { name: 'Ø§Ù„Ø­ØµØ© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©', value: '+5%', category: 'Customer' }
        ],
        'Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ': [
            { name: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ù‚Ù…Ù†Ø©', value: '85%', category: 'Internal' },
            { name: 'Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', value: '-60%', category: 'Internal' },
            { name: 'Ø±Ø¶Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø±Ù‚Ù…ÙŠÙŠÙ†', value: '92%', category: 'Customer' }
        ],
        'Ø§Ù„ØªÙ…ÙŠÙŠØ²': [
            { name: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©', value: '92%', category: 'Internal' },
            { name: 'Ù…Ø¹Ø¯Ù„ Ø±Ø¶Ø§ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', value: '94%', category: 'Customer' },
            { name: 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯', value: '98%', category: 'Internal' }
        ],
        'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©': [
            { name: 'Ù…Ø¹Ø¯Ù„ ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', value: '100%', category: 'Learning' },
            { name: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸', value: '92%', category: 'Internal' },
            { name: 'Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù', value: '+25%', category: 'Internal' }
        ],
        'Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±': [
            { name: 'Ø¹Ø¯Ø¯ Ø¨Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø§Ø®ØªØ±Ø§Ø¹', value: '5+ Ø³Ù†ÙˆÙŠØ§Ù‹', category: 'Learning' },
            { name: 'Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙÙŠ R&D', value: '15%', category: 'Financial' },
            { name: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', value: '40%', category: 'Customer' }
        ]
    };
    
    return {
        vision: visionMap[doc.theme] || 'Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù†Ø¸Ù…Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆØ§Ù„Ù…Ø³ØªØ¯Ø§Ù…Ø©',
        mission: missionMap[doc.theme] || 'ØªÙ‚Ø¯ÙŠÙ… Ø­Ù„ÙˆÙ„ Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆÙØ¹Ø§Ù„Ø©',
        objectives: objectivesMap[doc.theme] || ['ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡', 'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙØ§Ø¡Ø©'],
        themes: [doc.theme, 'Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ…Ø±', doc.scope],
        kpis: kpisMap[doc.theme] || [
            { name: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ', value: '25%', category: 'Financial' },
            { name: 'Ø±Ø¶Ø§ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', value: '90%', category: 'Customer' }
        ]
    };
}

function openPlanBuilder(docId) {
    const doc = documents.find(d => d.id === docId);
    const extractedElements = extractIntelligentElements(doc);
    
    const modal = new bootstrap.Modal(document.getElementById('planBuilderModal'));
    
    document.getElementById('planBuilderTitle').innerHTML = `ğŸ“‹ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ù…Ù†: <strong>${doc.title}</strong>`;
    
    let html = `
        <div class="mb-4">
            <h6 style="color: #6f42c1; margin-bottom: 15px;">ğŸ‘ï¸ Ø§Ù„Ø±Ø¤ÙŠØ©</h6>
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                <label style="display: flex; align-items: start; gap: 10px; margin: 0; cursor: pointer;">
                    <input type="checkbox" checked style="margin-top: 3px;">
                    <span>${extractedElements.vision}</span>
                </label>
            </div>
        </div>
        
        <div class="mb-4">
            <h6 style="color: #6f42c1; margin-bottom: 15px;">ğŸ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h6>
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                <label style="display: flex; align-items: start; gap: 10px; margin: 0; cursor: pointer;">
                    <input type="checkbox" checked style="margin-top: 3px;">
                    <span>${extractedElements.mission}</span>
                </label>
            </div>
        </div>
        
        <div class="mb-4">
            <h6 style="color: #6f42c1; margin-bottom: 15px;">ğŸ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</h6>
            ${extractedElements.objectives.map((obj, i) => `
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                    <label style="display: flex; align-items: start; gap: 10px; margin: 0; cursor: pointer;">
                        <input type="checkbox" checked style="margin-top: 3px;">
                        <span>${obj}</span>
                    </label>
                </div>
            `).join('')}
        </div>
        
        <div class="mb-4">
            <h6 style="color: #6f42c1; margin-bottom: 15px;">ğŸ¨ Ø§Ù„Ù…Ø­Ø§ÙˆØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</h6>
            ${extractedElements.themes.map(theme => `
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                    <label style="display: flex; align-items: start; gap: 10px; margin: 0; cursor: pointer;">
                        <input type="checkbox" checked style="margin-top: 3px;">
                        <span>${theme}</span>
                    </label>
                </div>
            `).join('')}
        </div>
        
        <div class="mb-4">
            <h6 style="color: #6f42c1; margin-bottom: 15px;">ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ (KPIs)</h6>
            ${extractedElements.kpis.map((kpi, i) => `
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                    <label style="display: flex; align-items: start; gap: 10px; margin: 0; cursor: pointer;">
                        <input type="checkbox" checked style="margin-top: 3px;">
                        <span><strong>${kpi.name}</strong> â€¢ ${kpi.value} <span style="font-size: 0.8rem; color: #999;">(${kpi.category})</span></span>
                    </label>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('extractedElements').innerHTML = html;
    modal.show();
}

function closePreview() {
    document.getElementById('previewPanel').style.display = 'none';
}

function deleteDocument(id) {
    Swal.fire({icon: 'question', title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø©ØŸ', showCancelButton: true, confirmButtonText: 'Ù†Ø¹Ù…', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'}).then(r => {
        if (r.isConfirmed) {
            documents = documents.filter(d => d.id !== id);
            saveDocuments();
            renderDocuments();
            Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', '', 'success');
        }
    });
}

function nextStep() {
    if (currentStep === 1) {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.value) {
            Swal.fire({icon: 'error', title: 'ØªØ­Ø°ÙŠØ±', text: 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹'});
            return;
        }
        currentStep = 2;
    } else if (currentStep === 3) {
        currentStep = 4;
        document.querySelectorAll('[id^="step"]').forEach(e => e.style.display = 'none');
        document.getElementById('step4').style.display = 'block';
        document.getElementById('nextBtn').disabled = true;
        simulateProcessing();
        return;
    } else {
        currentStep++;
    }
    
    document.querySelectorAll('[id^="step"]').forEach(e => e.style.display = 'none');
    document.getElementById(`step${currentStep}`).style.display = 'block';
    
    if (currentStep === 5) {
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('uploadBtnFinal').style.display = 'inline-block';
    }
}

function simulateProcessing() {
    const steps = document.querySelectorAll('#step4 .progress-step');
    let stepIndex = 2;
    
    function markStepDone() {
        if (stepIndex < steps.length) {
            steps[stepIndex].classList.add('done');
            const spinner = steps[stepIndex].querySelector('.spinner-border');
            if (spinner) spinner.style.display = 'none';
            stepIndex++;
            setTimeout(markStepDone, 600);
        } else {
            setTimeout(() => {
                currentStep = 5;
                document.getElementById('step4').style.display = 'none';
                document.getElementById('step5').style.display = 'block';
                document.getElementById('nextBtn').disabled = false;
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('uploadBtnFinal').style.display = 'inline-block';
            }, 500);
        }
    }
    markStepDone();
}

function finalUpload() {
    const title = document.getElementById('docTitle').value;
    const theme = document.getElementById('docTheme').value;
    const framework = document.getElementById('docFramework').value;
    const scope = document.getElementById('docScope').value;
    const horizon = document.getElementById('docHorizon').value;
    
    const newDoc = {
        id: documents.length + 1,
        title: title || 'Ø®Ø·Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©',
        theme: theme,
        framework: framework,
        scope: scope,
        value: 'Medium',
        horizon: horizon,
        tags: ['Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ', 'Ø¬Ø¯ÙŠØ¯']
    };
    
    documents.push(newDoc);
    saveDocuments();
    
    Swal.fire({icon: 'success', title: 'Ù†Ø¬Ø§Ø­!', text: 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­', didClose: () => {
        document.getElementById('uploadModal').querySelector('.btn-close').click();
        currentStep = 1;
        document.querySelectorAll('[id^="step"]').forEach(e => e.style.display = 'none');
        document.getElementById('step1').style.display = 'block';
        document.getElementById('nextBtn').disabled = false;
        document.getElementById('nextBtn').style.display = 'inline-block';
        document.getElementById('uploadBtnFinal').style.display = 'none';
        document.getElementById('fileInput').value = '';
        document.getElementById('docTitle').value = '';
        renderDocuments();
    }});
}

function addToStrategicPlan() {
    const checkedItems = document.querySelectorAll('#extractedElements input[type="checkbox"]:checked');
    const selectedCount = checkedItems.length;
    
    if (selectedCount === 0) {
        Swal.fire({icon: 'warning', title: 'ØªØ­Ø°ÙŠØ±', text: 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'});
        return;
    }
    
    // Ø£ÙˆÙ„ Ù‡Ø¯Ù ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡
    const firstGoal = document.querySelector('#extractedElements input[type="checkbox"]:checked')?.parentElement?.textContent?.trim() || 'Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ';
    
    Swal.fire({
        title: 'Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©...',
        html: 'ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø´Ø§Ù…Ù„Ø© ÙˆÙ‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ°...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });
    
    const currentDoc = documents[documents.length - 1];
    
    fetch('/admin/knowledge/api/generate-strategic-plan', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            goal: firstGoal,
            doc_content: `Ø§Ù„Ø®Ø·Ø©: ${currentDoc.title}, Ø§Ù„Ù…Ø­ÙˆØ±: ${currentDoc.theme}, Ø§Ù„Ø¥Ø·Ø§Ø±: ${currentDoc.framework}`,
            doc_title: currentDoc.title
        })
    })
    .then(r => r.json())
    .then(data => {
        Swal.close();
        
        if (data.success && data.plan) {
            const plan = data.plan;
            let planHtml = `
                <div style="text-align: right; max-height: 600px; overflow-y: auto; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h5 style="color: #333; margin-bottom: 20px;">ğŸ“‹ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</h5>
            `;
            
            if (plan.analysis) {
                planHtml += `<div style="background: white; padding: 15px; border-right: 4px solid #6f42c1; margin-bottom: 15px;">
                    <strong>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ù:</strong>
                    <p style="margin-top: 8px; color: #666;">${plan.analysis}</p>
                </div>`;
            }
            
            if (plan.kpis && Array.isArray(plan.kpis) && plan.kpis.length > 0) {
                planHtml += `<div style="background: white; padding: 15px; border-right: 4px solid #FF6B6B; margin-bottom: 15px;">
                    <strong>ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ (KPIs):</strong>
                    <ul style="margin-top: 8px; padding-right: 20px;">
                        ${plan.kpis.map(kpi => `<li style="color: #666; margin: 5px 0;">${kpi}</li>`).join('')}
                    </ul>
                </div>`;
            }
            
            if (plan.initiatives && Array.isArray(plan.initiatives) && plan.initiatives.length > 0) {
                planHtml += `<div style="background: white; padding: 15px; border-right: 4px solid #4ECDC4; margin-bottom: 15px;">
                    <strong>ğŸ¯ Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©:</strong>
                    <ul style="margin-top: 8px; padding-right: 20px;">
                        ${plan.initiatives.map(init => `<li style="color: #666; margin: 5px 0;">${init}</li>`).join('')}
                    </ul>
                </div>`;
            }
            
            if (plan.resources) {
                planHtml += `<div style="background: white; padding: 15px; border-right: 4px solid #FFE66D; margin-bottom: 15px;">
                    <strong>ğŸ’¼ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</strong>
                    <p style="margin-top: 8px; color: #666;">${plan.resources}</p>
                </div>`;
            }
            
            if (plan.timeline) {
                planHtml += `<div style="background: white; padding: 15px; border-right: 4px solid #95E1D3;">
                    <strong>â±ï¸ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ:</strong>
                    <p style="margin-top: 8px; color: #666;">${plan.timeline}</p>
                </div>`;
            }
            
            planHtml += '</div>';
            
            Swal.fire({
                title: 'âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!',
                html: planHtml,
                width: '700px',
                confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø©',
                cancelButtonText: 'Ø¥ØºÙ„Ø§Ù‚',
                showCancelButton: true,
                didOpen: () => {
                    document.querySelector('.swal2-html-container').style.textAlign = 'right';
                },
                preConfirm: () => {
                    bootstrap.Modal.getInstance(document.getElementById('planBuilderModal')).hide();
                    Swal.fire('ØªÙ…', 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
            });
        } else {
            Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹', 'error');
        }
    })
    .catch(err => {
        Swal.fire('Ø®Ø·Ø£', err.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©', 'error');
    });
}

let strategyMapInstance = null;

function showStrategyMap(docId) {
    const doc = documents.find(d => d.id === docId);
    document.getElementById('mapTitle').innerHTML = `ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: <strong>${doc.title}</strong>`;
    
    Swal.fire({title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...', html: 'ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù€ AI Ù…Ø¹ Ù…Ø­ØªÙˆÙ‰ Ø£Ø·ÙˆÙ„
    const content = `
Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: ${doc.title}

Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ: ${doc.theme}
Ø¥Ø·Ø§Ø± Ø§Ù„Ø¹Ù…Ù„: ${doc.framework}
Ø§Ù„Ù†Ø·Ø§Ù‚: ${doc.scope}
Ø§Ù„Ø£Ù‡Ù…ÙŠØ©: ${doc.value}
Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©: ${doc.horizon}
Ø§Ù„ÙˆØ³ÙˆÙ…: ${doc.tags ? doc.tags.join(', ') : 'Ø¹Ø§Ù…'}

Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ:
Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ù…ÙˆØ¬Ù‡Ø© Ù†Ø­Ùˆ ØªØ­Ù‚ÙŠÙ‚ Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ù†Ø¸Ù…Ø© ÙÙŠ Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ù…ØªÙˆØ³Ø· ÙˆØ§Ù„Ø·ÙˆÙŠÙ„.
ØªØ±ÙƒØ² Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØªØ­Ù‚ÙŠÙ‚ Ø§Ù„ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ù†Ø¸Ù…Ø©.
ÙŠØªØ¶Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„.

Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:
1. ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©
2. Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­
3. ØªØ·ÙˆÙŠØ± Ù‚Ø¯Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©
4. ØªØ­Ø³ÙŠÙ† Ø±Ø¶Ø§ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
5. Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø± ÙˆØ§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø³ØªÙ…Ø±
    `;
    
    fetch('/admin/knowledge/api/analyze-strategy-map', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content: content, title: doc.title})
    })
    .then(r => r.json())
    .then(data => {
        Swal.close();
        
        const nodes = [];
        const edges = [];
        const layerLabels = { 
            financial: 'ğŸ¦ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø§Ù„ÙŠØ©', 
            customer: 'ğŸ‘¥ Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', 
            internal: 'âš™ï¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©', 
            learning: 'ğŸ“ Ø§Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„Ù†Ù…Ùˆ'
        };
        const colorMap = { 
            financial: '#FF6B6B', 
            customer: '#4ECDC4', 
            internal: '#FFE66D', 
            learning: '#95E1D3' 
        };
        const layers = ['financial', 'customer', 'internal', 'learning'];
        const layerMap = {};
        const yPositions = { learning: 0, internal: 1, customer: 2, financial: 3 };
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ù† ÙƒÙ„ Ø·Ø¨Ù‚Ø© Ù…Ø¹ ØªÙ…ÙˆØ¶Ø¹ Ù‡Ø±Ù…ÙŠ
        let nodeCounter = 0;
        layers.forEach(layer => {
            if (data[layer] && Array.isArray(data[layer])) {
                layerMap[layer] = [];
                const layerItems = data[layer];
                const itemsCount = layerItems.length;
                
                layerItems.forEach((item, idx) => {
                    if (item.id && item.label) {
                        const x = (idx - itemsCount / 2) * 200;
                        const y = yPositions[layer] * 250;
                        
                        nodes.push({
                            data: { 
                                id: item.id, 
                                label: item.label, 
                                description: item.description || '',
                                layer: layer 
                            },
                            position: { x, y },
                            style: { 
                                'background-color': colorMap[layer],
                                'border-width': 3,
                                'box-shadow': '0 2px 8px rgba(0,0,0,0.2)'
                            }
                        });
                        layerMap[layer].push(item.id);
                    }
                });
            }
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ nodes
        if (data.relationships && Array.isArray(data.relationships)) {
            const nodeIds = new Set(nodes.map(n => n.data.id));
            data.relationships.forEach(rel => {
                if (rel.from && rel.to && nodeIds.has(rel.from) && nodeIds.has(rel.to)) {
                    edges.push({ 
                        data: { 
                            source: rel.from, 
                            target: rel.to,
                            label: rel.label || ''
                        }
                    });
                }
            });
        }
        
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¹Ù„Ø§Ù‚Ø§Øª ØµØ­ÙŠØ­Ø©ØŒ Ø£Ù†Ø´Ø¦ Ø¹Ù„Ø§Ù‚Ø§Øª Ù…Ù† Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        if (edges.length === 0 && Object.keys(layerMap).some(k => layerMap[k].length > 0)) {
            if (layerMap.learning && layerMap.learning.length > 0) {
                layerMap.learning.forEach(l => {
                    if (layerMap.internal && layerMap.internal.length > 0) {
                        edges.push({ data: { source: l, target: layerMap.internal[0], label: 'ÙŠÙ…ÙƒÙ‘Ù†' } });
                    }
                });
            }
            if (layerMap.internal && layerMap.internal.length > 0) {
                layerMap.internal.forEach(p => {
                    if (layerMap.customer && layerMap.customer.length > 0) {
                        edges.push({ data: { source: p, target: layerMap.customer[0], label: 'ÙŠØ­Ø³Ù‘Ù†' } });
                    }
                });
            }
            if (layerMap.customer && layerMap.customer.length > 0) {
                layerMap.customer.forEach(c => {
                    if (layerMap.financial && layerMap.financial.length > 0) {
                        edges.push({ data: { source: c, target: layerMap.financial[0], label: 'ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰' } });
                    }
                });
            }
        }
        
        if (strategyMapInstance) strategyMapInstance.destroy();
        
        strategyMapInstance = cytoscape({
            container: document.getElementById('strategyMapContainer'),
            elements: [...nodes, ...edges],
            style: cytoscape.stylesheet()
                .selector('node')
                .css({
                    'content': 'data(label)',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'width': '140px',
                    'height': '100px',
                    'border-width': 3,
                    'border-color': '#fff',
                    'font-size': '11px',
                    'font-weight': 'bold',
                    'color': '#fff',
                    'text-wrap': 'wrap',
                    'text-overflow-wrap': 'whitespace',
                    'padding': '10px',
                    'shape': 'round-rectangle'
                })
                .selector('node:hover')
                .css({
                    'width': '160px',
                    'height': '120px',
                    'border-width': 4
                })
                .selector('edge')
                .css({
                    'target-arrow-shape': 'triangle-backcurve',
                    'line-color': '#666',
                    'target-arrow-color': '#666',
                    'width': 2,
                    'curve-style': 'bezier',
                    'edge-text-rotation': 'autorotate'
                })
                .selector('edge:hover')
                .css({
                    'line-color': '#333',
                    'target-arrow-color': '#333',
                    'width': 3
                }),
            layout: { 
                name: 'preset',
                fit: true, 
                padding: 80
            }
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
        strategyMapInstance.on('tap', 'node', function(e) {
            const node = e.target;
            const nodeData = node.data();
            const originalData = data[nodeData.layer].find(item => item.id === nodeData.id);
            
            if (originalData) {
                let detailsHtml = `
                    <div style="text-align: right; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="color: #333; margin-bottom: 15px;">${nodeData.label}</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>ğŸ“ Ø§Ù„ÙˆØµÙ:</strong>
                            <p style="color: #555; margin-top: 8px;">${originalData.description || '-'}</p>
                        </div>
                `;
                
                if (originalData.kpis && originalData.kpis.length > 0) {
                    detailsHtml += `
                        <div style="margin-bottom: 15px; background: white; padding: 10px; border-right: 4px solid #FF6B6B;">
                            <strong>ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ (KPIs):</strong>
                            <ul style="margin-top: 8px; padding-right: 20px;">
                                ${originalData.kpis.map(kpi => `<li style="color: #666; margin: 5px 0;">${kpi}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (originalData.initiatives && originalData.initiatives.length > 0) {
                    detailsHtml += `
                        <div style="margin-bottom: 15px; background: white; padding: 10px; border-right: 4px solid #4ECDC4;">
                            <strong>ğŸ¯ Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©:</strong>
                            <ul style="margin-top: 8px; padding-right: 20px;">
                                ${originalData.initiatives.map(init => `<li style="color: #666; margin: 5px 0;">${init}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (originalData.timeline) {
                    detailsHtml += `
                        <div style="margin-bottom: 15px; background: white; padding: 10px;">
                            <strong>â±ï¸ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ:</strong>
                            <p style="color: #666; margin-top: 8px;">${originalData.timeline}</p>
                        </div>
                    `;
                }
                
                if (originalData.priority) {
                    const priorityColor = originalData.priority === 'Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹' ? '#FF6B6B' : originalData.priority === 'Ø¹Ø§Ù„ÙŠØ©' ? '#FFA500' : '#FFC107';
                    detailsHtml += `
                        <div style="margin-bottom: 15px; background: white; padding: 10px;">
                            <strong>âš¡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:</strong>
                            <p style="color: white; background: ${priorityColor}; margin-top: 8px; padding: 8px; border-radius: 4px; text-align: center; font-weight: bold;">${originalData.priority}</p>
                        </div>
                    `;
                }
                
                if (originalData.success_factors && originalData.success_factors.length > 0) {
                    detailsHtml += `
                        <div style="background: white; padding: 10px; border-right: 4px solid #95E1D3;">
                            <strong>âœ“ Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ø­Ø±Ø¬Ø©:</strong>
                            <ul style="margin-top: 8px; padding-right: 20px;">
                                ${originalData.success_factors.map(factor => `<li style="color: #666; margin: 5px 0;">${factor}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                detailsHtml += '</div>';
                
                Swal.fire({
                    title: 'ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ',
                    html: detailsHtml,
                    width: '600px',
                    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
                    allowOutsideClick: true,
                    didOpen: () => {
                        document.querySelector('.swal2-html-container').style.textAlign = 'right';
                    }
                });
            }
        });
        
        // ØªÙ‡ÙŠØ¦Ø© Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„nodes
        nodeCounter = { financial: 0, customer: 0, internal: 0, learning: 0 };
        
        const modal = new bootstrap.Modal(document.getElementById('strategyMapModal'));
        modal.show();
    })
    .catch(err => {
        Swal.fire({icon: 'error', title: 'Ø®Ø·Ø£', text: err.message});
    });
}

function zoomIn() {
    if (strategyMapInstance) {
        strategyMapInstance.zoom(strategyMapInstance.zoom() * 1.2);
    }
}

function zoomOut() {
    if (strategyMapInstance) {
        strategyMapInstance.zoom(strategyMapInstance.zoom() / 1.2);
    }
}

function downloadMap() {
    if (strategyMapInstance) {
        const png = strategyMapInstance.png({ full: true, scale: 2 });
        const link = document.createElement('a');
        link.href = png;
        link.download = 'strategy-map.png';
        link.click();
        Swal.fire({icon: 'success', title: 'ØªÙ…', text: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù†Ø¬Ø§Ø­'});
    }
}

let currentNodeLayer = 'financial';
let nodeCounter = { financial: 0, customer: 0, internal: 0, learning: 0 };
const colorMap = { financial: '#FF6B6B', customer: '#4ECDC4', internal: '#FFE66D', learning: '#95E1D3' };

function showMapEditor() {
    if (!strategyMapInstance) return;
    
    const nodes = strategyMapInstance.nodes();
    const nodesByLayer = { financial: [], customer: [], internal: [], learning: [] };
    
    nodes.forEach(n => {
        const layer = n.data('layer');
        if (layer) nodesByLayer[layer].push(n);
    });
    
    let editorHtml = `
        <div style="text-align: right; padding: 15px; max-width: 500px;">
            <h5 style="color: #6f42c1; margin-bottom: 20px;">âœï¸ Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</h5>
            
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h6 style="color: #333; margin-bottom: 10px;">â• Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯</h6>
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.85rem; color: #666; margin-bottom: 5px; display: block;">Ø§Ù„Ø·Ø¨Ù‚Ø©</label>
                    <select id="newNodeLayer" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="financial">ğŸ¦ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø§Ù„ÙŠØ©</option>
                        <option value="customer">ğŸ‘¥ Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
                        <option value="internal">âš™ï¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</option>
                        <option value="learning">ğŸ“ Ø§Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„Ù†Ù…Ùˆ</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.85rem; color: #666; margin-bottom: 5px; display: block;">Ø§Ù„Ù†Øµ</label>
                    <input type="text" id="newNodeText" placeholder="Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ù‡Ø¯Ù" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.85rem; color: #666; margin-bottom: 5px; display: block;">Ø§Ù„Ù„ÙˆÙ†</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="color" id="newNodeColor" value="#FF6B6B" style="width: 50px; height: 35px; border: none; cursor: pointer;">
                        <span id="colorPreview" style="padding: 5px 10px; border-radius: 4px; background: #FF6B6B; color: white; font-size: 0.8rem;">Ù…Ø¹Ø§ÙŠÙ†Ø©</span>
                    </div>
                </div>
                
                <button onclick="addNodeToMap()" style="width: 100%; background: #28a745; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø¯Ù</button>
            </div>
            
            <div style="background: white; padding: 15px; border-radius: 8px;">
                <h6 style="color: #333; margin-bottom: 10px;">ğŸ“‹ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</h6>
                <div id="nodesList" style="max-height: 300px; overflow-y: auto;">
    `;
    
    const allNodes = strategyMapInstance.nodes();
    allNodes.forEach(n => {
        const id = n.id();
        const label = n.data('label');
        const bgColor = n.style('background-color');
        editorHtml += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.85rem;">
                <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                    <div style="width: 15px; height: 15px; background: ${bgColor}; border-radius: 3px;"></div>
                    <span>${label}</span>
                </div>
                <div style="display: flex; gap: 5px;">
                    <input type="color" value="${bgColor}" style="width: 30px; height: 25px; border: none; cursor: pointer;" onchange="updateNodeColor('${id}', this.value)">
                    <button onclick="deleteNodeFromMap('${id}')" style="padding: 4px 8px; font-size: 0.75rem; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Ø­Ø°Ù</button>
                </div>
            </div>
        `;
    });
    
    editorHtml += `
                </div>
            </div>
        </div>
    `;
    
    Swal.fire({
        title: 'ØªØ®ØµÙŠØµ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©',
        html: editorHtml,
        width: '500px',
        confirmButtonText: 'ØªÙ…',
        didOpen: () => {
            document.querySelector('.swal2-html-container').style.textAlign = 'right';
            const colorInput = document.getElementById('newNodeColor');
            if (colorInput) {
                colorInput.addEventListener('change', (e) => {
                    const preview = document.getElementById('colorPreview');
                    if (preview) {
                        preview.style.background = e.target.value;
                    }
                });
            }
        }
    });
}

function addNodeToMap() {
    const layer = document.getElementById('newNodeLayer')?.value || 'financial';
    const text = document.getElementById('newNodeText')?.value || 'Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯';
    const color = document.getElementById('newNodeColor')?.value || colorMap[layer];
    
    if (!text.trim()) {
        Swal.fire('ØªØ­Ø°ÙŠØ±', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ù‡Ø¯Ù', 'warning');
        return;
    }
    
    nodeCounter[layer]++;
    const newId = `${layer}_custom_${nodeCounter[layer]}`;
    
    const nodes = strategyMapInstance.nodes();
    const layerNodes = nodes.filter(n => n.data('layer') === layer);
    const count = layerNodes.length;
    const x = (count - count / 2) * 200;
    const yPositions = { learning: 0, internal: 1, customer: 2, financial: 3 };
    const y = yPositions[layer] * 250;
    
    strategyMapInstance.add({
        data: { id: newId, label: text, layer: layer, description: 'Ù‡Ø¯Ù Ù…Ø®ØµØµ' },
        position: { x, y },
        style: {
            'background-color': color,
            'border-width': 3,
            'box-shadow': '0 2px 8px rgba(0,0,0,0.2)'
        }
    });
    
    document.getElementById('newNodeText').value = '';
    Swal.fire('Ù†Ø¬Ø§Ø­', 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø¯Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
    showMapEditor();
}

function deleteNodeFromMap(nodeId) {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø¯ÙØŸ')) {
        strategyMapInstance.elements().remove(`[id="${nodeId}"]`);
        Swal.fire('ØªÙ…', 'ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡Ø¯Ù', 'success');
        showMapEditor();
    }
}

function updateNodeColor(nodeId, newColor) {
    const node = strategyMapInstance.getElementById(nodeId);
    if (node) {
        node.style('background-color', newColor);
    }
}
</script>
{% endblock %}
