{% extends "admin/base.html" %}

{% block title %}{{ 'التحليلات' if lang == 'ar' else 'Analytics' }} - {{ org.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('admin.organizations.index') }}">{{ 'المؤسسات' if lang == 'ar' else 'Organizations' }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('admin.organizations.view', org_id=org.id) }}">{{ org.name }}</a></li>
            <li class="breadcrumb-item active">{{ 'التحليلات' if lang == 'ar' else 'Analytics' }}</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        {{ 'تحليلات الأداء المؤسسي' if lang == 'ar' else 'Organization Performance Analytics' }}
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Project Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h2 class="display-4 text-primary">{{ project_stats.total if project_stats else 0 }}</h2>
                                    <p class="text-muted mb-0">{{ 'إجمالي المشاريع' if lang == 'ar' else 'Total Projects' }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h2 class="display-4 text-success">{{ project_stats.completed if project_stats else 0 }}</h2>
                                    <p class="text-muted mb-0">{{ 'المشاريع المكتملة' if lang == 'ar' else 'Completed Projects' }}</p>
                                    {% if project_stats and project_stats.total > 0 %}
                                    <small class="text-muted">{{ ((project_stats.completed / project_stats.total) * 100)|round(1) }}% {{ 'معدل الإنجاز' if lang == 'ar' else 'completion rate' }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Usage Chart -->
                    {% if ai_logs %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">{{ 'استخدام الذكاء الاصطناعي (آخر 6 أشهر)' if lang == 'ar' else 'AI Usage (Last 6 Months)' }}</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="aiUsageChart" height="80"></canvas>
                        </div>
                    </div>

                    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
                    <script>
                        const ctx = document.getElementById('aiUsageChart').getContext('2d');
                        const chartData = {
                            labels: [
                                {% for log in ai_logs %}
                                '{{ log.month.strftime("%Y-%m") if log.month else "" }}'{% if not loop.last %},{% endif %}
                                {% endfor %}
                            ],
                            datasets: [{
                                label: '{{ "عدد الطلبات" if lang == "ar" else "Requests Count" }}',
                                data: [
                                    {% for log in ai_logs %}
                                    {{ log.count }}{% if not loop.last %},{% endif %}
                                    {% endfor %}
                                ],
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                tension: 0.4
                            }]
                        };

                        new Chart(ctx, {
                            type: 'line',
                            data: chartData,
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    </script>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        {{ 'لا توجد بيانات استخدام AI متاحة' if lang == 'ar' else 'No AI usage data available' }}
                    </div>
                    {% endif %}

                    <!-- Performance Indicators -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">{{ 'مؤشرات الأداء الرئيسية (KPIs)' if lang == 'ar' else 'Key Performance Indicators (KPIs)' }}</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-box me-3" style="background-color: #e3f2fd; color: #2196f3; width: 50px; height: 50px;">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">{{ 'المستخدمون النشطون' if lang == 'ar' else 'Active Users' }}</h6>
                                            <h4 class="mb-0">{{ org.users|selectattr('is_active')|list|length }}</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-box me-3" style="background-color: #f3e5f5; color: #9c27b0; width: 50px; height: 50px;">
                                            <i class="fas fa-brain"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">{{ 'استخدام AI' if lang == 'ar' else 'AI Usage' }}</h6>
                                            <h4 class="mb-0">{{ org.get_ai_usage_percentage() }}%</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-box me-3" style="background-color: #e8f5e9; color: #4caf50; width: 50px; height: 50px;">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">{{ 'معدل النجاح' if lang == 'ar' else 'Success Rate' }}</h6>
                                            <h4 class="mb-0">
                                                {% if project_stats and project_stats.total > 0 %}
                                                {{ ((project_stats.completed / project_stats.total) * 100)|round(1) }}%
                                                {% else %}
                                                0%
                                                {% endif %}
                                            </h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="{{ url_for('admin.organizations.view', org_id=org.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>{{ 'العودة' if lang == 'ar' else 'Back' }}
        </a>
    </div>
</div>

<style>
.icon-box {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
}
</style>
{% endblock %}
