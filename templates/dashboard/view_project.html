{% extends "base.html" %}

{% block title %}{{ project.title }} - Mcidia{% endblock %}

{% block content %}
<!-- Header -->
<section class="bg-gradient-primary text-white py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="fw-bold mb-2">
                    <i class="fas fa-folder me-2"></i>
                    {{ project.title }}
                </h1>
                <p class="mb-0 text-white-50">
                    {% if project_services.service %}
                        {{ project_services.service.title_ar if lang == 'ar' else project_services.service.title_en }} / 
                        {{ project_services.offering.title_ar if lang == 'ar' else project_services.offering.title_en }}
                    {% else %}
                        {{ project.module }}
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <a href="{{ url_for('dashboard.all_projects') }}" class="btn btn-light me-2">
                    <i class="fas fa-arrow-{{ 'right' if lang == 'ar' else 'left' }} me-2"></i>
                    {{ 'العودة' if lang == 'ar' else 'Back' }}
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<div class="container my-5">
    <div class="row">
        <!-- Project Details -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">{{ 'تفاصيل المشروع' if lang == 'ar' else 'Project Details' }}</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="fw-bold text-muted small">{{ 'حالة المشروع' if lang == 'ar' else 'Status' }}</label>
                            <p>
                                {% if project.status == 'draft' %}
                                    <span class="badge bg-warning text-dark"><i class="fas fa-pencil me-1"></i>{{ 'مسودة' if lang == 'ar' else 'Draft' }}</span>
                                {% elif project.status == 'completed' %}
                                    <span class="badge bg-success"><i class="fas fa-check me-1"></i>{{ 'مكتمل' if lang == 'ar' else 'Completed' }}</span>
                                {% elif project.status == 'archived' %}
                                    <span class="badge bg-secondary"><i class="fas fa-archive me-1"></i>{{ 'مؤرشف' if lang == 'ar' else 'Archived' }}</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <label class="fw-bold text-muted small">{{ 'تاريخ الإنشاء' if lang == 'ar' else 'Created' }}</label>
                            <p>{{ project.created_at.strftime('%d-%m-%Y %H:%M') if project.created_at else 'N/A' }}</p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="fw-bold text-muted small">{{ 'آخر تحديث' if lang == 'ar' else 'Updated' }}</label>
                            <p>{{ project.updated_at.strftime('%d-%m-%Y %H:%M') if project.updated_at else 'N/A' }}</p>
                        </div>
                        <div class="col-md-6">
                            <label class="fw-bold text-muted small">{{ 'الوحدة' if lang == 'ar' else 'Module' }}</label>
                            <p>{{ project.module }}</p>
                        </div>
                    </div>
                    <hr class="my-4">
                    <label class="fw-bold text-muted small mb-4 d-block">{{ 'المحتوى' if lang == 'ar' else 'Content' }}</label>
                    <div id="ai-output-content" class="ai-output-content">
                        {% if project.content %}
                            {% set project_data = project.content|from_json %}
                            {% if project_data is mapping and project_data.get('output') %}
                                {{ project_data.get('output')|safe }}
                            {% else %}
                                {{ project.content|safe }}
                            {% endif %}
                        {% else %}
                            <p class="text-muted text-center py-5">
                                <i class="fas fa-file-alt fa-2x mb-3 d-block text-muted"></i>
                                {{ 'لا يوجد محتوى' if lang == 'ar' else 'No content' }}
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Actions -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">{{ 'الإجراءات' if lang == 'ar' else 'Actions' }}</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('dashboard.edit_project', project_id=project.id) }}" class="btn btn-primary">
                            <i class="fas fa-edit me-2"></i>{{ 'تعديل المشروع' if lang == 'ar' else 'Edit Project' }}
                        </a>
                        <button class="btn btn-outline-secondary" onclick="window.print()">
                            <i class="fas fa-print me-2"></i>{{ 'طباعة' if lang == 'ar' else 'Print' }}
                        </button>
                        <a href="{{ url_for('dashboard.export_project_pdf', project_id=project.id) }}" class="btn btn-outline-danger">
                            <i class="fas fa-file-pdf me-2"></i>{{ 'تصدير PDF' if lang == 'ar' else 'Export PDF' }}
                        </a>
                        <a href="{{ url_for('dashboard.export_project_excel', project_id=project.id) }}" class="btn btn-outline-success">
                            <i class="fas fa-file-excel me-2"></i>{{ 'تصدير Excel' if lang == 'ar' else 'Export Excel' }}
                        </a>
                        <button class="btn btn-outline-danger" onclick="deleteProject({{ project.id }})">
                            <i class="fas fa-trash me-2"></i>{{ 'حذف المشروع' if lang == 'ar' else 'Delete Project' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Service Info -->
            {% if project_services.service %}
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">{{ 'معلومات الخدمة' if lang == 'ar' else 'Service Info' }}</h5>
                </div>
                <div class="card-body">
                    <label class="fw-bold text-muted small">{{ 'الخدمة' if lang == 'ar' else 'Service' }}</label>
                    <p class="mb-3">
                        <span class="badge bg-primary">
                            <i class="{{ project_services.service.icon }} me-1"></i>
                            {{ project_services.service.title_ar if lang == 'ar' else project_services.service.title_en }}
                        </span>
                    </p>
                    
                    <label class="fw-bold text-muted small">{{ 'الوحدة الفرعية' if lang == 'ar' else 'Offering' }}</label>
                    <p>{{ project_services.offering.title_ar if lang == 'ar' else project_services.offering.title_en }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.ai-output-content {
    white-space: pre-wrap;
    word-wrap: break-word;
    line-height: 2;
    font-size: 1.05rem;
}

.ai-output-content p {
    margin-bottom: 1.2rem;
}

.ai-output-content ul,
.ai-output-content ol {
    margin-bottom: 1.5rem;
}

[dir="rtl"] .ai-output-content ul,
[dir="rtl"] .ai-output-content ol {
    padding-right: 2rem;
    padding-left: 0;
}

[dir="ltr"] .ai-output-content ul,
[dir="ltr"] .ai-output-content ol {
    padding-left: 2rem;
    padding-right: 0;
}

.ai-output-content li {
    margin-bottom: 0.8rem;
    line-height: 1.8;
}

.ai-output-content h1,
.ai-output-content h2,
.ai-output-content h3,
.ai-output-content h4 {
    color: var(--color-primary);
    font-weight: 700;
    margin-top: 2rem;
    margin-bottom: 1.2rem;
}

.ai-output-content h1 {
    font-size: 1.8rem;
    border-bottom: 2px solid var(--color-primary);
    padding-bottom: 0.5rem;
}

.ai-output-content h2 {
    font-size: 1.5rem;
}

[dir="rtl"] .ai-output-content h2 {
    border-right: 4px solid var(--color-primary);
    padding-right: 1rem;
}

[dir="ltr"] .ai-output-content h2 {
    border-left: 4px solid var(--color-primary);
    padding-left: 1rem;
}

.ai-output-content h3 {
    font-size: 1.3rem;
}

.ai-output-content h4 {
    font-size: 1.1rem;
}

.ai-output-content code {
    background-color: var(--color-bg-subtle);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

.ai-output-content pre {
    background-color: var(--color-bg-subtle);
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin-bottom: 1.5rem;
}

.ai-output-content pre code {
    background-color: transparent;
    padding: 0;
}

.ai-output-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1.5rem;
}

.ai-output-content table th,
.ai-output-content table td {
    border: 1px solid #dee2e6;
    padding: 0.75rem;
}

[dir="rtl"] .ai-output-content table th,
[dir="rtl"] .ai-output-content table td {
    text-align: right;
}

[dir="ltr"] .ai-output-content table th,
[dir="ltr"] .ai-output-content table td {
    text-align: left;
}

.ai-output-content table th {
    background-color: var(--color-bg-subtle);
    font-weight: 600;
}

.ai-output-content blockquote {
    margin-bottom: 1.5rem;
    color: #6c757d;
    font-style: italic;
}

[dir="rtl"] .ai-output-content blockquote {
    border-right: 4px solid var(--color-primary);
    padding-right: 1rem;
    padding-left: 0;
}

[dir="ltr"] .ai-output-content blockquote {
    border-left: 4px solid var(--color-primary);
    padding-left: 1rem;
    padding-right: 0;
}

.ai-output-content strong {
    font-weight: 700;
    color: var(--color-primary);
}

.ai-output-content em {
    font-style: italic;
}

.ai-output-content a {
    color: var(--color-primary);
    text-decoration: underline;
}

.ai-output-content hr {
    margin: 2rem 0;
    border: none;
    border-top: 2px solid #dee2e6;
}

.card-list {
    list-style: none;
    padding: 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.card-list li {
    background: var(--color-bg-subtle);
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.info-grid-item {
    background: var(--color-bg-subtle);
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid var(--color-primary);
}

.stat-box {
    background: var(--color-bg-subtle);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: flex;
    align-items: baseline;
    gap: 1rem;
}

.stat-box .stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
}

.stat-box .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 1px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const outputElement = document.getElementById('ai-output-content');
    if (!outputElement) return;
    
    let content = outputElement.textContent.trim();
    
    try {
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false
        });
        
        content = marked.parse(content);
        
        content = DOMPurify.sanitize(content, {
            ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'b', 'i', 'u', 
                          'ul', 'ol', 'li', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 
                          'blockquote', 'code', 'pre', 'a', 'hr', 'div', 'span'],
            ALLOWED_ATTR: ['href', 'target', 'class', 'id'],
            ALLOW_DATA_ATTR: false
        });
        
        outputElement.innerHTML = content;
    } catch(e) {
        content = content.replace(/\n/g, '<br>');
        content = DOMPurify.sanitize(content);
        outputElement.innerHTML = content;
    }
    
    processOutput();
});

function processOutput() {
    const outputElement = document.getElementById('ai-output-content');
    if (!outputElement) return;
    
    const lists = outputElement.querySelectorAll('ul');
    lists.forEach(list => {
        if (list.children.length >= 3 && !list.classList.contains('no-cards')) {
            list.classList.add('card-list');
        }
    });
    
    const tables = outputElement.querySelectorAll('table');
    tables.forEach(table => {
        if (!table.parentElement.classList.contains('table-responsive')) {
            const wrapper = document.createElement('div');
            wrapper.classList.add('table-responsive');
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
        }
    });
    
    const paragraphs = outputElement.querySelectorAll('p');
    paragraphs.forEach(p => {
        const text = p.textContent;
        const numberPattern = /^(\d+[%$]?|\$?\d+(?:,\d{3})*(?:\.\d+)?)\s*[-:–]\s*(.+)$/;
        const match = text.match(numberPattern);
        
        if (match && match[1] && match[2]) {
            const statBox = document.createElement('div');
            statBox.classList.add('stat-box');
            statBox.innerHTML = `
                <span class="stat-number">${match[1]}</span>
                <span class="stat-label">${match[2]}</span>
            `;
            p.replaceWith(statBox);
        }
    });
    
    const strongElements = outputElement.querySelectorAll('strong');
    const gridItems = [];
    
    strongElements.forEach(strong => {
        const nextSibling = strong.nextSibling;
        if (nextSibling && nextSibling.nodeType === 3) {
            const text = nextSibling.textContent.trim();
            if (text.startsWith(':') || text.startsWith('-')) {
                const value = text.substring(1).trim();
                gridItems.push({
                    label: strong.textContent,
                    value: value,
                    element: strong.parentElement
                });
            }
        }
    });
    
    if (gridItems.length >= 3) {
        const firstElement = gridItems[0].element;
        const gridContainer = document.createElement('div');
        gridContainer.classList.add('info-grid');
        
        gridItems.forEach(item => {
            const gridItem = document.createElement('div');
            gridItem.classList.add('info-grid-item');
            gridItem.innerHTML = `
                <strong>${item.label}</strong>
                <p>${item.value}</p>
            `;
            gridContainer.appendChild(gridItem);
            
            if (item.element && item.element.parentNode) {
                item.element.parentNode.removeChild(item.element);
            }
        });
        
        if (firstElement && firstElement.parentNode) {
            firstElement.parentNode.insertBefore(gridContainer, firstElement);
        } else {
            outputElement.insertBefore(gridContainer, outputElement.firstChild);
        }
    }
}

function deleteProject(projectId) {
    Swal.fire({
        title: '{{ "تأكيد الحذف" if lang == "ar" else "Confirm Delete" }}',
        text: '{{ "هل أنت متأكد من حذف هذا المشروع؟ هذا الإجراء لا يمكن التراجع عنه." if lang == "ar" else "Are you sure you want to delete this project? This action cannot be undone." }}',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '{{ "نعم، احذف المشروع" if lang == "ar" else "Yes, Delete Project" }}',
        cancelButtonText: '{{ "إلغاء" if lang == "ar" else "Cancel" }}'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/dashboard/api/project/${projectId}/delete`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: '{{ "تم الحذف بنجاح" if lang == "ar" else "Deleted Successfully" }}',
                        text: '{{ "تم حذف المشروع بنجاح" if lang == "ar" else "Project has been deleted successfully" }}',
                        icon: 'success',
                        confirmButtonColor: '#0A2756'
                    }).then(() => {
                        window.location.href = '{{ url_for("dashboard.all_projects") }}';
                    });
                } else {
                    Swal.fire({
                        title: '{{ "خطأ" if lang == "ar" else "Error" }}',
                        text: data.error || '{{ "حدث خطأ أثناء حذف المشروع" if lang == "ar" else "Error deleting project" }}',
                        icon: 'error',
                        confirmButtonColor: '#0A2756'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: '{{ "خطأ" if lang == "ar" else "Error" }}',
                    text: '{{ "حدث خطأ في الاتصال" if lang == "ar" else "Connection error" }}',
                    icon: 'error',
                    confirmButtonColor: '#0A2756'
                });
            });
        }
    });
}
</script>
{% endblock %}
